<%= turbo_frame_tag "main_content", data: { turbo_action: "advance" } do %>
<%= turbo_stream_from "orders" %>
<div class="main-content">
  <div class="orders-container" data-controller="orders-filter" data-orders-filter-url-value="<%= orders_path %>">
    <!-- Compact CRM Header -->
    <div class="orders-hero">
      <div class="orders-hero-content">
        <div class="hero-stats">
          <div class="hero-title-section">
            <h1 class="hero-title">
              <span class="title-accent">Orders</span>
            </h1>
            <p class="hero-subtitle">Manage pipeline</p>
          </div>
          
          <div class="stats-container">
            <div class="hero-stat">
              <span class="stat-value"><%= @orders.count %></span>
              <span class="stat-label">Total</span>
            </div>
            <div class="hero-stat">
              <span class="stat-value"><%= @orders.where(order_status: ['pending', 'confirmed']).count %></span>
              <span class="stat-label">Active</span>
            </div>
            <div class="hero-stat">
              <span class="stat-value"><%= @orders.where(order_status: 'shipped').count %></span>
              <span class="stat-label">Shipping</span>
            </div>
            <div class="hero-stat">
              <span class="stat-value stat-currency">$<%= @orders.sum(:total_amount).to_i.to_s.gsub(/\B(?=(\d{3})+(?!\d))/, ',') %></span>
              <span class="stat-label">Revenue</span>
            </div>
          </div>
          
          <div class="hero-actions">
            <%= link_to new_order_path, class: "btn-hero btn-hero-primary", data: { turbo_frame: "main_content" } do %>
              <i class="fas fa-plus"></i>
              New Order
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Smart Filters -->
    <div class="smart-filters">
      <%= form_with url: orders_path, method: :get, class: "filters-form", data: { 
            turbo_frame: "orders-frame",
            orders_filter_target: "form"
          } do |form| %>
        <div class="filters-grid">
          <div class="search-group">
            <i class="fas fa-search search-icon"></i>
            <%= form.text_field :search, 
                placeholder: "Search orders, customers, products...", 
                value: params[:search],
                class: "search-input",
                autocomplete: "off",
                data: { 
                  orders_filter_target: "searchInput",
                  action: "input->orders-filter#search"
                } %>
          </div>
          
          <%= form.select :status, 
              options_for_select([
                ['All Status', ''],
                ['Pending', 'pending'],
                ['Confirmed', 'confirmed'], 
                ['Processing', 'processing'],
                ['Shipped', 'shipped'],
                ['Delivered', 'delivered'],
                ['Cancelled', 'cancelled']
              ], params[:status]),
              {}, 
              { 
                class: "filter-select",
                data: { action: "change->orders-filter#change" }
              } %>
          
          <%= form.select :priority,
              options_for_select([
                ['All Priorities', ''],
                ['Low', 'low'],
                ['Standard', 'standard'],
                ['High', 'high'],
                ['Rush', 'rush'],
                ['Urgent', 'urgent']
              ], params[:priority]),
              {},
              { 
                class: "filter-select",
                data: { action: "change->orders-filter#change" }
              } %>
              
          <div class="view-toggle">
            <button type="button" 
                    class="view-btn <%= 'active' unless params[:view] == 'table' %>" 
                    data-action="click->orders-filter#setView"
                    data-orders-filter-view-param="cards">
              <i class="fas fa-th-large"></i>
            </button>
            <button type="button" 
                    class="view-btn <%= 'active' if params[:view] == 'table' %>" 
                    data-action="click->orders-filter#setView"
                    data-orders-filter-view-param="table">
              <i class="fas fa-list"></i>
            </button>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Orders Content -->
    <div data-orders-filter-target="ordersFrame">
      <%= turbo_frame_tag "orders-frame" do %>
        <div id="orders-content">
          <%= render 'orders_content', orders: @orders %>
        </div>
      <% end %>
    </div>

    <!-- Quick Action Button -->
    <div class="quick-actions">
      <%= link_to new_order_path, data: { turbo_frame: "main_content" } do %>
        <button class="quick-action-btn" title="Quick Create Order">
          <i class="fas fa-plus"></i>
        </button>
      <% end %>
    </div>
  </div>
</div>

<!-- Advanced Filters Modal -->
<div id="advanced-filters" class="advanced-filters">
  <div class="filters-modal">
    <div class="modal-header">
      <h3 class="modal-title">Advanced Filters</h3>
      <button type="button" 
              data-action="click->orders-filter#hideAdvancedFilters"
              class="close-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <%= form_with url: orders_path, method: :get, local: true, class: "advanced-filters-form", data: { turbo_frame: "orders-frame" } do |form| %>
      <div class="modal-body">
        <div class="filter-group">
          <label class="filter-label">Date Range</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <%= form.date_field :start_date, value: params[:start_date], class: "filter-input", placeholder: "Start Date" %>
            <%= form.date_field :end_date, value: params[:end_date], class: "filter-input", placeholder: "End Date" %>
          </div>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Agent</label>
          <%= form.select :agent_id,
              options_from_collection_for_select(@agents, :id, :email, params[:agent_id]),
              { prompt: "All Agents" },
              { class: "filter-select" } %>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Price Range</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <%= form.number_field :min_price, value: params[:min_price], class: "filter-input", placeholder: "Min Price", step: 0.01 %>
            <%= form.number_field :max_price, value: params[:max_price], class: "filter-input", placeholder: "Max Price", step: 0.01 %>
          </div>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Source Channel</label>
          <%= form.select :source_channel,
              options_for_select([
                ['All Channels', ''],
                ['Phone', 'phone'],
                ['Web', 'web'],
                ['Email', 'email'],
                ['Walk-in', 'walk_in']
              ], params[:source_channel]),
              {},
              { class: "filter-select" } %>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" 
                data-action="click->orders-filter#clearFilters"
                class="btn btn-secondary">Clear All</button>
        <%= form.submit "Apply Filters", class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
</div>

<% end %>