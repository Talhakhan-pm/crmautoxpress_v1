<% 
# For broadcasts, use view_type. For regular page loads, use params
show_table = if defined?(view_type)
               view_type == 'table'
             else
               defined?(params) && params[:view] == 'table'
             end
%>
<% if show_table %>
  <!-- Table View -->
  <div class="orders-table-view">
    <div class="table-wrapper">
      <table class="orders-table">
        <thead>
          <tr>
            <th>Order</th>
            <th>Customer</th>
            <th>Product</th>
            <th>Vehicle</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Amount</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if orders.any? %>
            <% orders.each do |order| %>
              <tr data-turbo-frame="main_content" data-action="click->orders-filter#navigateToOrder" data-order-url="<%= order_path(order) %>" style="cursor: pointer;">
                <td>
                  <div class="order-number">
                    <span class="order-id"><%= order.order_number %></span>
                  </div>
                </td>
                <td>
                  <div class="customer-info">
                    <div class="customer-name"><%= order.customer_name %></div>
                    <div class="customer-contact">
                      <i class="fas fa-phone"></i>
                      <%= order.customer_phone %>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="product-name"><%= order.product_name %></div>
                </td>
                <td>
                  <div class="vehicle-info">
                    <% if order.vehicle_info.present? %>
                      <i class="fas fa-car"></i>
                      <%= order.vehicle_info %>
                    <% else %>
                      <span class="text-muted">N/A</span>
                    <% end %>
                  </div>
                </td>
                <td>
                  <% if order.has_pending_refund_resolution? %>
                    <% refund = order.refund %>
                    <% case refund&.resolution_stage %>
                    <% when 'pending_customer_clarification' %>
                      <span class="status-badge status-pending_resolution stage-agent">
                        <span class="status-icon"></span>
                        Agent Review
                      </span>
                    <% when 'pending_dispatch_decision' %>
                      <span class="status-badge status-pending_resolution stage-dispatcher">
                        <span class="status-icon"></span>
                        Dispatcher Review
                      </span>
                    <% when 'pending_customer_approval' %>
                      <span class="status-badge status-pending_resolution stage-customer">
                        <span class="status-icon"></span>
                        Customer Response
                      </span>
                    <% else %>
                      <span class="status-badge status-pending_resolution">
                        <span class="status-icon"></span>
                        Pending Resolution
                      </span>
                    <% end %>
                  <% else %>
                    <span class="status-badge status-<%= order.order_status %>">
                      <span class="status-icon"></span>
                      <%= order.display_status %>
                    </span>
                  <% end %>
                </td>
                <td>
                  <span class="priority-badge priority-<%= order.priority %>">
                    <%= order.priority.humanize %>
                  </span>
                </td>
                <td>
                  <div class="total-amount">$<%= number_with_delimiter(order.total_amount) %></div>
                </td>
                <td>
                  <div class="order-date">
                    <i class="fas fa-calendar"></i>
                    <%= order.order_date.strftime("%m/%d/%y") %>
                  </div>
                </td>
                <td onclick="event.stopPropagation();">
                  <div class="action-menu">
                    <%= link_to order_path(order), class: "ax-btn ax-btn--ghost ax-btn--sm", data: { turbo_frame: "main_content" } do %>
                      <i class="fas fa-eye"></i>
                      View
                    <% end %>
                    <%= link_to edit_order_path(order), class: "ax-btn ax-btn--ghost ax-btn--sm", data: { turbo_frame: "main_content" } do %>
                      <i class="fas fa-edit"></i>
                      Edit
                    <% end %>
                    <% if order.dispatch.present? && order.dispatch.shipped_or_completed? && order.refund.blank? %>
                      <div class="action-dropdown table-dropdown">
                        <button class="ax-btn ax-btn--ghost ax-btn--sm dropdown-toggle" 
                                data-action="click->orders-filter#toggleReturnDropdown"
                                data-order-id="<%= order.id %>">
                          <i class="fas fa-undo"></i>
                          Return
                        </button>
                        <div class="dropdown-menu" data-orders-filter-target="returnDropdown<%= order.id %>" style="display: none;">
                          <div class="dropdown-header">Return & Refund Options</div>
                          
                          <%= button_to create_refund_refunds_path, 
                              method: :post,
                              params: { 
                                order_id: order.id,
                                refund_reason: 'wrong_product',
                                refund_amount: order.total_amount,
                                customer_name: order.customer_name,
                                original_charge_amount: order.total_amount
                              },
                              class: "dropdown-item return-option",
                              confirm: "Create return request for wrong product?",
                              form: { data: { turbo: true } } do %>
                            <i class="fas fa-exchange-alt"></i>
                            Wrong Product
                          <% end %>
                          
                          <%= button_to create_refund_refunds_path, 
                              method: :post,
                              params: { 
                                order_id: order.id,
                                refund_reason: 'defective_product',
                                refund_amount: order.total_amount,
                                customer_name: order.customer_name,
                                original_charge_amount: order.total_amount
                              },
                              class: "dropdown-item return-option",
                              confirm: "Create return request for defective product?",
                              form: { data: { turbo: true } } do %>
                            <i class="fas fa-tools"></i>
                            Defective Product
                          <% end %>
                          
                          <%= button_to create_refund_refunds_path, 
                              method: :post,
                              params: { 
                                order_id: order.id,
                                refund_reason: 'customer_changed_mind',
                                refund_amount: order.total_amount,
                                customer_name: order.customer_name,
                                original_charge_amount: order.total_amount
                              },
                              class: "dropdown-item refund-option",
                              confirm: "Create refund request for customer change of mind?",
                              form: { data: { turbo: true } } do %>
                            <i class="fas fa-heart-broken"></i>
                            Changed Mind
                          <% end %>
                          
                          <%= button_to create_refund_refunds_path, 
                              method: :post,
                              params: { 
                                order_id: order.id,
                                refund_reason: 'quality_issues',
                                refund_amount: order.total_amount,
                                customer_name: order.customer_name,
                                original_charge_amount: order.total_amount
                              },
                              class: "dropdown-item return-option",
                              confirm: "Create return request for quality issues?",
                              form: { data: { turbo: true } } do %>
                            <i class="fas fa-exclamation-triangle"></i>
                            Quality Issues
                          <% end %>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="9" class="text-center py-5">
                <div class="empty-state">
                  <i class="fas fa-shopping-cart empty-icon"></i>
                  <h3 class="empty-title">No Orders Found</h3>
                  <p class="empty-message">Start by creating your first order or adjust your search filters.</p>
                  <%= link_to "Create Order", new_order_path, class: "ax-btn ax-btn--primary", data: { turbo_frame: "main_content" } %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% else %>
  <!-- Card View (Default) -->
  <div class="orders-grid" id="orders">
    <% if orders.any? %>
      <% orders.each do |order| %>
        <%= render 'orders/order', order: order %>
      <% end %>
    <% else %>
      <div class="empty-state">
        <i class="fas fa-shopping-cart empty-icon"></i>
        <h3 class="empty-title">No Orders Found</h3>
        <p class="empty-message">
          <% if params[:search].present? || params[:status].present? || params[:priority].present? %>
            No orders match your current filters. Try adjusting your search criteria.
          <% else %>
            You haven't created any orders yet. Start by creating your first order from a customer callback or manually.
          <% end %>
        </p>
        <%= link_to "Create New Order", new_order_path, class: "ax-btn ax-btn--primary", data: { turbo_frame: "main_content" } %>
      </div>
    <% end %>
  </div>
<% end %>