<div class="resolution-content-simplified">
  <% refund = order.refund %>
  
  <!-- Resolution Status & Next Action -->
  <div class="resolution-status-card">
    <div class="status-header">
      <div class="status-icon status-<%= refund.resolution_stage %>">
        <% case refund.resolution_stage %>
        <% when 'pending_customer_clarification' %>
          <i class="fas fa-phone"></i>
        <% when 'pending_dispatch_decision' %>
          <i class="fas fa-search"></i>
        <% when 'pending_customer_approval' %>
          <i class="fas fa-clock"></i>
        <% else %>
          <i class="fas fa-exclamation-triangle"></i>
        <% end %>
      </div>
      <div class="status-content">
        <h6>
          <% case refund.resolution_stage %>
          <% when 'pending_customer_clarification' %>
            üìû Contact Customer Now
          <% when 'pending_dispatch_decision' %>
            üîç Dispatcher Review Needed
          <% when 'pending_customer_approval' %>
            ‚è≥ Awaiting Customer Response
          <% else %>
            ‚ö†Ô∏è Resolution Required
          <% end %>
        </h6>
        <p><%= refund.refund_reason.humanize %> ‚Ä¢ $<%= number_with_precision(refund.refund_amount, precision: 2) %></p>
      </div>
    </div>
    
    <!-- Clear Next Steps -->
    <div class="next-action-guide">
      <div class="action-title">What to do next:</div>
      <div class="action-description">
        <% case refund.resolution_stage %>
        <% when 'pending_customer_clarification' %>
          Call <%= order.customer_name %> at <strong><%= order.customer_phone %></strong> to verify order details and understand the issue. Once clarified, update notes and forward to dispatch team.
        <% when 'pending_dispatch_decision' %>
          Dispatch team needs to research part availability and decide: retry delivery, offer alternative part, or process refund.
        <% when 'pending_customer_approval' %>
          Customer needs to approve/decline the alternative part suggestion. Follow up if no response within 24 hours.
        <% else %>
          This order requires immediate attention. Review the refund details and begin the resolution process.
        <% end %>
      </div>
    </div>
  </div>

  <!-- Quick Actions Based on Stage -->
  <div class="quick-resolution-actions">
    <% case refund.resolution_stage %>
    <% when 'pending_customer_clarification' %>
      <div class="action-buttons">
        <button class="action-btn primary" onclick="openResolutionHub(<%= refund.id %>, '<%= refund.resolution_stage %>')">
          <i class="fas fa-comments"></i>
          Start Resolution Chat
        </button>
        <a href="tel:<%= order.customer_phone %>" class="action-btn secondary">
          <i class="fas fa-phone"></i>
          Call <%= order.customer_name.split(' ').first %>
        </a>
      </div>
    <% when 'pending_dispatch_decision' %>
      <div class="action-buttons">
        <button class="action-btn primary" onclick="openResolutionHub(<%= refund.id %>, '<%= refund.resolution_stage %>')">
          <i class="fas fa-tools"></i>
          Open Dispatch Tools
        </button>
        <%= link_to resolution_path, class: "action-btn secondary", data: { turbo_frame: "main_content" } do %>
          <i class="fas fa-list"></i>
          View All Resolutions
        <% end %>
      </div>
    <% when 'pending_customer_approval' %>
      <div class="action-buttons">
        <button class="action-btn primary" onclick="openResolutionHub(<%= refund.id %>, '<%= refund.resolution_stage %>')">
          <i class="fas fa-clock"></i>
          Check Customer Response
        </button>
        <a href="tel:<%= order.customer_phone %>" class="action-btn secondary">
          <i class="fas fa-phone"></i>
          Follow Up Call
        </a>
      </div>
    <% else %>
      <div class="action-buttons">
        <button class="action-btn primary" onclick="openResolutionHub(<%= refund.id %>, '<%= refund.resolution_stage %>')">
          <i class="fas fa-play"></i>
          Start Resolution Process
        </button>
        <%= link_to resolution_path, class: "action-btn secondary", data: { turbo_frame: "main_content" } do %>
          <i class="fas fa-external-link-alt"></i>
          Resolution Center
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Recent Activity Feed (3-4 items) -->
  <div class="activity-feed-mini">
    <div class="activity-header">
      <i class="fas fa-history"></i>
      <span>Recent Activity</span>
    </div>
    <div class="activity-items">
      <% order.unified_timeline(4).each do |activity| %>
        <div class="activity-item">
          <div class="activity-icon activity-<%= activity[:type] %>">
            <% case activity[:type] %>
            <% when 'refund' %>
              <i class="fas fa-money-bill-wave"></i>
            <% when 'dispatch' %>
              <i class="fas fa-truck"></i>
            <% else %>
              <i class="fas fa-circle"></i>
            <% end %>
          </div>
          <div class="activity-content">
            <span class="activity-action">
              <% if activity[:activity].field_changed.present? %>
                <%= activity[:action].humanize %> <%= activity[:activity].field_changed.humanize.downcase %>
                <% if activity[:activity].old_value.present? && activity[:activity].new_value.present? %>
                  <span class="field-change">
                    from "<%= truncate(activity[:activity].old_value, length: 15) %>" 
                    to "<%= truncate(activity[:activity].new_value, length: 15) %>"
                  </span>
                <% end %>
              <% elsif activity[:activity].details.present? %>
                <%= truncate(activity[:activity].details, length: 40) %>
              <% else %>
                <%= activity[:action].humanize %>
              <% end %>
            </span>
            <small class="activity-time"><%= time_ago_in_words(activity[:timestamp]) %> ago</small>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>