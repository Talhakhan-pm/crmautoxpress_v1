<!-- Smart Order Creation Modal -->
<div id="order-modal" 
     class="order-modal active" 
     data-controller="order-form"
     data-order-form-callback-id-value="<%= params[:callback_id] %>">
  
  <div class="modal-overlay" 
       data-action="click->order-form#closeModal" 
       title="Click to close"></div>
  
  <div class="order-modal-content" data-order-form-target="modal">
    <!-- Modal Header -->
    <div class="modal-header">
      <div class="header-content">
        <div class="modal-title-section">
          <h2 class="modal-title">
            <i class="fas fa-plus-circle modal-icon"></i>
            Create New Order
          </h2>
          <p class="modal-subtitle">Unified order creation with automatic callback tracking</p>
        </div>
        <button type="button" 
                data-action="click->order-form#closeModal" 
                class="close-btn">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <!-- Order Type Toggle -->
      <div class="order-type-toggle">
        <button type="button" 
                class="toggle-btn active" 
                data-type="direct" 
                data-action="click->order-form#setOrderType">
          <i class="fas fa-phone"></i>
          Direct Sale
        </button>
        <button type="button" 
                class="toggle-btn" 
                data-type="conversion" 
                data-action="click->order-form#setOrderType">
          <i class="fas fa-exchange-alt"></i>
          Convert Callback
        </button>
      </div>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <%= form_with model: @order, 
                    local: false, 
                    class: "order-form", 
                    data: { 
                      order_form_target: "form",
                      action: "submit->order-form#submitForm turbo:submit-end->order-form#handleSubmitEnd turbo:fetch-request-error->order-form#handleFetchError"
                    } do |form| %>
        
        <!-- Callback Selection Section -->
        <%= render 'callback_selection', form: form %>

        <!-- Customer Information Section -->
        <%= render 'customer_information', form: form %>

        <!-- Vehicle Information Section -->
        <%= render 'vehicle_information', form: form %>

        <!-- Product & Pricing Section -->
        <%= render 'product_pricing', form: form %>

        <!-- Order Details Section -->
        <%= render 'order_details', form: form %>
        
        <!-- Hidden Fields -->
        <%= form.hidden_field :agent_id, value: current_user.id %>
        <%= form.hidden_field :order_status, value: 'pending' %>
        <%= form.hidden_field :order_date, value: Time.current %>
        <%= form.hidden_field :agent_callback_id, data: { order_form_target: "selectedCallbackId" } %>
        
        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" 
                  data-action="click->order-form#closeModal" 
                  class="btn btn-secondary">
            <i class="fas fa-times"></i>
            Cancel
          </button>
          
          <div class="primary-actions">
            <button type="submit" name="action" value="save_draft" class="btn btn-outline">
              <i class="fas fa-save"></i>
              Save Draft
            </button>
            
            <button type="submit" name="action" value="create_order" class="btn btn-primary">
              <i class="fas fa-check"></i>
              Create Order
            </button>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Customer Lookup Modal -->
<div id="customer-lookup" class="lookup-modal">
  <div class="lookup-content">
    <div class="lookup-header">
      <h3>Select Existing Customer</h3>
      <button data-action="click->order-form#closeLookupModal" 
              data-type="customer" 
              class="close-btn">×</button>
    </div>
    <div class="lookup-body">
      <input type="text" 
             id="customer-search" 
             placeholder="Search by name or phone..." 
             class="search-input">
      <div id="customers-list" class="lookup-results">
        <!-- Populated via AJAX -->
      </div>
    </div>
  </div>
</div>

<!-- Product Lookup Modal -->
<div id="product-lookup" class="lookup-modal">
  <div class="lookup-content">
    <div class="lookup-header">
      <h3>Select Product</h3>
      <button data-action="click->order-form#closeLookupModal" 
              data-type="product" 
              class="close-btn">×</button>
    </div>
    <div class="lookup-body">
      <input type="text" 
             id="product-search" 
             placeholder="Search products..." 
             class="search-input">
      <div id="products-list" class="lookup-results">
        <!-- Populated via AJAX -->
      </div>
    </div>
  </div>
</div>