<% dispatches.each do |dispatch| %>
  <div class="flow-card <%= status %>" onclick="showDispatchDetails(<%= dispatch.id %>)" data-dispatch-id="<%= dispatch.id %>">
    <div class="flow-card-header">
      <span class="order-ref">#<%= dispatch.order_number %></span>
      <% if status == 'pending' %>
        <span class="priority-dot priority-<%= dispatch.order&.priority || 'standard' %>"></span>
      <% elsif status == 'processing' %>
        <div class="status-indicators">
          <span class="indicator payment-<%= dispatch.payment_status %>">💳</span>
          <span class="indicator supplier-<%= dispatch.supplier_name.present? ? 'assigned' : 'pending' %>">🏭</span>
        </div>
      <% elsif status == 'shipped' %>
        <% if dispatch.has_tracking? %>
          <span class="tracking-badge">📍</span>
        <% end %>
      <% elsif status == 'completed' %>
        <span class="completed-badge">✅</span>
      <% end %>
    </div>
    <div class="flow-card-body">
      <div class="customer"><%= dispatch.customer_name %></div>
      <div class="product"><%= dispatch.product_name %></div>
      <% if status == 'processing' && dispatch.supplier_name.present? %>
        <div class="supplier">📦 <%= dispatch.supplier_name %></div>
      <% elsif status == 'shipped' && dispatch.tracking_number.present? %>
        <div class="tracking">🚚 <%= dispatch.tracking_number %></div>
      <% elsif status == 'completed' %>
        <div class="delivery-date">📅 <%= dispatch.updated_at.strftime("%m/%d") %></div>
      <% end %>
      <div class="amount">$<%= number_with_delimiter(dispatch.total_cost) %></div>
    </div>
    <% if status != 'completed' %>
      <div class="flow-card-actions">
        <% if status == 'pending' %>
          <%= link_to "Start Processing", edit_dispatch_path(dispatch), 
              class: "flow-action-btn start", 
              data: { turbo_frame: "main_content" },
              onclick: "event.stopPropagation();" %>
        <% elsif status == 'processing' %>
          <% if dispatch.can_be_shipped? %>
            <%= link_to "Ready to Ship", edit_dispatch_path(dispatch), 
                class: "flow-action-btn ship", 
                data: { turbo_frame: "main_content" },
                onclick: "event.stopPropagation();" %>
          <% else %>
            <%= link_to "Update", edit_dispatch_path(dispatch), 
                class: "flow-action-btn update", 
                data: { turbo_frame: "main_content" },
                onclick: "event.stopPropagation();" %>
          <% end %>
        <% elsif status == 'shipped' %>
          <% if dispatch.has_tracking? %>
            <%= link_to "Track", dispatch.tracking_link.present? ? dispatch.tracking_link : "#", 
                class: "flow-action-btn track", 
                target: "_blank",
                onclick: "event.stopPropagation();" %>
          <% end %>
          <%= link_to "Mark Delivered", edit_dispatch_path(dispatch), 
              class: "flow-action-btn deliver", 
              data: { turbo_frame: "main_content" },
              onclick: "event.stopPropagation();" %>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>