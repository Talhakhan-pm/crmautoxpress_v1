<%= turbo_frame_tag "main_content" do %>
        <!-- Modern Timeline Dispatch Management Modal -->
        <div id="dispatch-modal" 
             class="unified-modal theme-red active" 
             data-controller="modal" data-modal-theme-value="red">
          
          <div class="unified-modal-content">
            <!-- Modern Timeline Header -->
            <div class="unified-modal-header theme-red">
              <div class="unified-modal-header-content">
                <h2 class="unified-modal-title">
                  <div class="modal-icon">
                    <i class="fas fa-shipping-fast"></i>
                  </div>
                  Manage Order #<%= @dispatch.order_number %>
                </h2>
                <p class="unified-modal-subtitle">Update supplier costs, tracking, and fulfillment status</p>
                
                <div class="unified-timeline">
                  <div class="unified-timeline-line"></div>
                  <div class="unified-timeline-progress" style="width: <%= calculate_progress_percentage(@dispatch) %>%;"></div>
                  
                  <div class="unified-timeline-item <%= timeline_status_class(@dispatch, 'pending') %>">
                    <div class="unified-timeline-marker">
                      <i class="fas fa-clock"></i>
                    </div>
                    <div class="unified-timeline-label">Pending</div>
                    <div class="unified-timeline-date">
                      <%= @dispatch.created_at.strftime('%b %d') if @dispatch.created_at %>
                    </div>
                  </div>
                  
                  <div class="unified-timeline-item <%= timeline_status_class(@dispatch, 'processing') %>">
                    <div class="unified-timeline-marker">
                      <i class="fas <%= @dispatch.dispatch_status == 'processing' ? 'fa-cog fa-spin' : 'fa-cog' %>"></i>
                    </div>
                    <div class="unified-timeline-label">Processing</div>
                    <div class="unified-timeline-date">
                      <%= processing_date(@dispatch) %>
                    </div>
                  </div>
                  
                  <div class="unified-timeline-item <%= timeline_status_class(@dispatch, 'shipped') %>">
                    <div class="unified-timeline-marker">
                      <i class="fas fa-truck"></i>
                    </div>
                    <div class="unified-timeline-label">Shipped</div>
                    <div class="unified-timeline-date">
                      <%= shipped_date(@dispatch) %>
                    </div>
                  </div>
                  
                  <div class="unified-timeline-item <%= timeline_status_class(@dispatch, 'completed') %>">
                    <div class="unified-timeline-marker">
                      <i class="fas fa-home"></i>
                    </div>
                    <div class="unified-timeline-label">Delivered</div>
                    <div class="unified-timeline-date">
                      <%= completed_date(@dispatch) %>
                    </div>
                  </div>
                </div>
              </div>
              
              <%= link_to dispatches_path, class: "unified-modal-close", data: { turbo_frame: "main_content" } do %>
                <i class="fas fa-times"></i>
              <% end %>
            </div>

            <!-- Modal Body -->
            <div class="unified-modal-body" 
                 data-controller="dispatch-form dispatch-cancellation"
                 data-dispatch-cancellation-original-amount-value="<%= @dispatch.total_cost || 0 %>"
                 data-dispatch-cancellation-dispatch-id-value="<%= @dispatch.id %>">
              <%= form_with model: @dispatch, local: false, data: { turbo_frame: "main_content", dispatch_form_target: "form" } do |f| %>
                <!-- Order Information Section -->
                <div class="unified-form-section">
                  <div class="unified-section-header">
                    <h3 class="section-title">
                      <i class="fas fa-info-circle"></i>
                      Order Information
                    </h3>
                    <% if @dispatch.order %>
                      <%= link_to "View Full Order", order_path(@dispatch.order), class: "section-action", target: "_blank" %>
                    <% end %>
                  </div>
                  
                  <div class="info-grid">
                    <div class="info-item">
                      <div class="info-label">Delivery Address</div>
                      <div class="info-value" style="text-align: left;"><%= @dispatch.customer_address %></div>
                    </div>
                    <div class="info-item">
                      <div class="info-label">Customer</div>
                      <div class="info-value" style="text-align: left;"><%= @dispatch.customer_name %></div>
                    </div>
                    <div class="info-item">
                      <div class="info-label">Product</div>
                      <div class="info-value" style="text-align: left;"><%= @dispatch.product_name %></div>
                    </div>
                    <div class="info-item">
                      <div class="info-label">Vehicle</div>
                      <div class="info-value" style="text-align: left;"><%= @dispatch.car_details %></div>
                    </div>
                  </div>
                </div>

                <!-- Status Management Section -->
                <div class="unified-form-section">
                  <div class="unified-section-header">
                    <h3 class="section-title">
                      <i class="fas fa-clipboard-check"></i>
                      Status Management
                    </h3>
                    <div class="status-indicator">
                      <span class="current-status-badge status-<%= @dispatch.dispatch_status %>">
                        <%= @dispatch.dispatch_status.humanize %>
                      </span>
                    </div>
                  </div>
                  
                  <div class="unified-form-grid">
                    <!-- Dispatch Status -->
                    <div class="unified-form-group">
                      <%= f.label :dispatch_status, "Dispatch Status", class: "form-label required" %>
                      <% has_pending_resolution = @dispatch.order.refund.present? && @dispatch.order.refund.refund_stage == 'pending_resolution' %>
                      <% if has_pending_resolution %>
                        <div class="alert alert-warning mt-2 mb-3">
                          <i class="fas fa-exclamation-triangle me-2"></i>
                          <strong>Status Locked:</strong> This dispatch cannot be modified until the refund resolution is completed.
                          <a href="<%= refunds_path %>" class="alert-link">Go to Refunds</a> to resolve.
                        </div>
                        <%= f.select :dispatch_status, 
                            options_for_select([
                              ['❌ Cancelled (Resolution Required)', 'cancelled']
                            ], @dispatch.dispatch_status), 
                            {}, 
                            { 
                              class: "form-select status-select status-#{@dispatch.dispatch_status}",
                              disabled: true,
                              data: { 
                                dispatch_form_target: "dispatchStatus",
                                dispatch_cancellation_target: "statusSelect"
                              }
                            } %>
                      <% else %>
                        <%= f.select :dispatch_status, 
                            options_for_select([
                              ['⏳ Pending Processing', 'pending'],
                              ['📋 Assigned to Agent', 'assigned'],
                              ['⚙️ Processing Order', 'processing'],
                              ['🚚 Shipped to Customer', 'shipped'],
                              ['✅ Completed & Delivered', 'completed'],
                              ['❌ Cancelled', 'cancelled']
                            ], @dispatch.dispatch_status), 
                            { prompt: 'Select dispatch status' }, 
                            { 
                              class: "form-select status-select status-#{@dispatch.dispatch_status}",
                              data: { 
                                dispatch_form_target: "dispatchStatus",
                                dispatch_cancellation_target: "statusSelect",
                                action: "change->dispatch-form#updateStatusFields change->dispatch-cancellation#statusChanged"
                              }
                            } %>
                      <% end %>
                    </div>
                  </div>

                  <!-- Tracking Information (Conditional) -->
                  <div class="tracking-section" 
                       data-dispatch-form-target="trackingSection"
                       style="<%= @dispatch.dispatch_status.in?(['shipped', 'completed']) ? 'display: block;' : 'display: none;' %>">
                    <div class="section-divider">
                      <div class="divider-line"></div>
                      <span class="divider-text">
                        <i class="fas fa-map-marker-alt"></i>
                        Tracking Information
                      </span>
                      <div class="divider-line"></div>
                    </div>
                    
                    <div class="unified-form-grid">
                      <div class="unified-form-group">
                        <%= f.label :tracking_number, "Tracking Number", class: "form-label" %>
                        <%= f.text_field :tracking_number, 
                            class: "form-input tracking-input", 
                            placeholder: "Enter tracking number",
                            data: { dispatch_form_target: "trackingNumber" } %>
                      </div>
                      <div class="unified-form-group">
                        <%= f.label :tracking_link, "Tracking URL", class: "form-label" %>
                        <%= f.url_field :tracking_link, 
                            class: "form-input", 
                            placeholder: "https://tracking.example.com/...",
                            data: { dispatch_form_target: "trackingLink" } %>
                      </div>
                    </div>
                  </div>

                </div>

                <!-- Supplier Management Section -->
                <div class="unified-form-section">
                  <div class="unified-section-header">
                    <h3 class="section-title">
                      <i class="fas fa-truck"></i>
                      Supplier Management
                    </h3>
                    <div class="section-actions">
                      <%= link_to suppliers_path, class: "section-action btn-link", 
                          data: { turbo_frame: "main_content" }, title: "View All Suppliers" do %>
                        <i class="fas fa-external-link-alt"></i> View Suppliers
                      <% end %>
                    </div>
                  </div>
                  
                  <% if @dispatch.order.supplier.present? %>
                    <!-- Current Supplier Display -->
                    <div class="current-supplier-info">
                      <div class="supplier-card">
                        <div class="supplier-header">
                          <div class="supplier-name">
                            <i class="fas fa-building"></i>
                            <strong><%= @dispatch.order.supplier.name %></strong>
                          </div>
                          <%= link_to supplier_path(@dispatch.order.supplier), 
                              class: "view-supplier-link", 
                              data: { turbo_frame: "main_content" } do %>
                            <i class="fas fa-eye"></i> View Details
                          <% end %>
                        </div>
                        <% if @dispatch.order.supplier.supplier_notes.present? %>
                          <div class="supplier-notes">
                            <small class="text-muted"><%= truncate(@dispatch.order.supplier.supplier_notes, length: 80) %></small>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                  
                  <%= fields_for @dispatch.order, namespace: :order do |order_form| %>
                    <div class="unified-form-grid">
                      <div class="unified-form-group">
                        <%= order_form.label :supplier_name, "Supplier Name", class: "form-label required" %>
                        <%= order_form.text_field :supplier_name, 
                            class: "form-input supplier-autocomplete", 
                            placeholder: "Type supplier name...",
                            value: @dispatch.order.supplier&.name,
                            autocomplete: "off",
                            data: { 
                              dispatch_form_target: "supplierAutocomplete",
                              action: "input->dispatch-form#supplierAutocomplete focus->dispatch-form#showSuggestions blur->dispatch-form#hideSuggestions",
                              suppliers: Supplier.order(:name).pluck(:name, :id).to_json
                            } %>
                        <%= order_form.hidden_field :supplier_id, 
                            value: @dispatch.order.supplier_id,
                            data: { dispatch_form_target: "supplierIdField" } %>
                        
                        <!-- Autocomplete dropdown -->
                        <div class="autocomplete-dropdown" data-dispatch-form-target="autocompleteDropdown" style="display: none;">
                          <div class="autocomplete-results" data-dispatch-form-target="autocompleteResults">
                            <!-- Results populated by JavaScript -->
                          </div>
                          <div class="autocomplete-create" data-dispatch-form-target="autocompleteCreate" style="display: none;">
                            <div class="create-supplier-option" data-action="click->dispatch-form#createNewSupplier">
                              <i class="fas fa-plus-circle"></i>
                              <span>Create new supplier: "<span data-dispatch-form-target="newSupplierName"></span>"</span>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="unified-form-group">
                        <%= order_form.label :supplier_order_number, "Supplier Order #", class: "form-label" %>
                        <%= order_form.text_field :supplier_order_number, 
                            class: "form-input", 
                            placeholder: "Supplier's order number",
                            value: @dispatch.order.supplier_order_number,
                            data: { dispatch_form_target: "supplierOrderNumber" } %>
                      </div>
                      
                      <div class="unified-form-group">
                        <%= order_form.label :supplier_cost, "Supplier Cost", class: "form-label required" %>
                        <%= order_form.number_field :supplier_cost, 
                            step: 0.01, 
                            class: "form-input", 
                            value: @dispatch.order.supplier_cost,
                            data: { 
                              dispatch_form_target: "supplierCost", 
                              action: "input->dispatch-form#supplierCostChanged keyup->dispatch-form#supplierCostChanged" 
                            } %>
                      </div>
                      
                      <div class="unified-form-group">
                        <%= f.label :condition, class: "form-label" %>
                        <%= f.select :condition, options_for_select([
                          ['New', 'new'],
                          ['Used', 'used'],
                          ['Refurbished', 'refurbished']
                        ], @dispatch.condition), { prompt: 'Select condition' }, { class: "form-select" } %>
                      </div>
                      
                      <div class="unified-form-group">
                        <%= order_form.label :supplier_shipping_cost, "Supplier Shipping", class: "form-label" %>
                        <%= order_form.number_field :supplier_shipping_cost, 
                            step: 0.01, 
                            class: "form-input", 
                            placeholder: "0.00",
                            value: @dispatch.order.supplier_shipping_cost,
                            data: { 
                              dispatch_form_target: "supplierShipping", 
                              action: "input->dispatch-form#supplierCostChanged keyup->dispatch-form#supplierCostChanged" 
                            } %>
                      </div>
                      
                      <div class="unified-form-group">
                        <%= order_form.label :supplier_tax, "Supplier Tax", class: "form-label" %>
                        <%= order_form.number_field :supplier_tax, 
                            step: 0.01, 
                            class: "form-input", 
                            placeholder: "0.00",
                            value: @dispatch.order.supplier_tax,
                            data: { 
                              dispatch_form_target: "supplierTax", 
                              action: "input->dispatch-form#supplierCostChanged keyup->dispatch-form#supplierCostChanged" 
                            } %>
                      </div>
                    </div>
                  <% end %>
                </div>

                <!-- Return Management Section -->
                <% if @dispatch.order.refund.present? && !@dispatch.order.refund.no_return_required? %>
                  <div class="unified-form-section">
                    <div class="unified-section-header">
                      <h3 class="section-title">
                        <i class="fas fa-undo"></i>
                        Return Management
                      </h3>
                      <div class="section-actions">
                        <span class="return-status-badge status-<%= @dispatch.order.refund.return_status %>">
                          <%= @dispatch.order.refund.return_status.humanize.gsub('_', ' ') %>
                        </span>
                        <%= link_to resolution_path, class: "section-action btn-link", 
                            data: { turbo_frame: "main_content" }, title: "Resolution Center" do %>
                          <i class="fas fa-external-link-alt"></i> Resolution Center
                        <% end %>
                      </div>
                    </div>
                    
                    <!-- Return Timeline -->
                    <div class="return-timeline-wrapper">
                      <div class="return-timeline">
                        <div class="timeline-track">
                          <% @dispatch.order.refund.return_timeline_events.each_with_index do |event, index| %>
                            <div class="timeline-item <%= 'completed' if event[:date].present? %>">
                              <div class="timeline-marker">
                                <% if event[:status] == 'return_requested' %>
                                  <i class="fas fa-clipboard-list"></i>
                                <% elsif event[:status] == 'return_authorized' %>
                                  <i class="fas fa-check-circle"></i>
                                <% elsif event[:status] == 'return_label_sent' %>
                                  <i class="fas fa-shipping-fast"></i>
                                <% elsif event[:status] == 'return_shipped' %>
                                  <i class="fas fa-box"></i>
                                <% elsif event[:status] == 'return_received' %>
                                  <i class="fas fa-inbox"></i>
                                <% else %>
                                  <i class="fas fa-circle"></i>
                                <% end %>
                              </div>
                              <div class="timeline-content">
                                <div class="timeline-title"><%= event[:description] %></div>
                                <div class="timeline-date">
                                  <%= event[:date].present? ? event[:date].strftime('%m/%d/%Y %I:%M %p') : 'Pending' %>
                                </div>
                              </div>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Return Details Grid -->
                    <div class="info-grid">
                      <% if @dispatch.order.refund.return_tracking_number.present? %>
                        <div class="info-item">
                          <div class="info-label">Return Tracking</div>
                          <div class="info-value" style="text-align: left;">
                            <span class="tracking-number"><%= @dispatch.order.refund.return_tracking_number %></span>
                          </div>
                        </div>
                      <% end %>
                      <% if @dispatch.order.refund.return_carrier.present? %>
                        <div class="info-item">
                          <div class="info-label">Return Carrier</div>
                          <div class="info-value" style="text-align: left;"><%= @dispatch.order.refund.return_carrier %></div>
                        </div>
                      <% end %>
                      <% if @dispatch.order.refund.return_deadline.present? %>
                        <div class="info-item">
                          <div class="info-label">Return Deadline</div>
                          <div class="info-value" style="text-align: left;">
                            <%= @dispatch.order.refund.return_deadline.strftime('%m/%d/%Y') %>
                            <% days_left = (@dispatch.order.refund.return_deadline.to_date - Date.current).to_i %>
                            <% if days_left > 0 %>
                              <small class="text-success">(<%= days_left %> days left)</small>
                            <% elsif days_left == 0 %>
                              <small class="text-warning">(Due today)</small>
                            <% else %>
                              <small class="text-danger">(<%= days_left.abs %> days overdue)</small>
                            <% end %>
                          </div>
                        </div>
                      <% end %>
                      <div class="info-item">
                        <div class="info-label">Return Reason</div>
                        <div class="info-value" style="text-align: left;"><%= @dispatch.order.refund.refund_reason.humanize %></div>
                      </div>
                      <% if @dispatch.order.refund.return_notes.present? %>
                        <div class="info-item full-width">
                          <div class="info-label">Return Notes</div>
                          <div class="info-value" style="text-align: left;"><%= @dispatch.order.refund.return_notes %></div>
                        </div>
                      <% end %>
                    </div>
                    
                    <!-- Return Quick Actions -->
                    <div class="return-actions-grid">
                      <% if @dispatch.order.refund.can_generate_return_label? %>
                        <%= link_to resolution_generate_return_label_path(@dispatch.order.refund), 
                            method: :patch,
                            class: "ax-btn ax-btn--primary",
                            data: { 
                              turbo_method: :patch,
                              confirm: "Generate return label for customer?" 
                            } do %>
                          <i class="fas fa-tag"></i>
                          Generate Return Label
                        <% end %>
                      <% end %>
                      
                      <% if @dispatch.order.refund.return_label_sent? %>
                        <%= link_to resolution_mark_return_shipped_path(@dispatch.order.refund), 
                            method: :patch,
                            class: "ax-btn ax-btn--secondary",
                            data: { 
                              turbo_method: :patch,
                              confirm: "Mark return as shipped by customer?" 
                            } do %>
                          <i class="fas fa-box"></i>
                          Mark Return Shipped
                        <% end %>
                      <% end %>
                      
                      <% if @dispatch.order.refund.return_shipped? || @dispatch.order.refund.return_in_transit? || @dispatch.order.refund.return_delivered? %>
                        <%= link_to resolution_mark_return_received_path(@dispatch.order.refund), 
                            method: :patch,
                            class: "ax-btn ax-btn--success",
                            data: { 
                              turbo_method: :patch,
                              confirm: "Mark return as received and inspected?" 
                            } do %>
                          <i class="fas fa-inbox"></i>
                          Mark Return Received
                        <% end %>
                      <% end %>
                      
                      <% if @dispatch.order.refund.return_label_url.present? %>
                        <%= link_to @dispatch.order.refund.return_label_url, 
                            target: "_blank",
                            class: "ax-btn ax-btn--info" do %>
                          <i class="fas fa-download"></i>
                          Download Return Label
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                <% end %>

                <!-- Financial Overview Section -->
                <div class="unified-form-section">
                  <div class="unified-section-header">
                    <h3 class="section-title">
                      <i class="fas fa-dollar-sign"></i>
                      Financial Overview
                    </h3>
                  </div>
                  
                  <div class="info-grid">
                    <div class="info-item">
                      <div class="info-label">Customer Total</div>
                      <div class="info-value cost-highlight" style="text-align: left;" data-dispatch-form-target="customerTotal"><%= number_to_currency(@dispatch.total_cost || 0) %></div>
                    </div>
                    <div class="info-item">
                      <div class="info-label">Customer Tax & Shipping</div>
                      <div class="info-value" style="text-align: left;"><%= number_to_currency((@dispatch.tax_amount || 0) + (@dispatch.shipping_cost || 0)) %></div>
                    </div>
                    <div class="info-item">
                      <div class="info-label">Supplier Product Cost</div>
                      <div class="info-value" style="text-align: left;" data-dispatch-form-target="supplierCostDisplay">
                        <%= number_to_currency(@dispatch.order.supplier_cost || 0) %>
                      </div>
                    </div>
                    <div class="info-item">
                      <div class="info-label">Supplier Total</div>
                      <div class="info-value" style="text-align: left;" data-dispatch-form-target="supplierTotalDisplay">
                        <% supplier_total = (@dispatch.order.supplier_cost || 0) + (@dispatch.order.supplier_shipping_cost || 0) + (@dispatch.order.supplier_tax || 0) %>
                        <%= number_to_currency(supplier_total) %>
                      </div>
                    </div>
                    <div class="info-item profit-item">
                      <div class="info-label">Profit</div>
                      <div class="info-value profit-positive" style="text-align: left;" data-dispatch-form-target="profitDisplay">
                        <% profit = (@dispatch.total_cost || 0) - supplier_total %>
                        <%= number_to_currency(profit) %>
                      </div>
                    </div>
                    <div class="info-item">
                      <div class="info-label">Agent Commission (3%)</div>
                      <div class="info-value profit-positive" style="text-align: left;" data-dispatch-form-target="commissionDisplay">
                        <% commission = profit * 0.03 %>
                        <%= number_to_currency(commission) %>
                      </div>
                    </div>
                    <div class="info-item">
                      <div class="info-label">Margin</div>
                      <div class="info-value profit-positive" style="text-align: left;" data-dispatch-form-target="profitMargin">
                        <% margin = (@dispatch.total_cost || 0) > 0 ? ((profit / @dispatch.total_cost) * 100) : 0 %>
                        <%= margin.round(2) %>%
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Communication & Notes Section -->
                <div class="unified-form-section">
                  <div class="unified-section-header">
                    <h3 class="section-title">
                      <i class="fas fa-sticky-note"></i>
                      Internal Notes
                    </h3>
                  </div>
                  
                  <div class="unified-form-grid">
                    <div class="unified-form-group full-width">
                      <%= f.label :internal_notes, "Internal Team Notes", class: "form-label" %>
                      <%= f.text_area :internal_notes, 
                          rows: 4, 
                          class: "form-input", 
                          placeholder: "Internal notes, supplier communications, special instructions, dispatch status updates..." %>
                      <small class="form-help">Private notes visible only to your team. Use this for supplier communications, quality checks, shipping updates, and internal coordination.</small>
                    </div>
                  </div>
                </div>

                
                <!-- Form Actions -->
                <div class="unified-form-actions">
                  <div class="primary-actions">
                    <%= link_to dispatches_path, class: "btn btn-secondary", data: { turbo_frame: "main_content" } do %>
                      <i class="fas fa-times"></i>
                      Cancel
                    <% end %>
                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-save"></i>
                      Update Dispatch
                    </button>
                  </div>
                </div>
              <% end %>
              
              <!-- Modern Cancellation Modal -->
              <div class="modern-modal-overlay" id="cancellation-modal" 
                   data-dispatch-cancellation-target="cancellationModal"
                   style="display: none;">
                <div class="modern-modal-container">
                  <div class="modern-modal-card">
                    <!-- Header -->
                    <div class="modern-modal-header">
                      <div class="modern-modal-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                      </div>
                      <h3 class="modern-modal-title">Cancel Dispatch</h3>
                      <p class="modern-modal-subtitle">Please provide cancellation details</p>
                    </div>

                    <!-- Body -->
                    <div class="modern-modal-body">
                      <div class="modern-alert">
                        <i class="fas fa-info-circle"></i>
                        <span>This will create a refund record for the customer</span>
                      </div>
                      
                      <form id="cancellation-form" class="modern-form">
                        <!-- Reason Selection -->
                        <div class="modern-form-group">
                          <label class="modern-form-label">Agent Action Required</label>
                          <div class="modern-select-wrapper">
                            <select class="modern-select" data-dispatch-cancellation-target="reasonSelect"
                                    data-action="change->dispatch-cancellation#reasonChanged">
                              <option value="">Select agent action needed...</option>
                              <option value="shipping_delay">📞 Agent: Contact Customer - Accept 5-7 day delay?</option>
                              <option value="item_not_found">📞 Agent: Contact Customer - Accept price increase?</option>
                              <option value="supplier_issue">💰 Agent: Process Customer Refund - Item unavailable</option>
                              <option value="customer_changed_mind">💭 Customer Changed Mind</option>
                              <option value="wrong_product">❌ Wrong Product Ordered</option>
                              <option value="quality_issues">⚠️ Quality Issues</option>
                              <option value="other">✏️ Other (specify below)</option>
                            </select>
                            <i class="fas fa-chevron-down modern-select-arrow"></i>
                          </div>
                        </div>
                        
                        <!-- Custom Reason -->
                        <div class="modern-form-group" data-dispatch-cancellation-target="customReason" style="display: none;">
                          <label class="modern-form-label">Custom Reason</label>
                          <input type="text" class="modern-input" placeholder="Please specify the reason...">
                        </div>
                        
                        <!-- Price Difference for Price Increase -->
                        <div class="modern-form-group" data-dispatch-cancellation-target="priceIncrease" style="display: none;">
                          <label class="modern-form-label">Price Increase Amount</label>
                          <div class="modern-amount-input-wrapper">
                            <span class="modern-currency">$</span>
                            <input type="number" class="modern-input" 
                                   data-dispatch-cancellation-target="priceIncreaseAmount"
                                   placeholder="0.00" 
                                   step="0.01" min="0">
                          </div>
                          <small class="modern-help-text">Additional cost for the item</small>
                        </div>
                        
                        <!-- Financial Grid -->
                        <div class="modern-financial-grid">
                          <div class="modern-amount-card">
                            <div class="modern-amount-label">Original Amount</div>
                            <div class="modern-amount-value">$<%= number_with_precision(@dispatch.total_cost || 0, precision: 2) %></div>
                            <input type="hidden" value="<%= @dispatch.total_cost || 0 %>">
                          </div>
                          
                          <div class="modern-amount-card modern-amount-editable">
                            <label class="modern-amount-label">Refund Amount</label>
                            <div class="modern-amount-input-wrapper">
                              <span class="modern-currency">$</span>
                              <input type="number" class="modern-amount-input" 
                                     data-dispatch-cancellation-target="refundAmount"
                                     data-action="input->dispatch-cancellation#refundAmountChanged"
                                     value="<%= @dispatch.total_cost || 0 %>" 
                                     step="0.01" min="0" max="<%= @dispatch.total_cost || 0 %>">
                            </div>
                            <small class="modern-help-text">Amount to refund</small>
                          </div>
                        </div>
                        
                        <!-- Refund Percentage Indicator -->
                        <div class="modern-percentage-card">
                          <div class="modern-percentage-header">
                            <span class="modern-percentage-label">Refund Percentage</span>
                            <span class="modern-percentage-value" id="refund-percentage-display">100%</span>
                          </div>
                          <div class="modern-percentage-bar">
                            <div class="modern-percentage-fill" id="refund-progress-bar" style="width: 100%"></div>
                          </div>
                        </div>
                      </form>
                    </div>

                    <!-- Footer -->
                    <div class="modern-modal-footer">
                      <button type="button" class="modern-btn modern-btn-secondary" 
                              data-action="click->dispatch-cancellation#cancelModal">
                        <i class="fas fa-times"></i>
                        <span>Cancel</span>
                      </button>
                      <button type="button" class="modern-btn modern-btn-danger" 
                              data-action="click->dispatch-cancellation#confirmCancellation">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Confirm Cancellation</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Supplier Lookup Modal -->
        <div id="supplier-lookup" class="lookup-modal">
          <div class="lookup-content">
            <div class="lookup-header">
              <h3>Select Supplier</h3>
              <button data-action="click->dispatch-form#closeLookupModal" 
                      data-type="supplier" 
                      class="close-btn">×</button>
            </div>
            <div class="lookup-body">
              <input type="text" 
                     id="supplier-search" 
                     placeholder="Search suppliers..." 
                     class="search-input">
              <div id="suppliers-list" class="lookup-results">
                <!-- Populated via AJAX -->
              </div>
            </div>
          </div>
        </div>
<% end %>