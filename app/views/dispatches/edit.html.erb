<!-- Main Content with Turbo Frame -->
<main class="main-content">
    <%= turbo_frame_tag "main_content" do %>
        <!-- Modern Timeline Dispatch Management Modal -->
        <div id="dispatch-modal" 
             class="dispatch-modal active" 
             data-controller="modal">
          
          <div class="modal-content">
            <!-- Modern Timeline Header -->
            <div class="modal-header">
              <div class="modal-header-content">
                <h2 class="modal-title">
                  <div class="modal-icon">
                    <i class="fas fa-shipping-fast"></i>
                  </div>
                  Manage Order #<%= @dispatch.order_number %>
                </h2>
                <p class="modal-subtitle">Update supplier costs, tracking, and fulfillment status</p>
                
                <div class="status-timeline">
                  <div class="timeline-line"></div>
                  <div class="timeline-progress" style="width: <%= calculate_progress_percentage(@dispatch) %>%;"></div>
                  
                  <div class="timeline-item <%= timeline_status_class(@dispatch, 'pending') %>">
                    <div class="timeline-marker">
                      <i class="fas fa-clock"></i>
                    </div>
                    <div class="timeline-label">Pending</div>
                    <div class="timeline-date">
                      <%= @dispatch.created_at.strftime('%b %d') if @dispatch.created_at %>
                    </div>
                  </div>
                  
                  <div class="timeline-item <%= timeline_status_class(@dispatch, 'processing') %>">
                    <div class="timeline-marker">
                      <i class="fas <%= @dispatch.dispatch_status == 'processing' ? 'fa-cog fa-spin' : 'fa-cog' %>"></i>
                    </div>
                    <div class="timeline-label">Processing</div>
                    <div class="timeline-date">
                      <%= processing_date(@dispatch) %>
                    </div>
                  </div>
                  
                  <div class="timeline-item <%= timeline_status_class(@dispatch, 'shipped') %>">
                    <div class="timeline-marker">
                      <i class="fas fa-truck"></i>
                    </div>
                    <div class="timeline-label">Shipped</div>
                    <div class="timeline-date">
                      <%= shipped_date(@dispatch) %>
                    </div>
                  </div>
                  
                  <div class="timeline-item <%= timeline_status_class(@dispatch, 'completed') %>">
                    <div class="timeline-marker">
                      <i class="fas fa-home"></i>
                    </div>
                    <div class="timeline-label">Delivered</div>
                    <div class="timeline-date">
                      <%= completed_date(@dispatch) %>
                    </div>
                  </div>
                </div>
              </div>
              
              <%= link_to dispatches_path, class: "close-btn", data: { turbo_frame: "main_content" } do %>
                <i class="fas fa-times"></i>
              <% end %>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
              <%= form_with model: @dispatch, local: false, data: { turbo_frame: "main_content" } do |f| %>
                <!-- Order Information Section -->
                <div class="section">
                  <div class="section-header">
                    <div class="section-icon">
                      <i class="fas fa-info-circle"></i>
                    </div>
                    <h3 class="section-title">Order Information</h3>
                    <% if @dispatch.order %>
                      <%= link_to "View Full Order", order_path(@dispatch.order), class: "section-action", target: "_blank" %>
                    <% end %>
                  </div>
                  
                  <div class="info-grid">
                    <div class="info-item">
                      <div class="info-label">Delivery Address</div>
                      <div class="info-value"><%= @dispatch.customer_address %></div>
                    </div>
                    <div class="info-item">
                      <div class="info-label">Customer</div>
                      <div class="info-value"><%= @dispatch.customer_name %></div>
                    </div>
                    <div class="info-item">
                      <div class="info-label">Product</div>
                      <div class="info-value"><%= @dispatch.product_name %></div>
                    </div>
                    <div class="info-item">
                      <div class="info-label">Vehicle</div>
                      <div class="info-value"><%= @dispatch.car_details %></div>
                    </div>
                  </div>
                </div>

                <!-- Supplier Management Section -->
                <div class="section">
                  <div class="section-header">
                    <div class="section-icon">
                      <i class="fas fa-truck"></i>
                    </div>
                    <h3 class="section-title">Supplier Management</h3>
                    <button type="button" class="section-action">Find Supplier</button>
                  </div>
                  
                  <div class="form-grid">
                    <div class="form-group">
                      <%= f.label :supplier_name, class: "form-label required" %>
                      <%= f.text_field :supplier_name, class: "form-input", placeholder: "Enter supplier name" %>
                    </div>
                    <div class="form-group">
                      <%= f.label :supplier_order_number, "Supplier Order #", class: "form-label" %>
                      <%= f.text_field :supplier_order_number, class: "form-input", placeholder: "Supplier's order number" %>
                    </div>
                    <div class="form-group">
                      <%= f.label :supplier_cost, class: "form-label required" %>
                      <%= f.number_field :supplier_cost, step: 0.01, class: "form-input" %>
                    </div>
                    <div class="form-group">
                      <%= f.label :condition, class: "form-label" %>
                      <%= f.select :condition, options_for_select([
                        ['New', 'new'],
                        ['Used', 'used'],
                        ['Refurbished', 'refurbished']
                      ], @dispatch.condition), { prompt: 'Select condition' }, { class: "form-select" } %>
                    </div>
                    <div class="form-group">
                      <%= f.label :tracking_number, class: "form-label" %>
                      <%= f.text_field :tracking_number, class: "form-input #{'highlight-value' if @dispatch.tracking_number.present?}" %>
                    </div>
                    <div class="form-group">
                      <%= f.label :supplier_shipment_proof, "Shipment Proof URL", class: "form-label" %>
                      <%= f.url_field :supplier_shipment_proof, class: "form-input", placeholder: "Link to tracking or shipment confirmation" %>
                    </div>
                  </div>
                </div>

                <!-- Financial Overview Section -->
                <div class="section">
                  <div class="section-header">
                    <div class="section-icon">
                      <i class="fas fa-dollar-sign"></i>
                    </div>
                    <h3 class="section-title">Financial Overview</h3>
                  </div>
                  
                  <div class="info-grid">
                    <div class="info-item">
                      <div class="info-label">Customer Price</div>
                      <div class="info-value cost-highlight">
                        <%= number_to_currency(@dispatch.product_cost) if @dispatch.product_cost %>
                      </div>
                    </div>
                    <div class="info-item">
                      <div class="info-label">Tax & Shipping</div>
                      <div class="info-value">
                        <%= number_to_currency((@dispatch.tax_amount || 0) + (@dispatch.shipping_cost || 0)) %>
                      </div>
                    </div>
                    <div class="info-item">
                      <div class="info-label">Supplier Cost</div>
                      <div class="info-value">
                        <%= number_to_currency(@dispatch.supplier_cost) if @dispatch.supplier_cost %>
                      </div>
                    </div>
                    <div class="info-item">
                      <div class="info-label">Estimated Profit</div>
                      <div class="info-value" style="color: #059669; font-weight: 700;">
                        <% if @dispatch.total_cost && @dispatch.supplier_cost %>
                          <%= number_to_currency(@dispatch.total_cost - @dispatch.supplier_cost) %>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>

                
                <!-- Form Actions -->
                <div class="section">
                  <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #f1f5f9;">
                    <%= link_to dispatches_path, class: "btn-secondary", data: { turbo_frame: "main_content" } do %>
                      <i class="fas fa-times"></i>
                      Cancel
                    <% end %>
                    <button type="submit" class="btn-primary">
                      <i class="fas fa-save"></i>
                      Update Dispatch
                    </button>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
    <% end %>
</main>

<!-- Supplier Lookup Modal -->
<div id="supplier-lookup" class="lookup-modal">
  <div class="lookup-content">
    <div class="lookup-header">
      <h3>Select Supplier</h3>
      <button data-action="click->dispatch-form#closeLookupModal" 
              data-type="supplier" 
              class="close-btn">Ã—</button>
    </div>
    <div class="lookup-body">
      <input type="text" 
             id="supplier-search" 
             placeholder="Search suppliers..." 
             class="search-input">
      <div id="suppliers-list" class="lookup-results">
        <!-- Populated via AJAX -->
      </div>
    </div>
  </div>
</div>