<%= turbo_frame_tag "main_content", data: { turbo_action: "advance" } do %>
<div class="main-content">
  <div class="container-fluid mt-4">
    <div class="row">
      <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>PayPal Invoices</h2>
          <%= link_to "Create New Invoice", new_invoice_path, class: "btn btn-primary", data: { turbo_frame: "main_content" } %>
        </div>
      
      <!-- Stats Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-info text-white">
            <div class="card-body">
              <h5>Total Invoices</h5>
              <h3><%= @stats[:total_invoices] %></h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-warning text-white">
            <div class="card-body">
              <h5>Pending</h5>
              <h3><%= @stats[:pending_invoices] %></h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-success text-white">
            <div class="card-body">
              <h5>Paid</h5>
              <h3><%= @stats[:paid_invoices] %></h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-secondary text-white">
            <div class="card-body">
              <h5>Pending Amount</h5>
              <h3>$<%= number_with_precision(@stats[:pending_amount], precision: 2) %></h3>
            </div>
          </div>
        </div>
      </div>

      <!-- Invoices Table -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">All Invoices</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Invoice #</th>
                  <th>Type</th>
                  <th>Customer</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Due Date</th>
                  <th>PayPal URL</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% @invoices.each do |invoice| %>
                  <tr>
                    <td>
                      <%= link_to invoice.invoice_number, invoice_path(invoice), class: "text-decoration-none", data: { turbo_frame: "main_content" } %>
                    </td>
                    <td>
                      <span class="badge bg-light text-dark" title="<%= invoice.type_description %>">
                        <%= invoice.type_display %>
                      </span>
                      <% if invoice.source.present? %>
                        <br><small class="text-muted">
                          <% if invoice.pre_order_invoice? %>
                            CB-<%= invoice.source.id %>
                          <% elsif invoice.order_payment_invoice? %>
                            Order #<%= invoice.source.order_number %>
                          <% end %>
                        </small>
                      <% end %>
                    </td>
                    <td>
                      <div>
                        <strong><%= invoice.customer_name %></strong><br>
                        <small class="text-muted"><%= invoice.customer_email %></small>
                      </div>
                    </td>
                    <td><strong><%= invoice.formatted_amount %></strong></td>
                    <td>
                      <span class="badge <%= invoice.status == 'paid' ? 'bg-success' : invoice.status == 'sent' ? 'bg-warning' : 'bg-secondary' %>">
                        <%= invoice.status.titleize %>
                      </span>
                    </td>
                    <td>
                      <% if invoice.due_date %>
                        <%= invoice.due_date.strftime('%m/%d/%Y') %>
                        <% if invoice.overdue? %>
                          <small class="text-danger">(Overdue)</small>
                        <% end %>
                      <% else %>
                        <span class="text-muted">No due date</span>
                      <% end %>
                    </td>
                    <td>
                      <% if invoice.paypal_invoice_url.present? %>
                        <%= link_to "View PayPal", invoice.paypal_invoice_url, 
                            target: "_blank", class: "btn btn-sm btn-outline-primary" %>
                      <% else %>
                        <span class="text-muted">Not sent</span>
                      <% end %>
                    </td>
                    <td>
                      <div class="btn-group" role="group">
                        <%= link_to "View", invoice_path(invoice), class: "btn btn-sm btn-outline-info", data: { turbo_frame: "main_content" } %>
                        <% if invoice.draft? %>
                          <%= link_to "Send", send_invoice_invoice_path(invoice), 
                              method: :patch, class: "btn btn-sm btn-success",
                              data: { confirm: "Send this invoice via PayPal?" } %>
                        <% end %>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
          
          <% if @invoices.empty? %>
            <div class="text-center py-4">
              <p class="text-muted">No invoices yet.</p>
              <%= link_to "Create your first invoice", new_invoice_path, class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
      
      <!-- Pagination -->
      <% if @invoices.respond_to?(:current_page) %>
        <div class="mt-3">
          <%= paginate @invoices, theme: 'axpagination' %>
        </div>
      <% end %>
      </div>
    </div>
  </div>
</div>
<% end %>