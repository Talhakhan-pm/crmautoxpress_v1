<%= turbo_frame_tag "main_content", data: { turbo_action: "advance" } do %>
<main class="main-content">
  <!-- Admin Header -->
  <header class="main-header">
    <div class="header-left">
      <h1>Admin - Manage Users</h1>
      <div class="breadcrumb">Admin › Users › Dialpad Configuration</div>
    </div>
    <div class="header-actions">
      <%= link_to dashboard_path, class: "btn btn-secondary", data: { turbo_frame: "main_content" } do %>
        <i class="fas fa-arrow-left"></i>
        Back to Dashboard
      <% end %>
    </div>
  </header>

  <!-- Users Table -->
  <div class="admin-users-container">
    <div class="card">
      <div class="card-header">
        <h3>User Dialpad Configuration</h3>
        <p class="text-muted">Manage Dialpad user IDs for all agents</p>
      </div>
      
      <div class="card-body">
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Dialpad User ID</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @users.each do |user| %>
                <tr id="user_<%= user.id %>">
                  <td>
                    <div class="user-info">
                      <div class="user-avatar">
                        <%= user.email.first.upcase %>
                      </div>
                      <div class="user-details">
                        <strong><%= user.email %></strong>
                        <% if user.admin? %>
                          <span class="badge badge-admin">Admin</span>
                        <% end %>
                      </div>
                    </div>
                  </td>
                  <td>
                    <%= form_with model: [:admin, user], local: false, class: "dialpad-form", data: { user_id: user.id } do |form| %>
                      <%= form.text_field :dialpad_user_id, 
                                          value: user.dialpad_user_id,
                                          placeholder: "Enter Dialpad User ID",
                                          class: "form-control dialpad-input",
                                          data: { original_value: user.dialpad_user_id } %>
                    <% end %>
                  </td>
                  <td>
                    <span class="status-badge status-<%= user.dialpad_configured? ? 'configured' : 'missing' %>" 
                          id="status_<%= user.id %>">
                      <% if user.dialpad_configured? %>
                        <i class="fas fa-check-circle"></i>
                        Configured
                      <% else %>
                        <i class="fas fa-exclamation-circle"></i>
                        Missing
                      <% end %>
                    </span>
                  </td>
                  <td>
                    <button type="button" 
                            class="btn btn-sm btn-primary save-btn"
                            data-user-id="<%= user.id %>"
                            onclick="saveDialpadId(<%= user.id %>)"
                            style="display: none;">
                      <i class="fas fa-save"></i>
                      Save
                    </button>
                    <button type="button" 
                            class="btn btn-sm btn-secondary cancel-btn"
                            data-user-id="<%= user.id %>"
                            onclick="cancelEdit(<%= user.id %>)"
                            style="display: none;">
                      Cancel
                    </button>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Help Section -->
    <div class="card mt-4">
      <div class="card-header">
        <h4>How to Find Dialpad User IDs</h4>
      </div>
      <div class="card-body">
        <ol>
          <li>Log into Dialpad admin panel</li>
          <li>Go to <strong>Team</strong> → <strong>Users</strong></li>
          <li>Click on a user to view their profile</li>
          <li>The User ID will be in the URL or user details</li>
          <li>Copy the numeric ID (e.g., <code>5503393985740800</code>)</li>
        </ol>
        
        <div class="mt-3">
          <h5>Known User IDs:</h5>
          <ul class="list-unstyled">
            <li><code>khan@truckonrails.com</code> → <code>5503393985740800</code></li>
            <li><code>meanproximity@gmail.com</code> → <code>5687535988817920</code></li>
            <li><code>roy@truckonrails.com</code> → <code>5182373231869952</code></li>
            <li><code>retention@truckonrails.com</code> → <code>6496921529696256</code></li>
            <li><code>gustavo@truckonrails.com</code> → <code>5442156569247744</code></li>
            <li><code>autopart@truckonrails.com</code> → <code>5925466191249408</code></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
// Track changes to show save/cancel buttons
document.addEventListener('DOMContentLoaded', function() {
  const inputs = document.querySelectorAll('.dialpad-input');
  
  inputs.forEach(input => {
    input.addEventListener('input', function() {
      const userId = this.closest('tr').id.replace('user_', '');
      const originalValue = this.dataset.originalValue || '';
      const currentValue = this.value;
      
      const saveBtn = document.querySelector(`[data-user-id="${userId}"].save-btn`);
      const cancelBtn = document.querySelector(`[data-user-id="${userId}"].cancel-btn`);
      
      if (currentValue !== originalValue) {
        if (saveBtn) saveBtn.style.display = 'inline-block';
        if (cancelBtn) cancelBtn.style.display = 'inline-block';
      } else {
        if (saveBtn) saveBtn.style.display = 'none';
        if (cancelBtn) cancelBtn.style.display = 'none';
      }
    });
  });
});

function saveDialpadId(userId) {
  const form = document.querySelector(`#user_${userId} .dialpad-form`);
  const input = form.querySelector('.dialpad-input');
  const saveBtn = document.querySelector(`[data-user-id="${userId}"].save-btn`);
  const originalText = saveBtn.innerHTML;
  
  // Show loading
  saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
  saveBtn.disabled = true;
  
  const formData = new FormData(form);
  
  fetch(form.action, {
    method: 'PATCH',
    headers: {
      'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
      'Accept': 'application/json'
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      // Update UI
      input.dataset.originalValue = input.value;
      updateStatus(userId, input.value ? 'configured' : 'missing');
      hideButtons(userId);
      showNotification('Dialpad ID updated successfully!', 'success');
    } else {
      showNotification(data.message || 'Failed to update', 'error');
    }
  })
  .catch(error => {
    showNotification('Network error occurred', 'error');
  })
  .finally(() => {
    saveBtn.innerHTML = originalText;
    saveBtn.disabled = false;
  });
}

function cancelEdit(userId) {
  const input = document.querySelector(`#user_${userId} .dialpad-input`);
  input.value = input.dataset.originalValue || '';
  hideButtons(userId);
}

function hideButtons(userId) {
  document.querySelector(`[data-user-id="${userId}"].save-btn`).style.display = 'none';
  document.querySelector(`[data-user-id="${userId}"].cancel-btn`).style.display = 'none';
}

function updateStatus(userId, status) {
  const statusBadge = document.querySelector(`#status_${userId}`);
  statusBadge.className = `status-badge status-${status}`;
  
  if (status === 'configured') {
    statusBadge.innerHTML = '<i class="fas fa-check-circle"></i> Configured';
  } else {
    statusBadge.innerHTML = '<i class="fas fa-exclamation-circle"></i> Missing';
  }
}

function showNotification(message, type) {
  // Reuse the notification system from callback cards
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#10b981' : '#ef4444'};
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    transform: translateX(100%);
    transition: transform 0.3s ease;
  `;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  setTimeout(() => notification.style.transform = 'translateX(0)', 100);
  setTimeout(() => {
    notification.style.transform = 'translateX(100%)';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}
</script>

<style>
.admin-users-container {
  padding: 20px;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #3b82f6;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

.badge-admin {
  background: #f59e0b;
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.75rem;
  margin-left: 8px;
}

.status-badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.875rem;
  font-weight: 500;
}

.status-configured {
  background: #dcfce7;
  color: #166534;
}

.status-missing {
  background: #fef2f2;
  color: #dc2626;
}

.dialpad-input {
  min-width: 200px;
}

.table td {
  vertical-align: middle;
}
</style>
<% end %>