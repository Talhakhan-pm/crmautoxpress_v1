<!-- Header -->
<header class="main-header">
    <div class="header-left">
        <h1>Callback #CB-<%= Date.current.year %>-<%= callback.id.to_s.rjust(4, '0') %></h1>
        <div class="breadcrumb">CRM › Callbacks › Callback Details</div>
    </div>
    <div class="header-actions">
        <button class="btn btn-secondary">
            <i class="fas fa-phone"></i>
            Call Customer
        </button>
        <%= link_to new_invoice_path(agent_callback_id: callback.id), class: "btn btn-success me-2" do %>
            <i class="fas fa-file-invoice"></i>
            Create Invoice
        <% end %>
        <%= link_to edit_callback_path(callback), class: "btn btn-primary", 
            data: { turbo_frame: "main_content" } do %>
            <i class="fas fa-edit"></i>
            Edit Callback
        <% end %>
    </div>
</header>

<!-- Content -->
<div class="content-container">
    <!-- Main Callback Detail -->
    <div class="callback-detail">
        <div class="callback-header">
            <h2 class="callback-title">Callback Details</h2>
        </div>
        
        <div class="callback-content">
            <div class="tab-container">
                <div class="tab-list">
                    <div class="tab-item active" data-action="click->callback-form#switchTab">Details</div>
                    <div class="tab-item" data-action="click->callback-form#switchTab">Communication</div>
                    <div class="tab-item" data-action="click->callback-form#switchTab">Performance</div>
                </div>
            </div>

            <!-- Tab Content: Details -->
            <div class="tab-content active">
                <div class="field-group">
                    <div class="field">
                        <div class="field-label">Customer</div>
                        <div class="field-value"><%= callback.customer_name %></div>
                    </div>
                    <div class="field">
                        <div class="field-label">Phone</div>
                        <div class="field-value"><%= callback.phone_number %></div>
                    </div>
                </div>

                <div class="field-group">
                    <div class="field">
                        <div class="field-label">Product</div>
                        <div class="field-value"><%= callback.product %></div>
                    </div>
                    <div class="field">
                        <div class="field-label">Status</div>
                        <div class="field-value">
                            <span class="status-badge status-<%= callback.status %>"><%= callback.status.humanize %></span>
                        </div>
                    </div>
                </div>

                <div class="field-group">
                    <div class="field">
                        <div class="field-label">Vehicle</div>
                        <div class="field-value"><%= callback.year %> <%= callback.car_make_model %></div>
                    </div>
                    <div class="field">
                        <div class="field-label">Assigned Agent</div>
                        <div class="field-value"><%= callback.agent %></div>
                    </div>
                </div>

                <% if callback.notes.present? %>
                <div class="field">
                    <div class="field-label">Notes</div>
                    <div class="field-value"><%= callback.notes %></div>
                </div>
                <% end %>
            </div>

            <!-- Tab Content: Communication (hidden by default) -->
            <div class="tab-content" style="display: none;">
                <%= turbo_stream_from "callback_#{callback.id}_communications" %>
                
                <!-- Communication Composer -->
                <%= render 'communications/form', callback: callback %>
                
                <!-- Communication Thread -->
                <div class="communication-thread" id="communication-thread">
                    <% callback.communications.main_messages.recent.includes(:user, :replies).each do |communication| %>
                        <%= render 'communications/communication', communication: communication, current_user_for_broadcast: current_user %>
                    <% end %>
                </div>
            </div>

            <!-- Tab Content: Performance (hidden by default) -->
            <div class="tab-content" style="display: none;">
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="total-views"><%= callback.activities.where(action: 'viewed').count %></div>
                        <div class="metric-label">Total Views</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="total-edits"><%= callback.activities.where(action: 'updated').count %></div>
                        <div class="metric-label">Edits Made</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="agents-involved"><%= callback.activities.joins(:user).distinct('users.id').count('users.id') %></div>
                        <div class="metric-label">Agents Involved</div>
                    </div>
                </div>

                <div class="performance-section">
                    <h3 class="section-title">
                        <i class="fas fa-users"></i>
                        Agent Performance
                    </h3>
                    <div class="agent-list">
                        <% callback.activities.joins(:user).group('users.id', 'users.email').count.each do |user_data, activity_count| %>
                            <% user_id, user_email = user_data %>
                            <% user = User.find(user_id) %>
                            <div class="agent-row">
                                <div class="agent-info">
                                    <div class="agent-avatar"><%= user_email.first(2).upcase %></div>
                                    <div class="agent-name"><%= user_email %></div>
                                </div>
                                <div class="agent-stats">
                                    <div class="stat-item">
                                        <div class="stat-value"><%= callback.activities.where(user: user, action: 'viewed').count %></div>
                                        <div class="stat-label">Views</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value"><%= callback.activities.where(user: user, action: 'updated').count %></div>
                                        <div class="stat-label">Edits</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value"><%= activity_count %></div>
                                        <div class="stat-label">Total Actions</div>
                                    </div>
                                </div>
                            </div>
                        <% end %>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Activity Panel -->
    <div class="activity-panel">
        <div class="activity-header">
            <div class="activity-title">
                <i class="fas fa-history"></i>
                Activity Log
                <span class="activity-count" id="activity-count"><%= callback.activities.count %></span>
            </div>
        </div>

        <div class="activity-filters">
            <div class="filter-chip active" data-filter="all" data-action="click->callback-form#filterActivities">All</div>
            <div class="filter-chip" data-filter="viewed" data-action="click->callback-form#filterActivities">Views</div>
            <div class="filter-chip" data-filter="updated" data-action="click->callback-form#filterActivities">Edits</div>
            <div class="filter-chip" data-filter="created" data-action="click->callback-form#filterActivities">Created</div>
        </div>

        <div class="timeline-container" id="activity-list">
            <% callback.activities.recent.includes(:user).each do |activity| %>
                <%= render 'activities/activity', activity: activity %>
            <% end %>
        </div>
    </div>
</div>