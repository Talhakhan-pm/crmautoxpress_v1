<div class="cb-card cb-card-status-<%= callback.status %> <%= 'cb-card-recent' if callback.has_recent_activity? %>" 
     id="<%= dom_id(callback, :card) %>"
     data-callback-id="<%= callback.id %>"
     data-status="<%= callback.status %>"
     data-controller="callback-card">

  <!-- Card Header -->
  <div class="cb-card-header">
    <div class="cb-card-status">
      <span class="cb-status-badge cb-status-<%= callback.status || 'pending' %>">
        <%= (callback.status || 'pending').humanize %>
      </span>
      <% if callback.has_recent_activity? %>
        <span class="cb-activity-indicator">
          <i class="fas fa-pulse"></i>
        </span>
      <% end %>
    </div>
    
    <div class="cb-card-meta">
      <div class="cb-agent-info">
        <% 
          # Find who is currently calling this specific callback
          current_caller = User.find_by(
            current_target_type: 'callback', 
            current_target_id: callback.id,
            call_status: ['calling', 'on_call']
          )
          
          # Show either the active caller or the callback creator
          display_user = current_caller || callback.user
          is_active_call = current_caller.present?
        %>
        
        <div class="cb-agent-avatar" data-callback-id="<%= callback.id %>">
          <%= display_user.email.first.upcase %>
          <div class="cb-call-status-indicator" 
               data-user-id="<%= display_user.id %>"
               data-call-status="<%= display_user.call_status %>"
               data-target-type="<%= display_user.current_target_type %>"
               data-target-id="<%= display_user.current_target_id %>"
               data-callback-id="<%= callback.id %>">
            <i class="fas fa-circle cb-status-icon cb-status-<%= display_user.call_status %>"></i>
          </div>
        </div>
        <div class="cb-agent-details">
          <span class="cb-agent-name" data-callback-id="<%= callback.id %>"><%= display_user.email.split('@').first.humanize %></span>
          <span class="cb-call-status-text" 
                data-user-id="<%= display_user.id %>"
                data-call-status="<%= display_user.call_status %>"
                data-target-type="<%= display_user.current_target_type %>"
                data-target-id="<%= display_user.current_target_id %>"
                data-callback-id="<%= callback.id %>">
            <%= 
              if is_active_call
                case display_user.call_status
                when 'calling'
                  "Calling this customer"
                when 'on_call'
                  "On call with this customer"
                else
                  "Idle"
                end
              else
                "Idle"
              end
            %>
          </span>
        </div>
      </div>
      
      <div class="cb-card-time">
        <%= time_ago_in_words(callback.created_at) %> ago
      </div>
    </div>
  </div>

  <!-- Card Body - Customer Info (Fragment Cached) -->
  <% cache callback, expires_in: 1.hour do %>
    <div class="cb-card-body">
      <div class="cb-customer-info">
        <h3 class="cb-customer-name">
          <%= callback.customer_name %>
          <% if callback.communications_count > 0 %>
            <span class="cb-message-badge">
              <i class="fas fa-comment"></i>
              <%= callback.communications_count %>
            </span>
          <% end %>
        </h3>
        
        <div class="cb-customer-details">
          <div class="cb-phone">
            <i class="fas fa-phone"></i>
            <%= callback.phone_number %>
          </div>
          
          <div class="cb-vehicle">
            <i class="fas fa-car"></i>
            <%= callback.year %> <%= callback.car_make_model %>
          </div>
          
          <div class="cb-product">
            <i class="fas fa-cog"></i>
            <%= callback.product %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Action-Focused Dashboard (Fragment Cached) -->
  <% cache [callback, callback.priority_level, callback.call_attempts_count, callback.last_contact_date], expires_in: 5.minutes do %>
    <div class="cb-action-dashboard">
      <!-- Priority and Follow-up Row -->
      <div class="cb-action-row cb-priority-row">
        <div class="cb-follow-up-info">
          <i class="fas fa-calendar"></i>
          <span class="cb-follow-up-text">
            <%= callback.follow_up_display %>
          </span>
        </div>
        <div class="cb-priority-badge">
          <span class="badge <%= callback.priority_badge_class %> cb-priority-indicator">
            <%= callback.priority_display %>
          </span>
        </div>
      </div>
      
      <!-- Contact Stats Row -->
      <div class="cb-action-row cb-contact-stats">
        <div class="cb-call-attempts">
          <i class="fas fa-phone"></i>
          <span>Calls: <strong><%= callback.call_attempts_count %></strong></span>
          <% if callback.last_call_outcome %>
            <span class="cb-last-outcome">(<%= callback.last_call_outcome %>)</span>
          <% end %>
        </div>
        <div class="cb-last-contact">
          <i class="fas fa-clock"></i>
          <span>
            <% if callback.last_contact_date %>
              Last: <%= time_ago_in_words(callback.last_contact_date) %> ago
            <% else %>
              No contact yet
            <% end %>
          </span>
        </div>
      </div>
      
      <!-- Next Action Row - Hidden by default, shown after call initiation -->
      <div class="cb-action-row cb-next-action-row" 
           data-callback-card-target="nextAction"
           style="display: none;"
           data-callback-id="<%= callback.id %>">
        <div class="cb-next-action">
          <i class="fas fa-target"></i>
          <span class="cb-next-action-text">
            <%= callback.next_action || callback.suggest_next_action %>
          </span>
        </div>
      </div>
      
      <!-- Quick Actions Row - Hidden by default, shown after call initiation -->
      <div class="cb-quick-actions" 
           data-callback-card-target="quickActions" 
           style="display: none;"
           data-callback-id="<%= callback.id %>">
        <div class="cb-quick-actions-label">
          <i class="fas fa-clock"></i>
          Quick Updates (After Call):
        </div>
        <div class="cb-quick-buttons">
          <%= button_to quick_action_callback_path(callback), 
                        method: :patch, 
                        params: { action_type: 'called' },
                        class: "cb-quick-btn cb-quick-called",
                        title: "Mark as Called",
                        remote: true,
                        data: { 
                          confirm: "Mark this callback as called?",
                          turbo_method: :patch
                        } do %>
            <i class="fas fa-phone"></i>
            <span>Called</span>
          <% end %>
          
          <%= button_to quick_action_callback_path(callback), 
                        method: :patch, 
                        params: { action_type: 'no_answer' },
                        class: "cb-quick-btn cb-quick-no-answer",
                        title: "No Answer - Auto-schedule follow-up",
                        remote: true,
                        data: { 
                          confirm: "Mark as no answer? This will schedule follow-up for tomorrow.",
                          turbo_method: :patch
                        } do %>
            <i class="fas fa-phone-slash"></i>
            <span>No Answer</span>
          <% end %>
          
          <%= button_to quick_action_callback_path(callback), 
                        method: :patch, 
                        params: { action_type: 'interested' },
                        class: "cb-quick-btn cb-quick-interested",
                        title: "Customer Interested",
                        remote: true,
                        data: { 
                          confirm: "Mark customer as interested?",
                          turbo_method: :patch
                        } do %>
            <i class="fas fa-thumbs-up"></i>
            <span>Interested</span>
          <% end %>
          
          <%= button_to quick_action_callback_path(callback), 
                        method: :patch, 
                        params: { action_type: 'later' },
                        class: "cb-quick-btn cb-quick-call-later",
                        title: "Call Later - Schedule follow-up",
                        remote: true,
                        data: { 
                          confirm: "Schedule to call back later? This will set follow-up for next week.",
                          turbo_method: :patch
                        } do %>
            <i class="fas fa-clock"></i>
            <span>Call Later</span>
          <% end %>
          
          <%= button_to quick_action_callback_path(callback), 
                        method: :patch, 
                        params: { action_type: 'sale' },
                        class: "cb-quick-btn cb-quick-sale",
                        title: "Convert to Sale",
                        remote: true,
                        data: { 
                          confirm: "Mark as SALE? This will close the lead as won.",
                          turbo_method: :patch
                        } do %>
            <i class="fas fa-trophy"></i>
            <span>Sale</span>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Quick Actions (Fragment Cached) -->
  <% cache [callback, callback.status], expires_in: 2.hours do %>
    <div class="cb-card-actions" data-callback-card-target="actions">
      <div class="cb-primary-actions">
        <%= link_to callback_path(callback), class: "cb-action-btn cb-action-view", 
                    data: { turbo_frame: "main_content" }, title: "View Details" do %>
          <i class="fas fa-eye"></i>
          View
        <% end %>
        
        <button class="cb-action-btn cb-action-message" 
                data-action="click->callback-card#toggleComposer"
                title="Quick Message">
          <i class="fas fa-comment"></i>
          Message
        </button>
        
        <button class="cb-action-btn cb-action-call" 
                title="Call Customer"
                data-phone="<%= callback.phone_number %>"
                data-callback-id="<%= callback.id %>"
                data-action="click->callback-card#makeCall">
          <i class="fas fa-phone"></i>
          Call
        </button>
        
        <!-- Invoice Action -->
        <% unless callback.status == 'sale' %>
          <% if callback.can_create_invoice? %>
            <%= link_to new_invoice_path(agent_callback_id: callback.id), 
                        class: "cb-action-btn cb-action-invoice", 
                        data: { turbo_frame: "main_content" }, 
                        title: "Create Invoice" do %>
              <i class="fas fa-file-invoice"></i>
              Invoice
            <% end %>
          <% elsif callback.has_invoices? %>
            <%= link_to invoice_path(callback.latest_invoice), 
                        class: "cb-action-btn cb-action-invoice-sent", 
                        data: { turbo_frame: "main_content" }, 
                        title: "View Invoice",
                        style: "background-color: #e3f2fd; color: #1976d2; border-color: #1976d2;" do %>
              <i class="fas fa-file-invoice-dollar"></i>
              Invoiced
            <% end %>
          <% end %>
        <% end %>
        
        <% unless callback.status == 'sale' %>
          <%= link_to new_order_path(callback_id: callback.id), 
                      class: "cb-action-btn cb-action-convert", 
                      data: { turbo_frame: "_top" }, 
                      title: "Convert to Order",
                      style: "display: none;" do %>
            <i class="fas fa-shopping-cart"></i>
            Convert
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Inline Message Composer (Hidden by default) -->
  <div class="cb-quick-composer" data-callback-card-target="composer" style="display: none;">
    <%= form_with model: [callback, Communication.new], 
                  url: callback_communications_path(callback),
                  local: false,
                  class: "cb-composer-form",
                  data: { 
                    turbo_frame: false,
                    action: "turbo:submit-end->callback-card#hideComposer"
                  } do |form| %>
      
      <div class="cb-composer-input">
        <%= form.text_area :content, 
                           class: "cb-composer-textarea", 
                           rows: 2,
                           placeholder: "Quick message to team..." %>
      </div>
      
      <div class="cb-composer-actions">
        <button type="button" class="cb-composer-cancel" data-action="click->callback-card#hideComposer">
          Cancel
        </button>
        <%= form.submit "Send", class: "cb-composer-send" %>
      </div>
      
      <%= form.hidden_field :mentions %>
    <% end %>
  </div>
</div>