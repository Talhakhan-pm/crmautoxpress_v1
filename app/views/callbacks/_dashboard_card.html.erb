<div class="cb-card cb-card-status-<%= callback.status %> <%= 'cb-card-recent' if callback.has_recent_activity? %>" 
     id="<%= dom_id(callback, :card) %>"
     data-callback-id="<%= callback.id %>"
     data-status="<%= callback.status %>"
     data-controller="callback-card">

  <!-- Card Header -->
  <div class="cb-card-header">
    <div class="cb-card-status">
      <span class="cb-status-badge cb-status-<%= callback.status || 'pending' %>">
        <%= (callback.status || 'pending').humanize %>
      </span>
      <% if callback.has_recent_activity? %>
        <span class="cb-activity-indicator">
          <i class="fas fa-pulse"></i>
        </span>
      <% end %>
    </div>
    
    <div class="cb-card-meta">
      <div class="cb-agent-info">
        <% 
          # OPTIMIZED: Use preloaded current callers hash (eliminates N+1 query)
          current_caller = @current_callers&.fetch(callback.id, nil)
          
          # Show either the active caller or the callback creator
          display_user = current_caller || callback.user
          is_active_call = current_caller.present?
        %>
        
        <div class="cb-agent-avatar" data-callback-id="<%= callback.id %>">
          <%= display_user.email.first.upcase %>
          <div class="cb-call-status-indicator" 
               data-user-id="<%= display_user.id %>"
               data-call-status="<%= display_user.call_status %>"
               data-target-type="<%= display_user.current_target_type %>"
               data-target-id="<%= display_user.current_target_id %>"
               data-callback-id="<%= callback.id %>">
            <i class="fas fa-circle cb-status-icon cb-status-<%= display_user.call_status %>"></i>
          </div>
        </div>
        <div class="cb-agent-details">
          <span class="cb-agent-name" data-callback-id="<%= callback.id %>"><%= display_user.email.split('@').first.humanize %></span>
          <span class="cb-call-status-text" 
                data-user-id="<%= display_user.id %>"
                data-call-status="<%= display_user.call_status %>"
                data-target-type="<%= display_user.current_target_type %>"
                data-target-id="<%= display_user.current_target_id %>"
                data-callback-id="<%= callback.id %>">
            <%= 
              if is_active_call
                case display_user.call_status
                when 'calling'
                  "Calling this customer"
                when 'on_call'
                  "On call with this customer"
                else
                  "Idle"
                end
              else
                "Idle"
              end
            %>
          </span>
        </div>
      </div>
      
      <div class="cb-card-time">
        <%= time_ago_in_words(callback.created_at) %> ago
      </div>
    </div>
  </div>

  <!-- Card Body - Customer Info (Fragment Cached) -->
  <% cache callback, expires_in: 1.hour do %>
    <div class="cb-card-body">
      <div class="cb-customer-info">
        <h3 class="cb-customer-name">
          <%= callback.customer_name %>
          <% if callback.communications_count > 0 %>
            <span class="cb-message-badge">
              <i class="fas fa-comment"></i>
              <%= callback.communications_count %>
            </span>
          <% end %>
        </h3>
        
        <div class="cb-customer-details">
          <div class="cb-phone">
            <i class="fas fa-phone"></i>
            <%= callback.phone_number %>
          </div>
          
          <div class="cb-vehicle">
            <i class="fas fa-car"></i>
            <%= callback.year %> <%= callback.car_make_model %>
          </div>
          
          <div class="cb-product">
            <i class="fas fa-cog"></i>
            <%= callback.product %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Action-Focused Dashboard (Fragment Cached) -->
  <% cache [callback, callback.priority_level, callback.call_attempts_count, callback.last_contact_date], expires_in: 5.minutes do %>
    <div class="cb-action-dashboard">
      <!-- Priority and Follow-up Row (only for active callbacks) -->
      <% unless callback.status.in?(['sale', 'not_interested', 'already_purchased']) %>
        <div class="cb-action-row cb-priority-row">
          <div class="cb-follow-up-info">
            <i class="fas fa-calendar"></i>
            <span class="cb-follow-up-text">
              <%= callback.follow_up_display %>
            </span>
          </div>
          <div class="cb-priority-badge">
            <span class="badge <%= callback.priority_badge_class %> cb-priority-indicator">
              <%= callback.priority_display %>
            </span>
          </div>
        </div>
      <% end %>
      
      <!-- Contact Stats Row -->
      <div class="cb-action-row cb-contact-stats">
        <div class="cb-call-attempts">
          <i class="fas fa-phone"></i>
          <span>Calls: <strong><%= callback.call_attempts_count %></strong></span>
          <% if callback.last_call_outcome %>
            <span class="cb-last-outcome">(<%= callback.last_call_outcome %>)</span>
          <% end %>
        </div>
        <div class="cb-last-contact">
          <i class="fas fa-clock"></i>
          <span>
            <% if callback.last_contact_date %>
              Last: <%= time_ago_in_words(callback.last_contact_date) %> ago
            <% else %>
              No contact yet
            <% end %>
          </span>
        </div>
      </div>
      
      <!-- Next Action Row - Shows when next action is set -->
      <% if callback.next_action.present? %>
        <div class="cb-action-row cb-next-action-row" 
             data-callback-id="<%= callback.id %>">
          <div class="cb-next-action">
            <i class="fas fa-target"></i>
            <span class="cb-next-action-text">
              <%= callback.next_action %>
            </span>
          </div>
        </div>
      <% end %>
      
      
      <!-- Combined Post-Call Actions - Hidden by default, shown after call initiation -->
      <div class="cb-post-call-actions" 
           data-callback-card-target="quickActions" 
           style="display: none;"
           data-callback-id="<%= callback.id %>">
        <div class="cb-post-call-label">
          <i class="fas fa-clock"></i>
          Post-Call Update:
        </div>
        
        <%= form_with url: quick_action_callback_path(callback), 
                      method: :patch,
                      local: false,
                      class: "cb-post-call-form",
                      data: { 
                        turbo_method: :patch,
                        action: "turbo:submit-end->callback-card#hidePostCallActions"
                      } do |form| %>
          
          <!-- Disposition Selection -->
          <div class="cb-disposition-section">
            <label class="cb-disposition-label">What happened on the call?</label>
            <div class="cb-disposition-buttons">
              <label class="cb-disposition-option">
                <%= form.radio_button :action_type, 'called', class: "cb-disposition-radio" %>
                <span class="cb-disposition-btn cb-quick-called">
                  <i class="fas fa-phone"></i>
                  Called
                </span>
              </label>
              
              <label class="cb-disposition-option">
                <%= form.radio_button :action_type, 'no_answer', class: "cb-disposition-radio" %>
                <span class="cb-disposition-btn cb-quick-no-answer">
                  <i class="fas fa-phone-slash"></i>
                  No Answer
                </span>
              </label>
              
              <label class="cb-disposition-option">
                <%= form.radio_button :action_type, 'interested', class: "cb-disposition-radio" %>
                <span class="cb-disposition-btn cb-quick-interested">
                  <i class="fas fa-thumbs-up"></i>
                  Interested
                </span>
              </label>
              
              <label class="cb-disposition-option">
                <%= form.radio_button :action_type, 'later', class: "cb-disposition-radio" %>
                <span class="cb-disposition-btn cb-quick-call-later">
                  <i class="fas fa-clock"></i>
                  Call Later
                </span>
              </label>
              
              <label class="cb-disposition-option">
                <%= form.radio_button :action_type, 'sale', class: "cb-disposition-radio" %>
                <span class="cb-disposition-btn cb-quick-sale">
                  <i class="fas fa-trophy"></i>
                  Sale
                </span>
              </label>
            </div>
          </div>
          
          <!-- Next Action Input -->
          <div class="cb-next-action-section">
            <label class="cb-next-action-label">
              <i class="fas fa-target"></i>
              Next Action (optional):
            </label>
            <%= form.text_field :next_action, 
                               value: callback.next_action,
                               class: "cb-next-action-input", 
                               placeholder: "What should happen next?",
                               maxlength: 500 %>
          </div>
          
          <!-- Submit Buttons -->
          <div class="cb-post-call-buttons">
            <button type="button" class="cb-post-call-cancel" data-action="click->callback-card#hidePostCallActions">
              Cancel
            </button>
            <%= form.submit "Update Callback", class: "cb-post-call-save" %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Quick Actions (Fragment Cached) -->
  <% cache [callback, callback.status], expires_in: 2.hours do %>
    <div class="cb-card-actions" data-callback-card-target="actions">
      <div class="cb-primary-actions">
        <%= link_to callback_path(callback), class: "cb-action-btn cb-action-view", 
                    data: { turbo_frame: "main_content" }, title: "View Details" do %>
          <i class="fas fa-eye"></i>
          View
        <% end %>
        
        <button class="cb-action-btn cb-action-message" 
                data-action="click->callback-card#toggleComposer"
                title="Quick Message">
          <i class="fas fa-comment"></i>
          Message
        </button>
        
        <button class="cb-action-btn cb-action-call" 
                title="Call Customer"
                data-phone="<%= callback.phone_number %>"
                data-callback-id="<%= callback.id %>"
                data-action="click->callback-card#makeCall">
          <i class="fas fa-phone"></i>
          Call
        </button>
        
        <!-- Invoice Action -->
        <% unless callback.status == 'sale' %>
          <% if callback.can_create_invoice? %>
            <%= link_to new_invoice_path(agent_callback_id: callback.id), 
                        class: "cb-action-btn cb-action-invoice", 
                        data: { turbo_frame: "main_content" }, 
                        title: "Create Invoice" do %>
              <i class="fas fa-file-invoice"></i>
              Invoice
            <% end %>
          <% elsif callback.has_invoices? %>
            <%= link_to invoice_path(callback.latest_invoice), 
                        class: "cb-action-btn cb-action-invoice-sent", 
                        data: { turbo_frame: "main_content" }, 
                        title: "View Invoice",
                        style: "background-color: #e3f2fd; color: #1976d2; border-color: #1976d2;" do %>
              <i class="fas fa-file-invoice-dollar"></i>
              Invoiced
            <% end %>
          <% end %>
        <% end %>
        
        <% unless callback.status == 'sale' %>
          <%= link_to new_order_path(callback_id: callback.id), 
                      class: "cb-action-btn cb-action-convert", 
                      data: { turbo_frame: "_top" }, 
                      title: "Convert to Order",
                      style: "display: none;" do %>
            <i class="fas fa-shopping-cart"></i>
            Convert
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Inline Message Composer (Hidden by default) -->
  <div class="cb-quick-composer" data-callback-card-target="composer" style="display: none;">
    <%= form_with model: [callback, Communication.new], 
                  url: callback_communications_path(callback),
                  local: false,
                  class: "cb-composer-form",
                  data: { 
                    turbo_frame: false,
                    action: "turbo:submit-end->callback-card#hideComposer"
                  } do |form| %>
      
      <div class="cb-composer-input">
        <%= form.text_area :content, 
                           class: "cb-composer-textarea", 
                           rows: 2,
                           placeholder: "Quick message to team..." %>
      </div>
      
      <div class="cb-composer-actions">
        <button type="button" class="cb-composer-cancel" data-action="click->callback-card#hideComposer">
          Cancel
        </button>
        <%= form.submit "Send", class: "cb-composer-send" %>
      </div>
      
      <%= form.hidden_field :mentions %>
    <% end %>
  </div>
</div>