<div class="cb-card cb-card-status-<%= callback.status %> <%= 'cb-card-recent' if callback.has_recent_activity? %>" 
     id="<%= dom_id(callback, :card) %>"
     data-callback-id="<%= callback.id %>"
     data-status="<%= callback.status %>"
     data-controller="callback-card">

  <!-- Card Header -->
  <div class="cb-card-header">
    <div class="cb-card-status">
      <span class="cb-status-badge cb-status-<%= callback.status || 'pending' %>">
        <%= (callback.status || 'pending').humanize %>
      </span>
      <% if callback.has_recent_activity? %>
        <span class="cb-activity-indicator">
          <i class="fas fa-pulse"></i>
        </span>
      <% end %>
    </div>
    
    <div class="cb-card-meta">
      <div class="cb-agent-info">
        <% 
          # Find who is currently calling this specific callback
          current_caller = User.find_by(
            current_target_type: 'callback', 
            current_target_id: callback.id,
            call_status: ['calling', 'on_call']
          )
          
          # Show either the active caller or the callback creator
          display_user = current_caller || callback.user
          is_active_call = current_caller.present?
        %>
        
        <div class="cb-agent-avatar" data-callback-id="<%= callback.id %>">
          <%= display_user.email.first.upcase %>
          <div class="cb-call-status-indicator" 
               data-user-id="<%= display_user.id %>"
               data-call-status="<%= display_user.call_status %>"
               data-target-type="<%= display_user.current_target_type %>"
               data-target-id="<%= display_user.current_target_id %>"
               data-callback-id="<%= callback.id %>">
            <i class="fas fa-circle cb-status-icon cb-status-<%= display_user.call_status %>"></i>
          </div>
        </div>
        <div class="cb-agent-details">
          <span class="cb-agent-name" data-callback-id="<%= callback.id %>"><%= display_user.email.split('@').first.humanize %></span>
          <span class="cb-call-status-text" 
                data-user-id="<%= display_user.id %>"
                data-call-status="<%= display_user.call_status %>"
                data-target-type="<%= display_user.current_target_type %>"
                data-target-id="<%= display_user.current_target_id %>"
                data-callback-id="<%= callback.id %>">
            <%= 
              if is_active_call
                case display_user.call_status
                when 'calling'
                  "Calling this customer"
                when 'on_call'
                  "On call with this customer"
                else
                  "Idle"
                end
              else
                "Idle"
              end
            %>
          </span>
        </div>
      </div>
      
      <div class="cb-card-time">
        <%= time_ago_in_words(callback.created_at) %> ago
      </div>
    </div>
  </div>

  <!-- Card Body - Customer Info (Fragment Cached) -->
  <% cache callback, expires_in: 1.hour do %>
    <div class="cb-card-body">
      <div class="cb-customer-info">
        <h3 class="cb-customer-name">
          <%= callback.customer_name %>
          <% if callback.communications_count > 0 %>
            <span class="cb-message-badge">
              <i class="fas fa-comment"></i>
              <%= callback.communications_count %>
            </span>
          <% end %>
        </h3>
        
        <div class="cb-customer-details">
          <div class="cb-phone">
            <i class="fas fa-phone"></i>
            <%= callback.phone_number %>
          </div>
          
          <div class="cb-vehicle">
            <i class="fas fa-car"></i>
            <%= callback.year %> <%= callback.car_make_model %>
          </div>
          
          <div class="cb-product">
            <i class="fas fa-cog"></i>
            <%= callback.product %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Communication Preview (Fragment Cached) -->
  <% cache [callback, callback.latest_communication, callback.communications_count], expires_in: 15.minutes do %>
    <div class="cb-card-communication">
      <% if callback.latest_communication %>
        <div class="cb-communication-preview">
          <div class="cb-message-header">
            <i class="fas fa-comment"></i>
            <span class="cb-message-author">
              <%= callback.latest_communication.author_name %>:
            </span>
            <span class="cb-message-time">
              <%= time_ago_in_words(callback.latest_communication.created_at) %> ago
            </span>
          </div>
          
          <div class="cb-message-content">
            <%= truncate(callback.latest_communication.content, length: 100) %>
          </div>
          
          <% if callback.communications_count > 1 %>
            <div class="cb-message-count">
              <i class="fas fa-comments"></i>
              <%= callback.communications_count %> messages
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="cb-no-communication">
          <i class="fas fa-comment-slash"></i>
          <span>No team messages yet</span>
        </div>
      <% end %>

      <!-- Team Members -->
      <% if callback.team_members.any? %>
        <div class="cb-team-members">
          <div class="cb-team-label">Team:</div>
          <div class="cb-team-avatars">
            <% callback.team_members.each do |member| %>
              <div class="cb-team-avatar" title="<%= member.email %>">
                <%= member.email.first.upcase %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Quick Actions (Fragment Cached) -->
  <% cache [callback, callback.status], expires_in: 2.hours do %>
    <div class="cb-card-actions" data-callback-card-target="actions">
      <div class="cb-primary-actions">
        <%= link_to callback_path(callback), class: "cb-action-btn cb-action-view", 
                    data: { turbo_frame: "main_content" }, title: "View Details" do %>
          <i class="fas fa-eye"></i>
          View
        <% end %>
        
        <button class="cb-action-btn cb-action-message" 
                data-action="click->callback-card#toggleComposer"
                title="Quick Message">
          <i class="fas fa-comment"></i>
          Message
        </button>
        
        <button class="cb-action-btn cb-action-call" 
                title="Call Customer"
                data-phone="<%= callback.phone_number %>"
                data-callback-id="<%= callback.id %>"
                data-action="click->callback-card#makeCall">
          <i class="fas fa-phone"></i>
          Call
        </button>
        
        <!-- Invoice Action -->
        <% unless callback.status == 'sale' %>
          <% if callback.can_create_invoice? %>
            <%= link_to new_invoice_path(agent_callback_id: callback.id), 
                        class: "cb-action-btn cb-action-invoice", 
                        data: { turbo_frame: "main_content" }, 
                        title: "Create Invoice" do %>
              <i class="fas fa-file-invoice"></i>
              Invoice
            <% end %>
          <% elsif callback.has_invoices? %>
            <%= link_to invoice_path(callback.latest_invoice), 
                        class: "cb-action-btn cb-action-invoice-sent", 
                        data: { turbo_frame: "main_content" }, 
                        title: "View Invoice",
                        style: "background-color: #e3f2fd; color: #1976d2; border-color: #1976d2;" do %>
              <i class="fas fa-file-invoice-dollar"></i>
              Invoiced
            <% end %>
          <% end %>
        <% end %>
        
        <% unless callback.status == 'sale' %>
          <%= link_to new_order_path(callback_id: callback.id), 
                      class: "cb-action-btn cb-action-convert", 
                      data: { turbo_frame: "_top" }, 
                      title: "Convert to Order",
                      style: "display: none;" do %>
            <i class="fas fa-shopping-cart"></i>
            Convert
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Inline Message Composer (Hidden by default) -->
  <div class="cb-quick-composer" data-callback-card-target="composer" style="display: none;">
    <%= form_with model: [callback, Communication.new], 
                  url: callback_communications_path(callback),
                  local: false,
                  class: "cb-composer-form",
                  data: { 
                    turbo_frame: false,
                    action: "turbo:submit-end->callback-card#hideComposer"
                  } do |form| %>
      
      <div class="cb-composer-input">
        <%= form.text_area :content, 
                           class: "cb-composer-textarea", 
                           rows: 2,
                           placeholder: "Quick message to team..." %>
      </div>
      
      <div class="cb-composer-actions">
        <button type="button" class="cb-composer-cancel" data-action="click->callback-card#hideComposer">
          Cancel
        </button>
        <%= form.submit "Send", class: "cb-composer-send" %>
      </div>
      
      <%= form.hidden_field :mentions %>
    <% end %>
  </div>
</div>