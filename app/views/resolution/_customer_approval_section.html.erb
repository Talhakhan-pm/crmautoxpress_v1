<div class="workflow-section agent-task">
  <div class="section-header">
    <h6><i class="fas fa-headset"></i> Agent Task: Customer Contact</h6>
    <span class="section-description">Execute customer decision based on dispatcher's sourcing results</span>
  </div>

  <div class="workflow-content">
    <!-- Dispatcher Instructions -->
    <div class="dispatcher-instructions">
      <h7>Dispatcher's Sourcing Results:</h7>
      <div class="instructions-content">
        <%= refund.agent_instructions.present? ? simple_format(refund.agent_instructions) : "Contact customer for approval" %>
      </div>
    </div>

    <!-- Customer Contact Info -->
    <div class="customer-contact">
      <h7>Customer Contact:</h7>
      <div class="contact-details">
        <strong>Name:</strong> <%= refund.order.customer_name %><br>
        <strong>Phone:</strong> <%= refund.order.customer_phone %><br>
        <% if refund.order.customer_email.present? %>
          <strong>Email:</strong> <%= refund.order.customer_email %><br>
        <% end %>
      </div>
    </div>

    <!-- Decision Context -->
    <% case refund.dispatcher_decision %>
    <% when 'delay_required' %>
      <div class="decision-context delay-context">
        <h7>Delay Information:</h7>
        <p><strong><%= refund.delay_duration %> day delay</strong> - Part sourced successfully but delivery timing affected</p>
      </div>
    <% when 'price_increase' %>
      <div class="decision-context price-context">
        <h7>Price Increase Required:</h7>
        <p><strong>Additional $<%= refund.additional_cost %></strong> - Part cost increased since original order</p>
      </div>
    <% when 'compatible_alternative' %>
      <div class="decision-context alternative-context">
        <h7>Compatible Alternative Found:</h7>
        <p><strong><%= refund.alternative_part_name %></strong> - Upgrade/substitute part, same price</p>
      </div>
    <% end %>

    <!-- Customer Communication -->
    <%= form_with model: refund, url: update_resolution_notes_path(refund), 
                  method: :patch, local: false, class: "customer-form" do |f| %>
      <div class="agent-communication">
        <h7>Agent Notes from Customer Call:</h7>
        <%= f.text_area :agent_notes, 
                        placeholder: "Record customer's response to the alternative part and pricing, plus any additional conversation notes...",
                        class: "form-textarea",
                        rows: 5,
                        value: refund.agent_notes %>
      </div>

      <%= f.submit "Update Agent Notes", class: "btn btn-info", 
                   data: { disable_with: "Updating..." } %>
    <% end %>

    <!-- Agent Actions -->
    <div class="agent-actions">
      <h7>Contact Customer:</h7>
      <div class="contact-actions">
        <a href="tel:<%= refund.order.customer_phone %>" class="btn btn-primary">
          <i class="fas fa-phone"></i> Call Customer Now
        </a>
        <% if refund.order.customer_email.present? %>
          <a href="mailto:<%= refund.order.customer_email %>" class="btn btn-secondary">
            <i class="fas fa-envelope"></i> Send Email
          </a>
        <% end %>
      </div>
    </div>

    <!-- Customer Response Actions -->
    <div class="customer-decision-actions">
      <h7>Customer Response:</h7>
      
      <div class="decision-buttons">
        <% case refund.dispatcher_decision %>
        <% when 'delay_required' %>
          <%= button_to "Customer Accepts #{refund.delay_duration}-Day Delay", 
                        resolution_customer_approved_path(refund),
                        method: :patch,
                        class: "btn btn-success",
                        form: { data: { turbo: true } } %>
          <%= button_to "Customer Requests Refund Instead", 
                        resolution_customer_declined_path(refund),
                        method: :patch,
                        class: "btn btn-danger",
                        form: { data: { turbo: true } } %>
        <% when 'price_increase' %>
          <%= button_to "Customer Pays Extra $#{refund.additional_cost}", 
                        resolution_customer_approved_path(refund),
                        method: :patch,
                        class: "btn btn-success",
                        form: { data: { turbo: true } } %>
          <%= button_to "Customer Requests Refund Instead", 
                        resolution_customer_declined_path(refund),
                        method: :patch,
                        class: "btn btn-danger",
                        form: { data: { turbo: true } } %>
        <% when 'compatible_alternative' %>
          <%= button_to "Create Replacement with #{refund.alternative_part_name}", 
                        resolution_create_replacement_path(refund),
                        method: :post,
                        class: "btn btn-success",
                        form: { data: { turbo: true } } %>
          <div class="helper-text">Customer gets compatible upgrade at same price</div>
        <% else %>
          <%= button_to "Customer Approved", 
                        resolution_customer_approved_path(refund),
                        method: :patch,
                        class: "btn btn-success",
                        form: { data: { turbo: true } } %>
          <%= button_to "Customer Declined", 
                        resolution_customer_declined_path(refund),
                        method: :patch,
                        class: "btn btn-danger",
                        form: { data: { turbo: true } } %>
        <% end %>
      </div>
    </div>

    <!-- Current Agent Notes Display -->
    <% if refund.agent_notes.present? %>
      <div class="current-response">
        <div class="response-section">
          <span class="response-label">Agent Notes:</span>
          <div class="response-content"><%= simple_format(refund.agent_notes) %></div>
        </div>
      </div>
    <% end %>
  </div>
</div>