<div class="workflow-section resolution-completed">
  <div class="section-header">
    <h6><i class="fas fa-check-circle"></i> Resolution Completed</h6>
    <span class="section-description">This refund resolution has been completed</span>
  </div>

  <div class="workflow-content">
    <div class="completion-summary">
      <div class="completion-status">
        <i class="fas fa-check-circle text-success"></i>
        <span class="status-text">Resolution Process Complete</span>
      </div>
      
      <!-- Show Resolution Summary -->
      <div class="resolution-details">
        <% if refund.replacement_order_number.present? %>
          <div class="resolution-outcome">
            <h7>Outcome: Replacement Order Created</h7>
            <div class="outcome-details">
              <p>New order <strong><%= refund.replacement_order_number %></strong> has been created to replace the original order.</p>
            </div>
          </div>
        <% elsif refund.alternative_part_name.present? %>
          <div class="resolution-outcome">
            <h7>Outcome: Alternative Part Approved</h7>
            <div class="outcome-details">
              <p>Customer approved alternative part: <strong><%= refund.alternative_part_name %></strong></p>
              <% if refund.price_difference.present? && refund.price_difference != 0 %>
                <p>Price adjustment: <strong>
                  <%= refund.price_difference > 0 ? '+' : '' %>$<%= number_with_precision(refund.price_difference, precision: 2) %>
                </strong></p>
              <% end %>
            </div>
          </div>
        <% else %>
          <div class="resolution-outcome">
            <h7>Outcome: Standard Resolution</h7>
            <div class="outcome-details">
              <p>Resolution completed through standard process.</p>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Show Final Notes -->
      <div class="final-notes">
        <% if refund.agent_notes.present? %>
          <div class="note-section">
            <span class="note-label">Final Agent Notes:</span>
            <div class="note-content"><%= simple_format(refund.agent_notes) %></div>
          </div>
        <% end %>
        
        <% if refund.dispatcher_notes.present? %>
          <div class="note-section">
            <span class="note-label">Final Dispatcher Notes:</span>
            <div class="note-content"><%= simple_format(refund.dispatcher_notes) %></div>
          </div>
        <% end %>
        
      </div>

      <!-- Return Management for Original Order -->
      <% if refund.return_status.present? && !refund.return_status.in?(['no_return_required']) %>
        <div class="return-workflow-section">
          <div class="return-header">
            <h7><i class="fas fa-undo"></i> Return Process for Original Order</h7>
            <span class="return-status-badge status-<%= refund.return_status %>">
              <%= refund.return_status.humanize.gsub('_', ' ') %>
            </span>
          </div>
          
          <div class="return-actions-flow">
            <% if refund.return_status == 'return_authorized' %>
              <%= button_to "Generate Return Label", 
                            resolution_generate_return_label_path(refund),
                            method: :patch,
                            class: "btn btn-primary btn-sm",
                            params: { carrier: "FedEx", label_url: "https://example.com/label" },
                            form: { data: { turbo: true } } %>
              <div class="helper-text">
                <i class="fas fa-info-circle"></i>
                Customer needs return label to ship back original product
              </div>
              
            <% elsif refund.return_status == 'return_label_sent' %>
              <%= button_to "Customer Shipped Return", 
                            resolution_mark_return_shipped_path(refund),
                            method: :patch,
                            class: "btn btn-warning btn-sm",
                            params: { tracking_number: "" },
                            form: { data: { turbo: true } } %>
              <div class="helper-text">
                <i class="fas fa-shipping-fast"></i>
                Mark when customer ships back the original product
              </div>
              
            <% elsif refund.return_shipped? || refund.return_in_transit? || refund.return_delivered? %>
              <%= button_to "Return Received & Inspected", 
                            resolution_mark_return_received_path(refund),
                            method: :patch,
                            class: "btn btn-success btn-sm",
                            params: { condition_notes: "Original product returned in good condition" },
                            form: { data: { turbo: true } } %>
              <div class="helper-text">
                <i class="fas fa-search"></i>
                Mark when original product is received and inspected
              </div>
              
            <% elsif refund.return_received? || refund.return_inspected? %>
              <% if refund.refund_stage == 'processing_refund' %>
                <%= button_to "Complete Return Processing", 
                              resolution_complete_refund_path(refund),
                              method: :patch,
                              class: "btn btn-success btn-sm pulse",
                              confirm: "Complete return processing? This will finalize the return workflow.",
                              form: { data: { turbo: true } } %>
                <div class="helper-text success">
                  <i class="fas fa-check-circle"></i>
                  Original product returned. Ready to complete return processing.
                </div>
              <% else %>
                <div class="completion-message">
                  <i class="fas fa-check-double"></i>
                  Return process completed for original order.
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Completion Timestamp -->
      <div class="completion-timestamp">
        <small class="text-muted">
          <i class="fas fa-clock"></i>
          Completed <%= time_ago_in_words(refund.updated_at) %> ago
        </small>
      </div>
    </div>
  </div>
</div>