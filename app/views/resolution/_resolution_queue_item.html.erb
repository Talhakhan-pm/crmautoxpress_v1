<div class="resolution-item" id="refund_<%= refund.id %>">
  <div class="resolution-header">
    <div class="refund-info">
      <h4 class="refund-number">
        <%= link_to refund.refund_number, refund_path(refund), class: "refund-link" %>
      </h4>
      <p class="customer-name"><%= refund.customer_name %></p>
      <p class="order-reference">Order: <%= refund.order.order_number %></p>
    </div>
    <div class="resolution-status">
      <span class="badge badge-<%= refund.resolution_stage_color %>">
        <%= refund.resolution_stage.to_s.humanize %>
      </span>
      <span class="badge badge-<%= refund.priority_color %> priority">
        <%= refund.priority.humanize %>
      </span>
    </div>
  </div>

  <div class="resolution-details">
    <div class="financial-info">
      <span class="amount">$<%= number_with_precision(refund.refund_amount, precision: 2) %></span>
      <span class="reason"><%= refund.refund_reason.humanize %></span>
    </div>
    <div class="timing-info">
      <span class="created-time">
        <%= time_ago_in_words(refund.created_at) %> ago
      </span>
      <% if refund.created_at < 2.days.ago %>
        <span class="overdue-indicator">OVERDUE</span>
      <% end %>
    </div>
  </div>

  <!-- Replacement Order Tracking -->
  <% if refund.replacement_order_number.present? %>
    <div class="replacement-tracking">
      <div class="replacement-header">
        <i class="fas fa-exchange-alt"></i>
        <span>Replacement Order Created</span>
      </div>
      <div class="replacement-details">
        <div class="original-order">
          <span class="order-label">Original:</span>
          <span class="order-number"><%= refund.order.order_number %></span>
          <span class="badge badge-secondary">Cancelled</span>
        </div>
        <div class="replacement-order">
          <span class="order-label">Replacement:</span>
          <span class="order-number"><%= refund.replacement_order_number %></span>
          <% if refund.replacement_order.present? %>
            <span class="badge badge-<%= refund.replacement_order.status_color %>">
              <%= refund.replacement_order.order_status.humanize %>
            </span>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Stage-Specific Workflow Components -->
  <div class="resolution-workflow">
    <% case refund.resolution_stage %>
    <% when 'pending_customer_clarification' %>
      <%= render 'agent_clarification_section', refund: refund %>
    <% when 'pending_dispatch_decision' %>
      <%= render 'dispatcher_decision_section', refund: refund %>
    <% when 'resolution_completed' %>
      <%= render 'resolution_completed_section', refund: refund %>
    <% end %>
  </div>

  <div class="resolution-actions">
    <!-- Stage Toggle Buttons -->
    <div class="stage-toggle-buttons">
      <% if refund.resolution_stage == 'pending_dispatch_decision' %>
        <%= button_to resolution_move_to_agent_review_path(refund),
                      method: :patch,
                      class: "btn btn-sm btn-warning",
                      title: "Move to Agent Review",
                      form: { data: { turbo: true } } do %>
          <i class="fas fa-phone"></i> → Agent Review
        <% end %>
      <% elsif refund.resolution_stage == 'pending_customer_clarification' %>
        <%= button_to resolution_move_to_dispatcher_review_path(refund),
                      method: :patch,
                      class: "btn btn-sm btn-info",
                      title: "Move to Dispatcher Review",
                      form: { data: { turbo: true } } do %>
          <i class="fas fa-clipboard-check"></i> → Dispatcher Review
        <% end %>
      <% end %>
    </div>
    
    <div class="secondary-actions">
      <%= link_to refund_path(refund), class: "btn btn-outline-primary" do %>
        <i class="fas fa-eye"></i> View Details
      <% end %>
      <% if refund.order.present? %>
        <%= link_to order_path(refund.order), class: "btn btn-outline-secondary" do %>
          <i class="fas fa-box"></i> View Order
        <% end %>
      <% end %>
    </div>
  </div>
</div>