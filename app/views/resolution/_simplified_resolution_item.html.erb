<div class="resolution-item amazing" 
     id="refund_<%= refund.id %>"
     data-stage="<%= refund.resolution_stage %>"
     data-priority="<%= refund.priority || 'standard' %>"
     data-age="<%= (Time.current - refund.created_at).to_i / 3600 %>">
  
  <!-- Smart Header with Context -->
  <div class="resolution-header-amazing">
    <div class="primary-info">
      <div class="refund-identity">
        <h3 class="refund-number">
          <%= link_to refund.refund_number, refund_path(refund), class: "refund-link" %>
          <span class="urgency-indicator urgency-<%= refund.priority || 'standard' %>">
            <% case refund.priority || 'standard' %>
            <% when 'urgent' %>
              <i class="fas fa-bolt"></i>
            <% when 'high' %>
              <i class="fas fa-exclamation-triangle"></i>
            <% else %>
              <i class="fas fa-circle"></i>
            <% end %>
          </span>
        </h3>
        <div class="financial-impact">
          <span class="amount">$<%= number_with_precision(refund.refund_amount, precision: 2) %></span>
          <span class="customer-name"><%= refund.customer_name %></span>
        </div>
      </div>
      
      <!-- Smart Contextual Info -->
      <div class="context-panel">
        <div class="context-item">
          <i class="fas fa-shopping-cart"></i>
          <span>Order <%= refund.order.order_number %></span>
        </div>
        <div class="context-item">
          <i class="fas fa-tag"></i>
          <span><%= refund.refund_reason.humanize %></span>
        </div>
        <% if refund.order.dispatch&.cancelled? %>
          <div class="context-item trigger-info">
            <i class="fas fa-truck"></i>
            <span>Triggered by dispatch cancellation</span>
          </div>
        <% end %>
        <div class="context-item timing">
          <i class="fas fa-clock"></i>
          <span><%= time_ago_in_words(refund.created_at) %> ago</span>
          <% if (Time.current - refund.created_at) > 24.hours %>
            <span class="overdue-tag">OVERDUE</span>
          <% end %>
        </div>
      </div>
    </div>
    
    <!-- Intelligent Progress Tracker -->
    <div class="progress-tracker-amazing">
      <div class="progress-line">
        <% stages = [
          { key: 'pending_customer_clarification', label: 'Agent', icon: 'phone', color: '#f59e0b' },
          { key: 'pending_dispatch_decision', label: 'Dispatch', icon: 'search', color: '#3b82f6' },
          { key: 'pending_customer_approval', label: 'Customer', icon: 'clock', color: '#8b5cf6' },
          { key: 'resolution_completed', label: 'Complete', icon: 'check', color: '#10b981' }
        ] %>
        
        <% stages.each_with_index do |stage, index| %>
          <% 
            current_stage_index = stages.find_index { |s| s[:key] == refund.resolution_stage }
            is_completed = index < current_stage_index
            is_current = index == current_stage_index
            is_future = index > current_stage_index
          %>
          
          <div class="progress-step <%= 'completed' if is_completed %> <%= 'current' if is_current %> <%= 'future' if is_future %>">
            <div class="step-connector"></div>
            <div class="step-circle" style="--step-color: <%= stage[:color] %>">
              <i class="fas fa-<%= stage[:icon] %>"></i>
            </div>
            <div class="step-info">
              <span class="step-label"><%= stage[:label] %></span>
              <% if is_current %>
                <span class="step-status">Active</span>
              <% elsif is_completed %>
                <span class="step-status">Done</span>
              <% else %>
                <span class="step-status">Pending</span>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Intelligent Action Center -->
  <div class="action-center-amazing">
    <% case refund.resolution_stage %>
    <% when 'pending_customer_clarification' %>
      <div class="action-card agent-action">
        <div class="action-header">
          <div class="action-icon">
            <i class="fas fa-phone"></i>
          </div>
          <div class="action-title">
            <h4>Contact Customer</h4>
            <p>Verify details and understand the issue</p>
          </div>
          <div class="action-urgency">
            <span class="urgency-badge urgency-high">High Priority</span>
          </div>
        </div>
        
        <div class="action-details">
          <div class="customer-contact-card">
            <div class="contact-info">
              <strong><%= refund.order.customer_name %></strong>
              <div class="contact-methods">
                <a href="tel:<%= refund.order.customer_phone %>" class="contact-method phone">
                  <i class="fas fa-phone"></i>
                  <%= refund.order.customer_phone %>
                </a>
                <% if refund.order.customer_email.present? %>
                  <a href="mailto:<%= refund.order.customer_email %>" class="contact-method email">
                    <i class="fas fa-envelope"></i>
                    <%= refund.order.customer_email %>
                  </a>
                <% end %>
              </div>
            </div>
            <div class="suggested-questions">
              <h6>Suggested Questions:</h6>
              <ul>
                <li>Can you confirm your shipping address?</li>
                <li>What specific issue occurred with the part?</li>
                <li>Do you have photos of the problem?</li>
                <li>When did you first notice the issue?</li>
              </ul>
            </div>
          </div>
        </div>
        
        <div class="action-controls">
          <button class="action-btn primary" onclick="openResolutionHub(<%= refund.id %>, '<%= refund.resolution_stage %>')">
            <i class="fas fa-comments"></i>
            Start Communication
          </button>
          <%= button_to "Mark as Contacted", 
                        update_resolution_stage_path(refund),
                        method: :patch,
                        params: { refund: { resolution_stage: 'pending_dispatch_decision' } },
                        class: "action-btn success",
                        form: { data: { turbo: true } } %>
        </div>
      </div>
      
    <% when 'pending_dispatch_decision' %>
      <div class="action-card dispatcher-action">
        <div class="action-header">
          <div class="action-icon">
            <i class="fas fa-search"></i>
          </div>
          <div class="action-title">
            <h4>Part Sourcing Research</h4>
            <p>Research suppliers and make business decision</p>
          </div>
          <div class="action-urgency">
            <span class="urgency-badge urgency-medium">Dispatcher Decision</span>
          </div>
        </div>
        
        <div class="action-details">
          <div class="sourcing-workspace">
            <div class="product-research">
              <div class="product-summary">
                <strong>Original Order:</strong> <%= refund.order.product_name %><br>
                <strong>Customer Paid:</strong> $<%= number_with_precision(refund.order.total_amount, precision: 2) %><br>
                <% if refund.order.vehicle_info.present? %>
                  <strong>Vehicle:</strong> <%= refund.order.vehicle_info %><br>
                <% end %>
                <strong>Issue:</strong> <%= refund.refund_reason.humanize %>
              </div>
              
              <% if refund.agent_notes.present? %>
                <div class="agent-findings">
                  <h6>Agent Investigation:</h6>
                  <div class="findings-box"><%= simple_format(refund.agent_notes) %></div>
                </div>
              <% end %>
            </div>
            
            <div class="sourcing-simulation">
              <div class="sourcing-header">
                <i class="fas fa-industry"></i>
                <span>Supplier Research Results</span>
              </div>
              <div class="simulated-results">
                <div class="supplier-option">
                  <div class="supplier-name">Primary Supplier</div>
                  <div class="supplier-details">$<%= (refund.order.total_amount * 0.6).round(2) %> • 2-3 days • ⭐⭐⭐⭐</div>
                  <div class="profit-calc">Profit: $<%= (refund.order.total_amount * 0.4).round(2) %></div>
                </div>
                <div class="supplier-option">
                  <div class="supplier-name">Secondary Supplier</div>
                  <div class="supplier-details">$<%= (refund.order.total_amount * 0.7).round(2) %> • 5-7 days • ⭐⭐⭐</div>
                  <div class="profit-calc">Profit: $<%= (refund.order.total_amount * 0.3).round(2) %></div>
                </div>
                <div class="supplier-option disabled">
                  <div class="supplier-name">Alternative Supplier</div>
                  <div class="supplier-details">$<%= (refund.order.total_amount * 1.2).round(2) %> • 3 days • ⭐⭐⭐⭐⭐</div>
                  <div class="profit-calc loss">Loss: $<%= (refund.order.total_amount * 0.2).round(2) %></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="action-controls dispatcher-decisions">
          <div class="decision-title">Dispatcher Decision:</div>
          
          <!-- Sourcing Options -->
          <div class="decision-section">
            <div class="section-label">Part Sourcing Options</div>
            <div class="decision-grid">
              <button class="decision-btn accept-delay" 
                      onclick="openDelayModal(<%= refund.id %>)"
                      data-refund-id="<%= refund.id %>">
                <i class="fas fa-clock"></i>
                <span class="btn-title">Source with Delay</span>
                <span class="btn-desc">Part available but requires extra time</span>
              </button>
              
              <button class="decision-btn price-increase"
                      onclick="openPriceModal(<%= refund.id %>)"
                      data-refund-id="<%= refund.id %>">
                <i class="fas fa-dollar-sign"></i>
                <span class="btn-title">Source at Higher Cost</span>
                <span class="btn-desc">Part available but costs more than original</span>
              </button>
              
              <button class="decision-btn compatible-alternative"
                      onclick="openAlternativeModal(<%= refund.id %>)"
                      data-refund-id="<%= refund.id %>">
                <i class="fas fa-exchange-alt"></i>
                <span class="btn-title">Use Compatible Alternative</span>
                <span class="btn-desc">Found substitute part that works</span>
              </button>
            </div>
          </div>

          <!-- Return Management Options -->
          <% if refund.refund_reason.in?(['wrong_product', 'defective_product', 'quality_issues', 'customer_changed_mind']) %>
            <div class="decision-section return-section">
              <div class="section-label">
                <i class="fas fa-undo"></i>
                Return Management Options
                <small>Customer needs to return product first</small>
              </div>
              <div class="decision-grid">
                <%= button_to resolution_authorize_return_and_refund_path(refund),
                              method: :patch,
                              class: "decision-btn return-refund-option",
                              confirm: "Authorize return and full refund? Customer must return product first.",
                              form: { data: { turbo: true } } do %>
                  <i class="fas fa-undo"></i>
                  <span class="btn-title">Return + Refund</span>
                  <span class="btn-desc">Customer returns, gets full refund</span>
                <% end %>
                
                <%= button_to resolution_authorize_return_and_replacement_path(refund),
                              method: :patch,
                              class: "decision-btn return-replacement-option",
                              confirm: "Authorize return and replacement? Will ship new item after return received.",
                              form: { data: { turbo: true } } do %>
                  <i class="fas fa-sync-alt"></i>
                  <span class="btn-title">Return + Replace</span>
                  <span class="btn-desc">Customer returns, gets replacement</span>
                <% end %>
              </div>
            </div>
          <% end %>
          
          <!-- Final Resolution -->
          <div class="decision-section final-section">
            <div class="section-label">Final Resolution</div>
            <div class="decision-grid">
              <%= button_to resolution_dispatcher_refund_path(refund),
                            method: :patch,
                            params: { refund_reason: 'Not economical to source' },
                            class: "decision-btn refund-option",
                            confirm: "Process immediate refund? This cannot be undone.",
                            form: { data: { turbo: true } } do %>
                <i class="fas fa-money-bill-wave"></i>
                <span class="btn-title">Immediate Refund</span>
                <span class="btn-desc">Cannot source part economically</span>
              <% end %>
            </div>
          </div>
        </div>
      </div>
      
    <% when 'pending_customer_approval' %>
      <div class="action-card agent-task">
        <div class="action-header">
          <div class="action-icon">
            <i class="fas fa-headset"></i>
          </div>
          <div class="action-title">
            <h4>Agent Task from Dispatcher</h4>
            <p>Contact customer with specific instructions</p>
          </div>
          <div class="action-urgency">
            <span class="urgency-badge urgency-high">Agent Action Required</span>
          </div>
        </div>
        
        <div class="action-details">
          <div class="dispatcher-instructions">
            <div class="instructions-header">
              <i class="fas fa-clipboard-list"></i>
              <span>Instructions from Dispatcher:</span>
            </div>
            <div class="instructions-content">
              <%= refund.agent_instructions.present? ? simple_format(refund.agent_instructions) : "Contact customer for approval" %>
            </div>
          </div>
          
          <div class="customer-contact">
            <div class="contact-info">
              <strong>Customer:</strong> <%= refund.order.customer_name %><br>
              <strong>Phone:</strong> <%= refund.order.customer_phone %><br>
              <% if refund.order.customer_email.present? %>
                <strong>Email:</strong> <%= refund.order.customer_email %><br>
              <% end %>
            </div>
          </div>
          
          <% case refund.dispatcher_decision %>
          <% when 'delay_required' %>
            <div class="decision-context delay-context">
              <h6>Delay Information:</h6>
              <p><strong><%= refund.delay_duration %> day delay</strong> - Part sourced successfully but delivery timing affected</p>
            </div>
          <% when 'price_increase' %>
            <div class="decision-context price-context">
              <h6>Price Increase Required:</h6>
              <p><strong>Additional $<%= refund.additional_cost %></strong> - Part cost increased since original order</p>
            </div>
          <% when 'compatible_alternative' %>
            <div class="decision-context alternative-context">
              <h6>Compatible Alternative Found:</h6>
              <p><strong><%= refund.alternative_part_name %></strong> - Upgrade/substitute part, same price</p>
            </div>
          <% when 'authorize_return_and_refund' %>
            <div class="decision-context return-context">
              <h6>Return and Refund Authorized:</h6>
              <p><strong>Customer must return product first</strong> - Full refund processed after return received</p>
              <% if refund.return_status.present? %>
                <div class="return-status-display">
                  <span class="return-status-badge status-<%= refund.return_status %>">
                    <%= refund.return_status.humanize.gsub('_', ' ') %>
                  </span>
                </div>
              <% end %>
            </div>
          <% when 'authorize_return_and_replacement' %>
            <div class="decision-context return-context">
              <h6>Return and Replacement Authorized:</h6>
              <p><strong>Customer returns defective product</strong> - New replacement shipped after return received</p>
              <% if refund.return_status.present? %>
                <div class="return-status-display">
                  <span class="return-status-badge status-<%= refund.return_status %>">
                    <%= refund.return_status.humanize.gsub('_', ' ') %>
                  </span>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
        
        <div class="action-controls agent-actions">
          <div class="contact-actions">
            <a href="tel:<%= refund.order.customer_phone %>" class="action-btn primary">
              <i class="fas fa-phone"></i>
              Call Customer Now
            </a>
            <% if refund.order.customer_email.present? %>
              <a href="mailto:<%= refund.order.customer_email %>" class="action-btn secondary">
                <i class="fas fa-envelope"></i>
                Send Email
              </a>
            <% end %>
          </div>
          
          <div class="response-actions">
            <% case refund.dispatcher_decision %>
            <% when 'delay_required' %>
              <%= button_to "Customer Accepts Delay", 
                            resolution_customer_approved_path(refund),
                            method: :patch,
                            class: "action-btn success",
                            form: { data: { turbo: true } } %>
              <%= button_to "Customer Wants Refund", 
                            resolution_customer_declined_path(refund),
                            method: :patch,
                            class: "action-btn danger",
                            form: { data: { turbo: true } } %>
            <% when 'price_increase' %>
              <%= button_to "Customer Pays Extra", 
                            resolution_customer_approved_path(refund),
                            method: :patch,
                            class: "action-btn success",
                            form: { data: { turbo: true } } %>
              <%= button_to "Customer Declines", 
                            resolution_customer_declined_path(refund),
                            method: :patch,
                            class: "action-btn danger",
                            form: { data: { turbo: true } } %>
            <% when 'compatible_alternative' %>
              <%= button_to "Create Replacement Order", 
                            resolution_create_replacement_path(refund),
                            method: :post,
                            class: "action-btn success",
                            form: { data: { turbo: true } } %>
              <div class="helper-text">Customer automatically gets upgraded part</div>
            <% when 'authorize_return_and_refund', 'authorize_return_and_replacement' %>
              <div class="return-management-actions">
                <% if refund.return_status == 'return_requested' %>
                  <%= button_to "Generate Return Label", 
                                resolution_generate_return_label_path(refund),
                                method: :patch,
                                class: "action-btn primary",
                                params: { carrier: "FedEx", label_url: "https://example.com/label" },
                                form: { data: { turbo: true } } %>
                <% elsif refund.return_status == 'return_label_sent' %>
                  <%= button_to "Customer Shipped Return", 
                                resolution_mark_return_shipped_path(refund),
                                method: :patch,
                                class: "action-btn warning",
                                params: { tracking_number: "" },
                                form: { data: { turbo: true } } %>
                <% elsif refund.return_shipped? || refund.return_in_transit? || refund.return_delivered? %>
                  <%= button_to "Return Received & Inspected", 
                                resolution_mark_return_received_path(refund),
                                method: :patch,
                                class: "action-btn success",
                                params: { condition_notes: "Product received in good condition" },
                                form: { data: { turbo: true } } %>
                <% elsif refund.return_received? || refund.return_inspected? %>
                  <div class="completion-message">
                    <i class="fas fa-check-circle"></i>
                    Return process completed. Refund will be processed automatically.
                  </div>
                <% end %>
              </div>
            <% else %>
              <%= button_to "Customer Approved", 
                            resolution_customer_approved_path(refund),
                            method: :patch,
                            class: "action-btn success",
                            form: { data: { turbo: true } } %>
              <%= button_to "Customer Declined", 
                            resolution_customer_declined_path(refund),
                            method: :patch,
                            class: "action-btn danger",
                            form: { data: { turbo: true } } %>
            <% end %>
          </div>
        </div>
      </div>
      
    <% when 'resolution_completed' %>
      <div class="action-card completed-action">
        <div class="action-header">
          <div class="action-icon success">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="action-title">
            <h4>Resolution Complete</h4>
            <p>Case has been successfully resolved</p>
          </div>
          <div class="completion-time">
            <span class="time-badge">
              Completed <%= time_ago_in_words(refund.updated_at) %> ago
            </span>
          </div>
        </div>
        
        <div class="action-details">
          <div class="resolution-summary">
            <% if refund.replacement_order_number.present? %>
              <div class="outcome-card">
                <i class="fas fa-box"></i>
                <span>Replacement order created: <%= refund.replacement_order_number %></span>
              </div>
            <% elsif refund.alternative_part_name.present? %>
              <div class="outcome-card">
                <i class="fas fa-exchange-alt"></i>
                <span>Alternative part approved: <%= refund.alternative_part_name %></span>
              </div>
            <% else %>
              <div class="outcome-card">
                <i class="fas fa-dollar-sign"></i>
                <span>Refund processed: $<%= refund.refund_amount %></span>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Smart Footer with Insights -->
  <div class="resolution-footer-amazing">
    <div class="footer-insights">
      <div class="insight-item">
        <i class="fas fa-history"></i>
        <span class="insight-label">Created:</span>
        <span class="insight-value"><%= refund.created_at.strftime("%b %d, %I:%M %p") %></span>
      </div>
      <% if refund.agent_notes.present? || refund.dispatcher_notes.present? %>
        <div class="insight-item">
          <i class="fas fa-sticky-note"></i>
          <span class="insight-label">Notes:</span>
          <span class="insight-value">
            <%= (refund.agent_notes.present? ? 1 : 0) + (refund.dispatcher_notes.present? ? 1 : 0) %> entries
          </span>
        </div>
      <% end %>
      <% if refund.replacement_order_number.present? %>
        <div class="insight-item">
          <i class="fas fa-link"></i>
          <span class="insight-label">Replacement:</span>
          <span class="insight-value"><%= refund.replacement_order_number %></span>
        </div>
      <% end %>
    </div>
    
    <div class="footer-actions">
      <button class="footer-btn" onclick="openResolutionHub(<%= refund.id %>, '<%= refund.resolution_stage %>')">
        <i class="fas fa-comments"></i>
        Open Chat
      </button>
      <%= link_to refund_path(refund), class: "footer-btn secondary" do %>
        <i class="fas fa-external-link-alt"></i>
        Full Details
      <% end %>
    </div>
  </div>
</div>