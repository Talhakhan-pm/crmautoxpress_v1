<div class="resolution-item amazing" 
     id="refund_<%= refund.id %>"
     data-stage="<%= refund.resolution_stage %>"
     data-priority="<%= refund.priority || 'standard' %>"
     data-age="<%= (Time.current - refund.created_at).to_i / 3600 %>">
  
  <!-- Smart Header with Context -->
  <div class="resolution-header-amazing">
    <div class="primary-info">
      <div class="refund-identity">
        <h3 class="refund-number">
          <%= link_to refund.refund_number, refund_path(refund), class: "refund-link" %>
          <span class="urgency-indicator urgency-<%= refund.priority || 'standard' %>">
            <% case refund.priority || 'standard' %>
            <% when 'urgent' %>
              <i class="fas fa-bolt"></i>
            <% when 'high' %>
              <i class="fas fa-exclamation-triangle"></i>
            <% else %>
              <i class="fas fa-circle"></i>
            <% end %>
          </span>
        </h3>
        <div class="financial-impact">
          <span class="amount">$<%= number_with_precision(refund.refund_amount, precision: 2) %></span>
          <span class="customer-name"><%= refund.customer_name %></span>
        </div>
      </div>
      
      <!-- Smart Contextual Info -->
      <div class="context-panel">
        <div class="context-item">
          <i class="fas fa-shopping-cart"></i>
          <span>Order <%= refund.order.order_number %></span>
        </div>
        <div class="context-item">
          <i class="fas fa-tag"></i>
          <span><%= refund.refund_reason.humanize %></span>
        </div>
        <% if refund.order.dispatch&.cancelled? %>
          <div class="context-item trigger-info">
            <i class="fas fa-truck"></i>
            <span>Triggered by dispatch cancellation</span>
          </div>
        <% end %>
        <div class="context-item timing">
          <i class="fas fa-clock"></i>
          <span><%= time_ago_in_words(refund.created_at) %> ago</span>
          <% if (Time.current - refund.created_at) > 24.hours %>
            <span class="overdue-tag">OVERDUE</span>
          <% end %>
        </div>
      </div>
    </div>
    
    <!-- Intelligent Progress Tracker -->
    <div class="progress-tracker-amazing">
      <div class="progress-line">
        <% stages = [
          { key: 'pending_customer_clarification', label: 'Agent', icon: 'phone', color: '#f59e0b' },
          { key: 'pending_dispatch_decision', label: 'Dispatch', icon: 'search', color: '#3b82f6' },
          { key: 'resolution_completed', label: 'Complete', icon: 'check', color: '#10b981' }
        ] %>
        
        <% stages.each_with_index do |stage, index| %>
          <% 
            current_stage_index = stages.find_index { |s| s[:key] == refund.resolution_stage }
            is_completed = index < current_stage_index
            is_current = index == current_stage_index
            is_future = index > current_stage_index
          %>
          
          <div class="progress-step <%= 'completed' if is_completed %> <%= 'current' if is_current %> <%= 'future' if is_future %>">
            <div class="step-connector"></div>
            <div class="step-circle" style="--step-color: <%= stage[:color] %>">
              <i class="fas fa-<%= stage[:icon] %>"></i>
            </div>
            <div class="step-info">
              <span class="step-label"><%= stage[:label] %></span>
              <% if is_current %>
                <span class="step-status">Active</span>
              <% elsif is_completed %>
                <span class="step-status">Done</span>
              <% else %>
                <span class="step-status">Pending</span>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Intelligent Action Center -->
  <div class="action-center-amazing">
    <% case refund.resolution_stage %>
    <% when 'pending_customer_clarification' %>
      <div class="action-card agent-action">
        <div class="action-header">
          <div class="action-icon">
            <i class="fas fa-phone"></i>
          </div>
          <div class="action-title">
            <h4>Contact Customer</h4>
            <p>Verify details and understand the issue</p>
          </div>
          <div class="action-urgency">
            <span class="urgency-badge urgency-high">High Priority</span>
          </div>
        </div>
        
        <div class="action-details">
          <div class="customer-contact-card">
            <div class="contact-info">
              <strong><%= refund.order.customer_name %></strong>
              <div class="contact-methods">
                <a href="tel:<%= refund.order.customer_phone %>" class="contact-method phone">
                  <i class="fas fa-phone"></i>
                  <%= refund.order.customer_phone %>
                </a>
                <% if refund.order.customer_email.present? %>
                  <a href="mailto:<%= refund.order.customer_email %>" class="contact-method email">
                    <i class="fas fa-envelope"></i>
                    <%= refund.order.customer_email %>
                  </a>
                <% end %>
              </div>
            </div>
            <div class="suggested-questions">
              <h6>Suggested Questions:</h6>
              <ul>
                <li>Can you confirm your shipping address?</li>
                <li>What specific issue occurred with the part?</li>
                <li>Do you have photos of the problem?</li>
                <li>When did you first notice the issue?</li>
              </ul>
            </div>
          </div>
        </div>
        
        <div class="action-controls">
          <!-- Contextual Agent Actions Based on Refund Reason -->
          <% case refund.refund_reason %>
          <% when 'shipping_delay' %>
            <!-- Agent presents delay options to customer -->
            <div class="agent-decision-section">
              <div class="section-label">Present Options to Customer</div>
              <div class="decision-grid">
                <%= button_to resolution_accept_delay_path(refund),
                              method: :patch,
                              params: { delay_days: 5 },
                              class: "decision-btn accept-delay",
                              confirm: "Customer accepts 5-day delay?",
                              form: { data: { turbo: true } } do %>
                  <i class="fas fa-check"></i>
                  <span class="btn-title">Customer Accepts Delay</span>
                  <span class="btn-desc">Proceed with 5-day extended timeline</span>
                <% end %>
                
                <%= button_to resolution_dispatcher_refund_path(refund),
                              method: :patch,
                              params: { refund_reason: 'Customer declined shipping delay' },
                              class: "decision-btn refund-option",
                              confirm: "Customer wants refund instead?",
                              form: { data: { turbo: true } } do %>
                  <i class="fas fa-money-bill-wave"></i>
                  <span class="btn-title">Customer Wants Refund</span>
                  <span class="btn-desc">Customer declined the delay option</span>
                <% end %>
              </div>
            </div>
          
          <% when 'item_not_found' %>
            <!-- Agent presents sourcing options to customer -->
            <div class="agent-decision-section">
              <div class="section-label">Present Options to Customer</div>
              <div class="decision-grid">
                <%= button_to resolution_accept_delay_path(refund),
                              method: :patch,
                              params: { delay_days: 7 },
                              class: "decision-btn accept-delay",
                              confirm: "Customer accepts 7-day delay for sourcing?",
                              form: { data: { turbo: true } } do %>
                  <i class="fas fa-clock"></i>
                  <span class="btn-title">Customer Accepts Delay</span>
                  <span class="btn-desc">7-day delay for sourcing</span>
                <% end %>
                
                <%= button_to resolution_request_price_increase_path(refund),
                              method: :patch,
                              params: { additional_amount: 50 },
                              class: "decision-btn price-increase",
                              confirm: "Customer pays additional $50?",
                              form: { data: { turbo: true } } do %>
                  <i class="fas fa-dollar-sign"></i>
                  <span class="btn-title">Customer Pays Extra</span>
                  <span class="btn-desc">Additional $50 for higher cost</span>
                <% end %>
                
                <%= button_to resolution_dispatcher_refund_path(refund),
                              method: :patch,
                              params: { refund_reason: 'Customer declined sourcing options' },
                              class: "decision-btn refund-option",
                              confirm: "Customer wants refund instead?",
                              form: { data: { turbo: true } } do %>
                  <i class="fas fa-money-bill-wave"></i>
                  <span class="btn-title">Customer Wants Refund</span>
                  <span class="btn-desc">Customer declined all options</span>
                <% end %>
              </div>
            </div>
          
          <% else %>
            <!-- Default agent actions for other reasons -->
            <button class="action-btn primary" onclick="openResolutionHub(<%= refund.id %>, '<%= refund.resolution_stage %>')">
              <i class="fas fa-comments"></i>
              Start Communication
            </button>
            <%= button_to "Mark as Contacted", 
                          update_resolution_stage_path(refund),
                          method: :patch,
                          params: { refund: { resolution_stage: 'pending_dispatch_decision' } },
                          class: "action-btn success",
                          form: { data: { turbo: true } } %>
          <% end %>
        </div>
      </div>
      
    <% when 'pending_dispatch_decision' %>
      <div class="action-card dispatcher-action">
        <div class="action-header">
          <div class="action-icon">
            <i class="fas fa-search"></i>
          </div>
          <div class="action-title">
            <h4>Part Sourcing Research</h4>
            <p>Research suppliers and make business decision</p>
          </div>
          <div class="action-urgency">
            <span class="urgency-badge urgency-medium">Dispatcher Decision</span>
          </div>
        </div>
        
        <div class="action-details">
          <div class="sourcing-workspace">
            <div class="product-research">
              <div class="product-summary">
                <strong>Original Order:</strong> <%= refund.order.product_name %><br>
                <strong>Customer Paid:</strong> $<%= number_with_precision(refund.order.total_amount, precision: 2) %><br>
                <% if refund.order.vehicle_info.present? %>
                  <strong>Vehicle:</strong> <%= refund.order.vehicle_info %><br>
                <% end %>
                <strong>Issue:</strong> <%= refund.refund_reason.humanize %>
              </div>
              
              <% if refund.agent_notes.present? %>
                <div class="agent-findings">
                  <h6>Agent Investigation:</h6>
                  <div class="findings-box"><%= simple_format(refund.agent_notes) %></div>
                </div>
              <% end %>
            </div>
            
          </div>
        </div>
        
        <div class="action-controls dispatcher-decisions">
          <div class="decision-title">Dispatcher Decision:</div>
          
          <!-- Contextual Decisions Based on Refund Reason -->
          <% case refund.refund_reason %>
          <% when 'wrong_product', 'defective_product', 'quality_issues' %>
            <!-- Return Management Options for product issues -->
            <div class="decision-section return-section">
              <div class="section-label">
                <i class="fas fa-undo"></i>
                Return Management Options
                <small>Customer needs to return product first</small>
              </div>
              <div class="decision-grid">
                <%= button_to resolution_authorize_return_and_refund_path(refund),
                              method: :patch,
                              class: "decision-btn return-refund-option",
                              confirm: "Authorize return and full refund? Customer must return product first.",
                              form: { data: { turbo: true } } do %>
                  <i class="fas fa-undo"></i>
                  <span class="btn-title">Return + Refund</span>
                  <span class="btn-desc">Customer returns, gets full refund</span>
                <% end %>
                
                <%= button_to resolution_authorize_return_and_replacement_path(refund),
                              method: :patch,
                              class: "decision-btn return-replacement-option",
                              confirm: "Authorize return and replacement? Will ship new item after return received.",
                              form: { data: { turbo: true } } do %>
                  <i class="fas fa-sync-alt"></i>
                  <span class="btn-title">Return + Replace</span>
                  <span class="btn-desc">Customer returns, gets replacement</span>
                <% end %>
              </div>
            </div>

          <% when 'customer_changed_mind' %>
            <!-- Simple refund for customer mind change -->
            <div class="decision-section final-section">
              <div class="section-label">Customer Changed Mind</div>
              <div class="decision-grid">
                <%= button_to resolution_dispatcher_refund_path(refund),
                              method: :patch,
                              params: { refund_reason: 'Customer changed mind' },
                              class: "decision-btn refund-option",
                              confirm: "Process immediate refund? This cannot be undone.",
                              form: { data: { turbo: true } } do %>
                  <i class="fas fa-money-bill-wave"></i>
                  <span class="btn-title">Issue Immediate Refund</span>
                  <span class="btn-desc">Customer no longer wants item</span>
                <% end %>
              </div>
            </div>

          <% when 'supplier_issue' %>
            <!-- Simple refund for supplier issues -->
            <div class="decision-section final-section">
              <div class="section-label">Supplier Issue</div>
              <div class="decision-grid">
                <%= button_to resolution_dispatcher_refund_path(refund),
                              method: :patch,
                              params: { refund_reason: 'Item unavailable from supplier' },
                              class: "decision-btn refund-option",
                              confirm: "Process immediate refund? This cannot be undone.",
                              form: { data: { turbo: true } } do %>
                  <i class="fas fa-money-bill-wave"></i>
                  <span class="btn-title">Issue Immediate Refund</span>
                  <span class="btn-desc">Cannot source from supplier</span>
                <% end %>
              </div>
            </div>

          <% when 'shipping_delay' %>
            <!-- Agent already contacted customer, dispatcher processes result -->
            <div class="decision-section">
              <div class="section-label">Shipping Delay Resolution</div>
              <div class="decision-grid">
                <%= button_to resolution_accept_delay_path(refund),
                              method: :patch,
                              params: { delay_days: 5 },
                              class: "decision-btn accept-delay",
                              confirm: "Customer accepts delay? Order will proceed with extended timeline.",
                              form: { data: { turbo: true } } do %>
                  <i class="fas fa-check"></i>
                  <span class="btn-title">Customer Accepts Delay</span>
                  <span class="btn-desc">Proceed with extended timeline</span>
                <% end %>
                
                <%= button_to resolution_dispatcher_refund_path(refund),
                              method: :patch,
                              params: { refund_reason: 'Customer declined shipping delay' },
                              class: "decision-btn refund-option",
                              confirm: "Customer wants refund instead of delay?",
                              form: { data: { turbo: true } } do %>
                  <i class="fas fa-money-bill-wave"></i>
                  <span class="btn-title">Customer Wants Refund</span>
                  <span class="btn-desc">Customer declined delay</span>
                <% end %>
              </div>
            </div>

          <% when 'item_not_found' %>
            <!-- Sourcing decisions for unavailable items -->
            <div class="decision-section">
              <div class="section-label">Item Sourcing Options</div>
              <div class="decision-grid">
                <%= button_to resolution_accept_delay_path(refund),
                              method: :patch,
                              params: { delay_days: 7 },
                              class: "decision-btn accept-delay",
                              confirm: "Source with delay? Customer will be contacted about extended timeline.",
                              form: { data: { turbo: true } } do %>
                  <i class="fas fa-clock"></i>
                  <span class="btn-title">Source with Delay</span>
                  <span class="btn-desc">Found item, requires 7+ days</span>
                <% end %>
                
                <%= button_to resolution_request_price_increase_path(refund),
                              method: :patch,
                              params: { additional_amount: 50 },
                              class: "decision-btn price-increase",
                              confirm: "Request price increase? Customer will be contacted about additional cost.",
                              form: { data: { turbo: true } } do %>
                  <i class="fas fa-dollar-sign"></i>
                  <span class="btn-title">Source at Higher Cost</span>
                  <span class="btn-desc">Item costs more than original</span>
                <% end %>
                
                <%= button_to resolution_send_compatible_alternative_path(refund),
                              method: :patch,
                              params: { alternative_part_name: 'Compatible upgrade' },
                              class: "decision-btn compatible-alternative",
                              confirm: "Send compatible alternative? Customer gets upgraded part at same price.",
                              form: { data: { turbo: true } } do %>
                  <i class="fas fa-exchange-alt"></i>
                  <span class="btn-title">Compatible Alternative</span>
                  <span class="btn-desc">Send upgraded/substitute part</span>
                <% end %>
                
                <%= button_to resolution_dispatcher_refund_path(refund),
                              method: :patch,
                              params: { refund_reason: 'Item not economical to source' },
                              class: "decision-btn refund-option",
                              confirm: "Process immediate refund? This cannot be undone.",
                              form: { data: { turbo: true } } do %>
                  <i class="fas fa-money-bill-wave"></i>
                  <span class="btn-title">Immediate Refund</span>
                  <span class="btn-desc">Cannot source economically</span>
                <% end %>
              </div>
            </div>

          <% else %>
            <!-- Fallback for other reasons -->
            <div class="decision-section final-section">
              <div class="section-label">General Resolution</div>
              <div class="decision-grid">
                <%= button_to resolution_dispatcher_refund_path(refund),
                              method: :patch,
                              params: { refund_reason: 'General resolution' },
                              class: "decision-btn refund-option",
                              confirm: "Process immediate refund? This cannot be undone.",
                              form: { data: { turbo: true } } do %>
                  <i class="fas fa-money-bill-wave"></i>
                  <span class="btn-title">Issue Immediate Refund</span>
                  <span class="btn-desc">Process standard refund</span>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
      
    <% when 'resolution_completed' %>
      <div class="action-card completed-action">
        <div class="action-header">
          <div class="action-icon success">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="action-title">
            <h4>Resolution Complete</h4>
            <p>Case has been successfully resolved</p>
          </div>
          <div class="completion-time">
            <span class="time-badge">
              Completed <%= time_ago_in_words(refund.updated_at) %> ago
            </span>
          </div>
        </div>
        
        <div class="action-details">
          <div class="resolution-summary">
            <% if refund.replacement_order_number.present? %>
              <div class="outcome-card">
                <i class="fas fa-box"></i>
                <span>Replacement order created: <%= refund.replacement_order_number %></span>
              </div>
            <% elsif refund.dispatcher_decision == 'delay_approved' %>
              <div class="outcome-card">
                <i class="fas fa-clock"></i>
                <span>Delay accepted: Order will proceed with <%= refund.delay_duration %>-day extension</span>
              </div>
            <% elsif refund.dispatcher_decision == 'price_increase_approved' %>
              <div class="outcome-card">
                <i class="fas fa-dollar-sign"></i>
                <span>Price increase approved: Additional $<%= refund.additional_cost %> required</span>
              </div>
            <% elsif refund.dispatcher_decision == 'compatible_alternative_approved' %>
              <div class="outcome-card">
                <i class="fas fa-exchange-alt"></i>
                <span>Compatible alternative approved: <%= refund.alternative_part_name %></span>
              </div>
            <% elsif refund.alternative_part_name.present? %>
              <div class="outcome-card">
                <i class="fas fa-exchange-alt"></i>
                <span>Alternative part approved: <%= refund.alternative_part_name %></span>
              </div>
            <% elsif refund.dispatcher_decision == 'issue_refund' || refund.refund_stage == 'refunded' %>
              <div class="outcome-card">
                <i class="fas fa-money-bill-wave"></i>
                <span>Refund processed: $<%= refund.refund_amount %></span>
              </div>
            <% else %>
              <div class="outcome-card">
                <i class="fas fa-check"></i>
                <span>Resolution completed</span>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Smart Footer with Insights -->
  <div class="resolution-footer-amazing">
    <div class="footer-insights">
      <div class="insight-item">
        <i class="fas fa-history"></i>
        <span class="insight-label">Created:</span>
        <span class="insight-value"><%= refund.created_at.strftime("%b %d, %I:%M %p") %></span>
      </div>
      <% if refund.agent_notes.present? || refund.dispatcher_notes.present? %>
        <div class="insight-item">
          <i class="fas fa-sticky-note"></i>
          <span class="insight-label">Notes:</span>
          <span class="insight-value">
            <%= (refund.agent_notes.present? ? 1 : 0) + (refund.dispatcher_notes.present? ? 1 : 0) %> entries
          </span>
        </div>
      <% end %>
      <% if refund.replacement_order_number.present? %>
        <div class="insight-item">
          <i class="fas fa-link"></i>
          <span class="insight-label">Replacement:</span>
          <span class="insight-value"><%= refund.replacement_order_number %></span>
        </div>
      <% end %>
    </div>
    
    <div class="footer-actions">
      <!-- Stage Toggle Buttons -->
      <div class="stage-toggle-buttons">
        <% if refund.resolution_stage == 'pending_dispatch_decision' %>
          <%= button_to resolution_move_to_agent_review_path(refund),
                        method: :patch,
                        class: "toggle-btn agent-toggle",
                        title: "Move to Agent Review",
                        form: { data: { turbo: true } } do %>
            <i class="fas fa-phone"></i>
            <span>→ Agent</span>
          <% end %>
        <% elsif refund.resolution_stage == 'pending_customer_clarification' %>
          <%= button_to resolution_move_to_dispatcher_review_path(refund),
                        method: :patch,
                        class: "toggle-btn dispatcher-toggle",
                        title: "Move to Dispatcher Review",
                        form: { data: { turbo: true } } do %>
            <i class="fas fa-clipboard-check"></i>
            <span>→ Dispatcher</span>
          <% end %>
        <% end %>
      </div>
      
      <button class="footer-btn" onclick="openResolutionHub(<%= refund.id %>, '<%= refund.resolution_stage %>')">
        <i class="fas fa-comments"></i>
        Open Chat
      </button>
      <%= link_to refund_path(refund), class: "footer-btn secondary" do %>
        <i class="fas fa-external-link-alt"></i>
        Full Details
      <% end %>
    </div>
  </div>
</div>