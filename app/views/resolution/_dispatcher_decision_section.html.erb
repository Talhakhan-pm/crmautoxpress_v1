<div class="workflow-section dispatcher-decision">
  <div class="section-header">
    <h6><i class="fas fa-clipboard-check"></i> Dispatcher Part Research & Decision</h6>
    <span class="section-description">Review updated customer details and decide on part availability</span>
  </div>

  <div class="workflow-content">
    <!-- Agent Updates Display -->
    <% if refund.corrected_customer_details.present? || refund.agent_notes.present? %>
      <div class="agent-updates">
        <h7>Updates from Agent:</h7>
        <% if refund.corrected_customer_details.present? %>
          <div class="update-item">
            <span class="update-label">Corrected Customer Details:</span>
            <div class="update-content"><%= simple_format(refund.corrected_customer_details) %></div>
          </div>
        <% end %>
        <% if refund.agent_notes.present? %>
          <div class="update-item">
            <span class="update-label">Agent Notes:</span>
            <div class="update-content"><%= simple_format(refund.agent_notes) %></div>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Part Research Section -->
    <%= form_with model: refund, url: update_resolution_notes_path(refund), 
                  method: :patch, local: false, class: "research-form" do |f| %>
      <div class="part-research">
        <h7>Part Research Notes:</h7>
        <%= f.text_area :part_research_notes, 
                        placeholder: "Research findings: suppliers checked, availability, compatibility notes...",
                        class: "form-textarea",
                        rows: 4,
                        value: refund.part_research_notes %>
      </div>

      <div class="dispatcher-communication">
        <h7>Internal Notes:</h7>
        <%= f.text_area :dispatcher_notes, 
                        placeholder: "Internal dispatcher notes and recommendations...",
                        class: "form-textarea",
                        rows: 3,
                        value: refund.dispatcher_notes %>
      </div>

      <%= f.submit "Update Research", class: "btn btn-info", 
                   data: { disable_with: "Updating..." } %>
    <% end %>

    <!-- Sourcing Research Summary -->
    <div class="sourcing-simulation">
      <div class="sourcing-header">
        <i class="fas fa-industry"></i>
        <span>Supplier Research Results</span>
      </div>
      <div class="simulated-results">
        <div class="supplier-option">
          <div class="supplier-name">Primary Supplier</div>
          <div class="supplier-details">$<%= (refund.order.total_amount * 0.6).round(2) %> • 2-3 days • ⭐⭐⭐⭐</div>
          <div class="profit-calc">Profit: $<%= (refund.order.total_amount * 0.4).round(2) %></div>
        </div>
        <div class="supplier-option">
          <div class="supplier-name">Secondary Supplier</div>
          <div class="supplier-details">$<%= (refund.order.total_amount * 0.7).round(2) %> • 5-7 days • ⭐⭐⭐</div>
          <div class="profit-calc">Profit: $<%= (refund.order.total_amount * 0.3).round(2) %></div>
        </div>
        <div class="supplier-option disabled">
          <div class="supplier-name">Alternative Supplier</div>
          <div class="supplier-details">$<%= (refund.order.total_amount * 1.2).round(2) %> • 3 days • ⭐⭐⭐⭐⭐</div>
          <div class="profit-calc loss">Loss: $<%= (refund.order.total_amount * 0.2).round(2) %></div>
        </div>
      </div>
    </div>

    <!-- Decision Actions -->
    <div class="dispatcher-decisions">
      <h7>Business Decision (Dispatcher):</h7>
      
      <!-- Sourcing Decisions -->
      <div class="decision-category">
        <div class="category-header">
          <i class="fas fa-industry"></i>
          <span>Part Sourcing Options</span>
        </div>
        <div class="decision-grid">
          <button class="decision-btn accept-delay" 
                  onclick="openDelayModal(<%= refund.id %>)"
                  data-refund-id="<%= refund.id %>">
            <i class="fas fa-clock"></i>
            <span class="btn-title">Accept Delay</span>
            <span class="btn-desc">Part available, tell customer about timing</span>
          </button>
          
          <button class="decision-btn price-increase"
                  onclick="openPriceModal(<%= refund.id %>)"
                  data-refund-id="<%= refund.id %>">
            <i class="fas fa-dollar-sign"></i>
            <span class="btn-title">Request Price Increase</span>
            <span class="btn-desc">Part costs more than customer paid</span>
          </button>
          
          <button class="decision-btn compatible-alternative"
                  onclick="openAlternativeModal(<%= refund.id %>)"
                  data-refund-id="<%= refund.id %>">
            <i class="fas fa-exchange-alt"></i>
            <span class="btn-title">Send Compatible Alternative</span>
            <span class="btn-desc">Found substitute part, create replacement</span>
          </button>
        </div>
      </div>

      <!-- Return Management Options -->
      <% if refund.refund_reason.in?(['wrong_product', 'defective_product', 'quality_issues', 'customer_changed_mind']) %>
        <div class="decision-category return-category">
          <div class="category-header">
            <i class="fas fa-undo"></i>
            <span>Return Management Options</span>
            <small class="category-desc">Customer needs to return the product first</small>
          </div>
          <div class="decision-grid">
            <%= button_to resolution_authorize_return_and_refund_path(refund),
                          method: :patch,
                          class: "decision-btn return-refund-option",
                          confirm: "Authorize return and full refund? Customer must return product first.",
                          form: { data: { turbo: true } } do %>
              <i class="fas fa-undo"></i>
              <span class="btn-title">Authorize Return + Refund</span>
              <span class="btn-desc">Customer returns product, gets full refund</span>
            <% end %>
            
            <%= button_to resolution_authorize_return_and_replacement_path(refund),
                          method: :patch,
                          class: "decision-btn return-replacement-option",
                          confirm: "Authorize return and replacement? Will ship new item after return received.",
                          form: { data: { turbo: true } } do %>
              <i class="fas fa-sync-alt"></i>
              <span class="btn-title">Authorize Return + Replacement</span>
              <span class="btn-desc">Customer returns product, gets replacement</span>
            <% end %>
          </div>
        </div>
      <% end %>
      
      <!-- Final Options -->
      <div class="decision-category final-category">
        <div class="category-header">
          <i class="fas fa-times-circle"></i>
          <span>Resolution Options</span>
        </div>
        <div class="decision-grid">
          <%= button_to resolution_dispatcher_refund_path(refund),
                        method: :patch,
                        params: { refund_reason: 'Not economical to source' },
                        class: "decision-btn refund-option",
                        confirm: "Process immediate refund? This cannot be undone.",
                        form: { data: { turbo: true } } do %>
            <i class="fas fa-money-bill-wave"></i>
            <span class="btn-title">Issue Immediate Refund</span>
            <span class="btn-desc">No profitable sourcing options</span>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Current Research Display -->
    <% if refund.part_research_notes.present? || refund.dispatcher_notes.present? %>
      <div class="current-research">
        <% if refund.part_research_notes.present? %>
          <div class="research-section">
            <span class="research-label">Part Research:</span>
            <div class="research-content"><%= simple_format(refund.part_research_notes) %></div>
          </div>
        <% end %>
        <% if refund.dispatcher_notes.present? %>
          <div class="research-section">
            <span class="research-label">Dispatcher Notes:</span>
            <div class="research-content"><%= simple_format(refund.dispatcher_notes) %></div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>