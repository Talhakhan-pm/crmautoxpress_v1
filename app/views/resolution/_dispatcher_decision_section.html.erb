<div class="workflow-section dispatcher-decision">
  <div class="section-header">
    <h6><i class="fas fa-clipboard-check"></i> Dispatcher Part Research & Decision</h6>
    <span class="section-description">Review updated customer details and decide on part availability</span>
  </div>

  <div class="workflow-content">
    <!-- Agent Updates Display -->
    <% if refund.corrected_customer_details.present? || refund.agent_notes.present? %>
      <div class="agent-updates">
        <h7>Updates from Agent:</h7>
        <% if refund.corrected_customer_details.present? %>
          <div class="update-item">
            <span class="update-label">Corrected Customer Details:</span>
            <div class="update-content"><%= simple_format(refund.corrected_customer_details) %></div>
          </div>
        <% end %>
        <% if refund.agent_notes.present? %>
          <div class="update-item">
            <span class="update-label">Agent Notes:</span>
            <div class="update-content"><%= simple_format(refund.agent_notes) %></div>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Part Research Section -->
    <%= form_with model: refund, url: update_resolution_notes_path(refund), 
                  method: :patch, local: false, class: "research-form" do |f| %>
      <div class="part-research">
        <h7>Part Research Notes:</h7>
        <%= f.text_area :part_research_notes, 
                        placeholder: "Research findings: suppliers checked, availability, compatibility notes...",
                        class: "form-textarea",
                        rows: 4,
                        value: refund.part_research_notes %>
      </div>

      <div class="dispatcher-communication">
        <h7>Internal Notes:</h7>
        <%= f.text_area :dispatcher_notes, 
                        placeholder: "Internal dispatcher notes and recommendations...",
                        class: "form-textarea",
                        rows: 3,
                        value: refund.dispatcher_notes %>
      </div>

      <%= f.submit "Update Research", class: "btn btn-info", 
                   data: { disable_with: "Updating..." } %>
    <% end %>


    <!-- Decision Actions -->
    <div class="dispatcher-decisions">
      <h7>Business Decision (Dispatcher):</h7>
      
      <!-- Contextual Decisions Based on Refund Reason -->
      <% case refund.refund_reason %>
      <% when 'wrong_product', 'defective_product', 'quality_issues' %>
        <!-- Return Management Options for product issues -->
        <div class="decision-category return-category">
          <div class="category-header">
            <i class="fas fa-undo"></i>
            <span>Return Management Options</span>
            <small class="category-desc">Customer needs to return the product first</small>
          </div>
          <div class="decision-grid">
            <%= button_to resolution_authorize_return_and_refund_path(refund),
                          method: :patch,
                          class: "decision-btn return-refund-option",
                          confirm: "Authorize return and full refund? Customer must return product first.",
                          form: { data: { turbo: true } } do %>
              <i class="fas fa-undo"></i>
              <span class="btn-title">Authorize Return + Refund</span>
              <span class="btn-desc">Customer returns product, gets full refund</span>
            <% end %>
            
            <%= button_to resolution_authorize_return_and_replacement_path(refund),
                          method: :patch,
                          class: "decision-btn return-replacement-option",
                          confirm: "Authorize return and replacement? Will ship new item after return received.",
                          form: { data: { turbo: true } } do %>
              <i class="fas fa-sync-alt"></i>
              <span class="btn-title">Authorize Return + Replacement</span>
              <span class="btn-desc">Customer returns product, gets replacement</span>
            <% end %>
          </div>
        </div>

      <% when 'customer_changed_mind' %>
        <!-- Simple refund for customer mind change -->
        <div class="decision-category final-category">
          <div class="category-header">
            <i class="fas fa-user-times"></i>
            <span>Customer Changed Mind</span>
            <small class="category-desc">Process immediate refund</small>
          </div>
          <div class="decision-grid">
            <%= button_to resolution_dispatcher_refund_path(refund),
                          method: :patch,
                          params: { refund_reason: 'Customer changed mind' },
                          class: "decision-btn refund-option",
                          confirm: "Process immediate refund? This cannot be undone.",
                          form: { data: { turbo: true } } do %>
              <i class="fas fa-money-bill-wave"></i>
              <span class="btn-title">Issue Immediate Refund</span>
              <span class="btn-desc">Customer no longer wants the item</span>
            <% end %>
          </div>
        </div>

      <% when 'supplier_issue' %>
        <!-- Simple refund for supplier issues -->
        <div class="decision-category final-category">
          <div class="category-header">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Supplier Issue</span>
            <small class="category-desc">Item unavailable</small>
          </div>
          <div class="decision-grid">
            <%= button_to resolution_dispatcher_refund_path(refund),
                          method: :patch,
                          params: { refund_reason: 'Item unavailable from supplier' },
                          class: "decision-btn refund-option",
                          confirm: "Process immediate refund? This cannot be undone.",
                          form: { data: { turbo: true } } do %>
              <i class="fas fa-money-bill-wave"></i>
              <span class="btn-title">Issue Immediate Refund</span>
              <span class="btn-desc">Cannot source item from supplier</span>
            <% end %>
          </div>
        </div>

      <% when 'shipping_delay' %>
        <!-- Agent already contacted customer, dispatcher processes result -->
        <div class="decision-category">
          <div class="category-header">
            <i class="fas fa-clock"></i>
            <span>Shipping Delay Resolution</span>
            <small class="category-desc">Process customer's response to delay</small>
          </div>
          <div class="decision-grid">
            <%= button_to resolution_accept_delay_path(refund),
                          method: :patch,
                          params: { delay_days: 5 },
                          class: "decision-btn accept-delay",
                          confirm: "Customer accepts delay? Order will proceed with extended timeline.",
                          form: { data: { turbo: true } } do %>
              <i class="fas fa-check"></i>
              <span class="btn-title">Customer Accepts Delay</span>
              <span class="btn-desc">Proceed with extended delivery timeline</span>
            <% end %>
            
            <%= button_to resolution_dispatcher_refund_path(refund),
                          method: :patch,
                          params: { refund_reason: 'Customer declined shipping delay' },
                          class: "decision-btn refund-option",
                          confirm: "Customer wants refund instead of delay?",
                          form: { data: { turbo: true } } do %>
              <i class="fas fa-money-bill-wave"></i>
              <span class="btn-title">Customer Wants Refund</span>
              <span class="btn-desc">Customer declined the delay option</span>
            <% end %>
          </div>
        </div>

      <% when 'item_not_found' %>
        <!-- Sourcing decisions for unavailable items -->
        <div class="decision-category">
          <div class="category-header">
            <i class="fas fa-search"></i>
            <span>Item Sourcing Options</span>
            <small class="category-desc">Research alternative sourcing methods</small>
          </div>
          <div class="decision-grid">
            <%= button_to resolution_accept_delay_path(refund),
                          method: :patch,
                          params: { delay_days: 7 },
                          class: "decision-btn accept-delay",
                          confirm: "Source with delay? Customer will be contacted about extended timeline.",
                          form: { data: { turbo: true } } do %>
              <i class="fas fa-clock"></i>
              <span class="btn-title">Source with Delay</span>
              <span class="btn-desc">Found item but requires 7+ days</span>
            <% end %>
            
            <%= button_to resolution_request_price_increase_path(refund),
                          method: :patch,
                          params: { additional_amount: 50 },
                          class: "decision-btn price-increase",
                          confirm: "Request price increase? Customer will be contacted about additional cost.",
                          form: { data: { turbo: true } } do %>
              <i class="fas fa-dollar-sign"></i>
              <span class="btn-title">Source at Higher Cost</span>
              <span class="btn-desc">Item available but costs more</span>
            <% end %>
            
            <%= button_to resolution_send_compatible_alternative_path(refund),
                          method: :patch,
                          params: { alternative_part_name: 'Compatible upgrade' },
                          class: "decision-btn compatible-alternative",
                          confirm: "Send compatible alternative? Customer gets upgraded part at same price.",
                          form: { data: { turbo: true } } do %>
              <i class="fas fa-exchange-alt"></i>
              <span class="btn-title">Compatible Alternative</span>
              <span class="btn-desc">Send upgraded/substitute part</span>
            <% end %>
            
            <%= button_to resolution_dispatcher_refund_path(refund),
                          method: :patch,
                          params: { refund_reason: 'Item not economical to source' },
                          class: "decision-btn refund-option",
                          confirm: "Process immediate refund? This cannot be undone.",
                          form: { data: { turbo: true } } do %>
              <i class="fas fa-money-bill-wave"></i>
              <span class="btn-title">Issue Immediate Refund</span>
              <span class="btn-desc">Cannot source item economically</span>
            <% end %>
          </div>
        </div>

      <% else %>
        <!-- Fallback for other reasons -->
        <div class="decision-category final-category">
          <div class="category-header">
            <i class="fas fa-question-circle"></i>
            <span>General Resolution</span>
          </div>
          <div class="decision-grid">
            <%= button_to resolution_dispatcher_refund_path(refund),
                          method: :patch,
                          params: { refund_reason: 'General resolution' },
                          class: "decision-btn refund-option",
                          confirm: "Process immediate refund? This cannot be undone.",
                          form: { data: { turbo: true } } do %>
              <i class="fas fa-money-bill-wave"></i>
              <span class="btn-title">Issue Immediate Refund</span>
              <span class="btn-desc">Process standard refund</span>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Current Research Display -->
    <% if refund.part_research_notes.present? || refund.dispatcher_notes.present? %>
      <div class="current-research">
        <% if refund.part_research_notes.present? %>
          <div class="research-section">
            <span class="research-label">Part Research:</span>
            <div class="research-content"><%= simple_format(refund.part_research_notes) %></div>
          </div>
        <% end %>
        <% if refund.dispatcher_notes.present? %>
          <div class="research-section">
            <span class="research-label">Dispatcher Notes:</span>
            <div class="research-content"><%= simple_format(refund.dispatcher_notes) %></div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>