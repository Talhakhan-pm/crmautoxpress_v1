<%= turbo_frame_tag "main_content", data: { turbo_action: "advance" } do %>
<main class="main-content">
    <%= turbo_stream_from "products" %>
    <%= turbo_stream_from "product_#{@product.id}_activities" %>
    
    <header class="main-header">
      <div class="header-title">
        <h1>
          <i class="fas fa-box"></i> 
          <%= @product.name %>
          <span class="badge badge-<%= @product.status %>"><%= @product.status.humanize %></span>
        </h1>
        <p class="header-subtitle"><%= @product.part_number %> â€¢ <%= @product.display_category %></p>
      </div>
      
      <div class="header-actions">
        <%= link_to products_path, class: "btn btn-secondary", data: { turbo_frame: "main_content" } do %>
          <i class="fas fa-arrow-left"></i> Back to Products
        <% end %>
        <%= link_to edit_product_path(@product), class: "btn btn-primary", data: { turbo_frame: "main_content" } do %>
          <i class="fas fa-edit"></i> Edit Product
        <% end %>
      </div>
    </header>

    <div class="product-details-grid">
      <!-- Product Information -->
      <div class="content-card">
        <h3><i class="fas fa-info-circle"></i> Product Details</h3>
        <div class="product-info-section">
          <div class="info-row">
            <label>Part Number:</label>
            <span class="part-number"><%= @product.part_number %></span>
          </div>
          
          <% if @product.oem_part_number.present? %>
            <div class="info-row">
              <label>OEM Part Number:</label>
              <span><%= @product.oem_part_number %></span>
            </div>
          <% end %>
          
          <div class="info-row">
            <label>Category:</label>
            <span class="category-badge"><%= @product.display_category %></span>
          </div>
          
          <% if @product.description.present? %>
            <div class="info-row">
              <label>Description:</label>
              <span><%= simple_format(@product.description) %></span>
            </div>
          <% end %>
          
          <div class="info-row">
            <label>Created:</label>
            <span><%= @product.created_at.strftime("%B %d, %Y") %></span>
          </div>
        </div>
      </div>

      <!-- Pricing & Vendor -->
      <div class="content-card">
        <h3><i class="fas fa-dollar-sign"></i> Pricing & Vendor</h3>
        <div class="pricing-section">
          <div class="price-row">
            <label>Vendor Cost:</label>
            <span class="price-cost">$<%= number_with_precision(@product.vendor_cost, precision: 2) %></span>
          </div>
          
          <div class="price-row">
            <label>Selling Price:</label>
            <span class="price-selling">$<%= number_with_precision(@product.selling_price, precision: 2) %></span>
          </div>
          
          <div class="price-row">
            <label>Profit Margin:</label>
            <span class="profit-margin <% if @product.profit_margin > 40 %>high<% elsif @product.profit_margin > 20 %>medium<% else %>low<% end %>">
              <%= @product.profit_margin %>%
            </span>
          </div>
          
          <div class="price-row">
            <label>Markup:</label>
            <span class="markup"><%= @product.markup_percentage %>%</span>
          </div>
          
          <% if @product.vendor_name.present? %>
            <div class="price-row">
              <label>Vendor:</label>
              <span><%= @product.vendor_name %></span>
            </div>
          <% end %>
          
          <% if @product.lead_time_days.present? %>
            <div class="price-row">
              <label>Lead Time:</label>
              <span><%= @product.lead_time_days %> days</span>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Vehicle Compatibility -->
      <% if @product.vehicle_compatibility_list.any? %>
        <div class="content-card">
          <h3><i class="fas fa-car"></i> Vehicle Compatibility</h3>
          <div class="compatibility-list">
            <% @product.vehicle_compatibility_list.each do |vehicle| %>
              <span class="compatibility-badge"><%= vehicle %></span>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Available Suppliers -->
      <div class="content-card">
        <h3>
          <i class="fas fa-truck"></i> 
          Available Suppliers
          <span class="count-badge"><%= @product_suppliers.count %></span>
        </h3>
        
        <% if @product_suppliers.any? %>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Supplier</th>
                  <th>Part Number</th>
                  <th>Cost</th>
                  <th>vs Product Cost</th>
                  <th>Lead Time</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <% @product_suppliers.order(:supplier_cost).each do |ps| %>
                  <tr>
                    <td>
                      <div class="supplier-info">
                        <strong><%= link_to ps.supplier.name, supplier_path(ps.supplier), data: { turbo_frame: "main_content" } %></strong>
                        <% if ps.supplier.supplier_notes.present? %>
                          <br><small class="text-muted"><%= truncate(ps.supplier.supplier_notes, length: 30) %></small>
                        <% end %>
                      </div>
                    </td>
                    <td>
                      <% if ps.supplier_part_number.present? %>
                        <span class="supplier-part"><%= ps.supplier_part_number %></span>
                      <% else %>
                        <span class="text-muted">-</span>
                      <% end %>
                    </td>
                    <td>
                      <% if ps.supplier_cost.present? %>
                        <span class="supplier-cost">$<%= number_with_precision(ps.supplier_cost, precision: 2) %></span>
                      <% else %>
                        <span class="text-muted">Not quoted</span>
                      <% end %>
                    </td>
                    <td>
                      <% if ps.supplier_cost.present? && @product.vendor_cost.present? %>
                        <% diff = ps.cost_difference_vs_product %>
                        <span class="cost-comparison <%= diff < 0 ? 'better' : diff > 0 ? 'worse' : 'same' %>">
                          <%= diff > 0 ? '+' : '' %>$<%= number_with_precision(diff, precision: 2) %>
                          <% if diff < 0 %>
                            <i class="fas fa-arrow-down text-success"></i>
                          <% elsif diff > 0 %>
                            <i class="fas fa-arrow-up text-danger"></i>
                          <% end %>
                        </span>
                      <% else %>
                        <span class="text-muted">-</span>
                      <% end %>
                    </td>
                    <td>
                      <% if ps.lead_time_days.present? %>
                        <span class="lead-time"><%= ps.lead_time_days %> days</span>
                      <% else %>
                        <span class="text-muted">Unknown</span>
                      <% end %>
                    </td>
                    <td>
                      <div class="status-badges">
                        <% if ps.preferred_supplier %>
                          <span class="badge badge-warning">
                            <i class="fas fa-star"></i> Preferred
                          </span>
                        <% end %>
                        <% if ps.is_better_deal? %>
                          <span class="badge badge-success">
                            <i class="fas fa-dollar-sign"></i> Best Price
                          </span>
                        <% end %>
                        <% if ps.last_quoted_date.present? %>
                          <br><small class="text-muted">
                            Quoted <%= time_ago_in_words(ps.last_quoted_date) %> ago
                          </small>
                        <% end %>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="empty-state">
            <i class="fas fa-truck fa-2x text-muted"></i>
            <p>No suppliers found for this product</p>
            <small class="text-muted">Suppliers will be linked when they provide quotes for this part</small>
          </div>
        <% end %>
      </div>

      <!-- Related Callbacks -->
      <div class="content-card">
        <h3>
          <i class="fas fa-phone"></i> 
          Related Callbacks
          <span class="count-badge"><%= @related_callbacks.count %></span>
        </h3>
        
        <% if @related_callbacks.any? %>
          <div class="callbacks-list">
            <% @related_callbacks.each do |callback| %>
              <div class="callback-item">
                <div class="callback-header">
                  <div class="callback-info">
                    <strong><%= callback.customer_name %></strong>
                    <span class="badge badge-<%= callback.status %>">
                      <%= callback.status.humanize %>
                    </span>
                  </div>
                  <div class="callback-meta">
                    <small class="text-muted">
                      <%= time_ago_in_words(callback.created_at) %> ago
                    </small>
                  </div>
                </div>
                
                <div class="callback-details">
                  <i class="fas fa-phone"></i>
                  <%= callback.phone_number %>
                </div>
                
                <% if callback.car_make_model.present? %>
                  <div class="callback-details">
                    <i class="fas fa-car"></i>
                    <%= callback.year %> <%= callback.car_make_model %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="empty-state">
            <i class="fas fa-phone fa-2x text-muted"></i>
            <p>No related callbacks found</p>
          </div>
        <% end %>
      </div>

      <!-- Recent Activity -->
      <div class="content-card">
        <h3>
          <i class="fas fa-history"></i> 
          Recent Activity
          <span id="activity-count"><%= @recent_activities.count %></span>
        </h3>
        
        <div id="activity-list" class="activity-feed">
          <% if @recent_activities.any? %>
            <% @recent_activities.each do |activity| %>
              <%= render "activities/activity", activity: activity %>
            <% end %>
          <% else %>
            <div class="empty-state">
              <i class="fas fa-history fa-2x text-muted"></i>
              <p>No activity yet</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
</main>
<% end %>