<%= turbo_frame_tag "main_content", data: { turbo_action: "advance" } do %>
<% content_for :title, "Order Rescue Analytics & Revenue Impact" %>

<div class="rescue-analytics-container">
  <!-- Hero Section -->
  <div class="rescue-hero-section">
    <div class="rescue-hero-content">
      <div class="rescue-hero-left">
        <div class="rescue-hero-icon">
          <i class="fas fa-shield-alt"></i>
        </div>
        <div class="rescue-hero-text">
          <h1 class="rescue-hero-title">Order Rescue Analytics</h1>
          <p class="rescue-hero-subtitle">Track orders saved vs lost & revenue impact</p>
        </div>
      </div>
      
      <div class="rescue-hero-actions">
        <%= link_to refunds_path, class: "rescue-btn rescue-btn-ghost" do %>
          <i class="fas fa-arrow-left"></i>
          <span>Back to Refunds</span>
        <% end %>
        <%= link_to dashboard_path, class: "rescue-btn rescue-btn-outline" do %>
          <i class="fas fa-home"></i>
          <span>Dashboard</span>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Main Rescue Metrics -->
  <div class="rescue-overview-section">
    <div class="rescue-overview-grid">
      <!-- Orders Saved -->
      <div class="rescue-metric-card rescue-metric-success">
        <div class="rescue-metric-icon">
          <i class="fas fa-shield-check"></i>
        </div>
        <div class="rescue-metric-content">
          <div class="rescue-metric-number"><%= @rescue_metrics[:orders_saved] || 0 %></div>
          <div class="rescue-metric-label">Orders Saved</div>
          <div class="rescue-metric-subtitle">Kept customers happy</div>
        </div>
        <div class="rescue-metric-trend rescue-trend-positive">
          <i class="fas fa-arrow-up"></i>
        </div>
      </div>

      <!-- Orders Lost -->
      <div class="rescue-metric-card rescue-metric-danger">
        <div class="rescue-metric-icon">
          <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="rescue-metric-content">
          <div class="rescue-metric-number"><%= @rescue_metrics[:orders_lost] || 0 %></div>
          <div class="rescue-metric-label">Orders Lost</div>
          <div class="rescue-metric-subtitle">Processed refunds</div>
        </div>
        <div class="rescue-metric-trend rescue-trend-danger">
          <i class="fas fa-arrow-down"></i>
        </div>
      </div>

      <!-- Rescue Rate -->
      <div class="rescue-metric-card rescue-metric-primary">
        <div class="rescue-metric-icon">
          <i class="fas fa-percentage"></i>
        </div>
        <div class="rescue-metric-content">
          <div class="rescue-metric-number"><%= @rescue_metrics[:rescue_rate] || 0 %>%</div>
          <div class="rescue-metric-label">Rescue Rate</div>
          <div class="rescue-metric-subtitle">Success percentage</div>
        </div>
        <div class="rescue-metric-trend rescue-trend-primary">
          <i class="fas fa-chart-line"></i>
        </div>
      </div>

      <!-- Net Revenue Impact -->
      <div class="rescue-metric-card <%= (@rescue_metrics[:net_revenue_impact] || 0) >= 0 ? 'rescue-metric-success' : 'rescue-metric-warning' %>">
        <div class="rescue-metric-icon">
          <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="rescue-metric-content">
          <div class="rescue-metric-number">
            <%= (@rescue_metrics[:net_revenue_impact] || 0) >= 0 ? '+' : '' %>$<%= number_with_precision(@rescue_metrics[:net_revenue_impact] || 0, precision: 0, delimiter: ',') %>
          </div>
          <div class="rescue-metric-label">Net Revenue Impact</div>
          <div class="rescue-metric-subtitle">Total saved minus lost</div>
        </div>
        <div class="rescue-metric-trend <%= (@rescue_metrics[:net_revenue_impact] || 0) >= 0 ? 'rescue-trend-positive' : 'rescue-trend-danger' %>">
          <i class="fas fa-<%= (@rescue_metrics[:net_revenue_impact] || 0) >= 0 ? 'arrow-up' : 'arrow-down' %>"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Revenue Breakdown -->
  <div class="rescue-dashboard-section">
    <div class="rescue-dashboard-grid">
      <!-- Revenue Impact Card -->
      <div class="rescue-dashboard-card rescue-revenue-card">
        <div class="rescue-card-header">
          <h3 class="rescue-card-title">
            <i class="fas fa-chart-bar"></i>
            Revenue Impact Breakdown
          </h3>
        </div>
        <div class="rescue-card-body">
          <div class="rescue-revenue-metrics">
            <div class="rescue-revenue-item rescue-revenue-saved">
              <div class="rescue-revenue-circle" data-percentage="<%= @rescue_metrics[:orders_saved] > 0 ? ((@rescue_metrics[:revenue_saved] / (@rescue_metrics[:revenue_saved] + @rescue_metrics[:revenue_lost])) * 100).round : 0 %>">
                <div class="rescue-circle-content">
                  <span class="rescue-circle-number">$<%= number_with_precision(@rescue_metrics[:revenue_saved] || 0, precision: 0, delimiter: ',') %></span>
                  <span class="rescue-circle-label">Revenue Saved</span>
                </div>
              </div>
            </div>
            
            <div class="rescue-revenue-stats">
              <div class="rescue-stat-row">
                <div class="rescue-stat-item">
                  <div class="rescue-stat-icon rescue-stat-saved">
                    <i class="fas fa-piggy-bank"></i>
                  </div>
                  <div class="rescue-stat-content">
                    <div class="rescue-stat-value">$<%= number_with_precision(@rescue_metrics[:revenue_saved] || 0, precision: 0, delimiter: ',') %></div>
                    <div class="rescue-stat-label">Total Revenue Saved</div>
                  </div>
                </div>
              </div>
              
              <div class="rescue-stat-row">
                <div class="rescue-stat-item">
                  <div class="rescue-stat-icon rescue-stat-lost">
                    <i class="fas fa-money-bill-wave"></i>
                  </div>
                  <div class="rescue-stat-content">
                    <div class="rescue-stat-value">$<%= number_with_precision(@rescue_metrics[:revenue_lost] || 0, precision: 0, delimiter: ',') %></div>
                    <div class="rescue-stat-label">Total Refunds Paid</div>
                  </div>
                </div>
              </div>
              
              <div class="rescue-stat-row">
                <div class="rescue-stat-item">
                  <div class="rescue-stat-icon rescue-stat-avg">
                    <i class="fas fa-calculator"></i>
                  </div>
                  <div class="rescue-stat-content">
                    <div class="rescue-stat-value">
                      $<%= @rescue_metrics[:orders_saved] > 0 ? number_with_precision(@rescue_metrics[:revenue_saved] / @rescue_metrics[:orders_saved], precision: 0) : 0 %>
                    </div>
                    <div class="rescue-stat-label">Avg Order Value Saved</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Rescue Methods Card -->
      <div class="rescue-dashboard-card rescue-methods-card">
        <div class="rescue-card-header">
          <h3 class="rescue-card-title">
            <i class="fas fa-tools"></i>
            Rescue Method Effectiveness
          </h3>
        </div>
        <div class="rescue-card-body">
          <% if (@rescue_metrics[:rescue_methods] || {}).any? %>
            <div class="rescue-methods-list">
              <% (@rescue_metrics[:rescue_methods] || {}).each do |method, stats| %>
                <div class="rescue-method-item">
                  <div class="rescue-method-header">
                    <div class="rescue-method-info">
                      <div class="rescue-method-name">
                        <% case method %>
                        <% when 'delay_accepted' %>
                          <i class="fas fa-clock"></i> Delay Accepted
                        <% when 'price_increase_accepted' %>
                          <i class="fas fa-dollar-sign"></i> Price Increase
                        <% when 'alternative_part_accepted' %>
                          <i class="fas fa-exchange-alt"></i> Alternative Part
                        <% when 'replacement_order' %>
                          <i class="fas fa-sync-alt"></i> Replacement Order
                        <% else %>
                          <i class="fas fa-question"></i> <%= method.humanize %>
                        <% end %>
                      </div>
                      <div class="rescue-method-count"><%= stats[:count] || 0 %> orders</div>
                    </div>
                    <div class="rescue-method-revenue">
                      <span class="rescue-revenue-badge">
                        $<%= number_with_precision(stats[:revenue_saved] || 0, precision: 0, delimiter: ',') %>
                      </span>
                    </div>
                  </div>
                  <div class="rescue-method-progress">
                    <div class="rescue-progress-bar">
                      <div class="rescue-progress-fill" style="width: <%= (@rescue_metrics[:orders_saved] > 0) ? ((stats[:count] || 0).to_f / @rescue_metrics[:orders_saved] * 100).round : 0 %>%"></div>
                    </div>
                    <div class="rescue-method-avg">
                      $<%= number_with_precision(stats[:avg_amount] || 0, precision: 0) %> avg
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="rescue-empty-state">
              <i class="fas fa-tools"></i>
              <p>No rescue methods data available yet</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Agent Performance Table -->
  <div class="rescue-agents-section">
    <div class="rescue-agents-card">
      <div class="rescue-card-header">
        <h3 class="rescue-card-title">
          <i class="fas fa-users"></i>
          Agent Rescue Performance Leaderboard
        </h3>
      </div>
      <div class="rescue-card-body">
        <% if (@agent_rescue_performance || {}).any? %>
          <div class="rescue-agents-grid">
            <% (@agent_rescue_performance || {}).sort_by { |_, metrics| -(metrics[:rescue_rate] || 0) }.each_with_index do |(agent_id, metrics), index| %>
              <div class="rescue-agent-card">
                <div class="rescue-agent-rank">
                  <div class="rescue-rank-number rescue-rank-<%= index < 3 ? ['gold', 'silver', 'bronze'][index] : 'default' %>">
                    <%= index + 1 %>
                  </div>
                </div>
                
                <div class="rescue-agent-info">
                  <div class="rescue-agent-avatar">
                    <i class="fas fa-user-shield"></i>
                  </div>
                  <div class="rescue-agent-details">
                    <div class="rescue-agent-name">Agent #<%= agent_id || 'Unassigned' %></div>
                    <div class="rescue-agent-meta"><%= metrics[:total_handled] || 0 %> cases handled</div>
                  </div>
                </div>

                <div class="rescue-agent-metrics">
                  <div class="rescue-agent-score">
                    <div class="rescue-score-circle" data-score="<%= (metrics[:rescue_rate] || 0).round %>">
                      <span class="rescue-score-text"><%= (metrics[:rescue_rate] || 0).round %>%</span>
                    </div>
                  </div>
                  
                  <div class="rescue-agent-stats">
                    <div class="rescue-agent-stat rescue-stat-saved">
                      <span class="rescue-stat-icon"><i class="fas fa-shield-check"></i></span>
                      <span class="rescue-stat-text"><%= metrics[:orders_saved] || 0 %> saved</span>
                    </div>
                    <div class="rescue-agent-stat rescue-stat-lost">
                      <span class="rescue-stat-icon"><i class="fas fa-money-bill-wave"></i></span>
                      <span class="rescue-stat-text"><%= metrics[:orders_lost] || 0 %> lost</span>
                    </div>
                    <div class="rescue-agent-stat rescue-stat-revenue">
                      <span class="rescue-stat-icon"><i class="fas fa-dollar-sign"></i></span>
                      <span class="rescue-stat-text">$<%= number_with_precision(metrics[:revenue_saved] || 0, precision: 0, delimiter: ',') %></span>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="rescue-empty-state rescue-empty-agents">
            <div class="rescue-empty-icon">
              <i class="fas fa-user-friends"></i>
            </div>
            <h4>No agent performance data available</h4>
            <p>Agent rescue metrics will appear here once resolutions are completed.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Detailed Resolution History -->
  <div class="rescue-resolution-history-section">
    <div class="rescue-resolution-card">
      <div class="rescue-card-header">
        <h3 class="rescue-card-title">
          <i class="fas fa-history"></i>
          Recent Rescue Outcomes & Resolution History
        </h3>
        <div class="rescue-card-filters">
          <select id="resolution-filter" class="form-select form-select-sm">
            <option value="">All Resolutions</option>
            <option value="saved">Orders Saved</option>
            <option value="lost">Orders Lost</option>
            <option value="delay_approved">Delay Accepted</option>
            <option value="price_increase_approved">Price Increase</option>
            <option value="compatible_alternative_approved">Alternative Part</option>
            <option value="authorize_return_and_replacement">Replacement Order</option>
            <option value="issue_refund">Immediate Refund</option>
            <option value="authorize_return_and_refund">Return + Refund</option>
          </select>
        </div>
      </div>
      <div class="rescue-card-body">
        <% 
          # Get completed resolutions with detailed information
          completed_resolutions = Refund.where(resolution_stage: 'resolution_completed')
                                        .where(created_at: 30.days.ago..Time.current)
                                        .includes(:order, :processing_agent, :activities)
                                        .order(updated_at: :desc)
                                        .limit(50)
        %>
        
        <% if completed_resolutions.any? %>
          <div class="resolution-timeline">
            <% completed_resolutions.each do |refund| %>
              <div class="resolution-entry" data-resolution="<%= refund.dispatcher_decision %>" data-outcome="<%= refund.order_was_saved? ? 'saved' : 'lost' %>">
                <div class="resolution-header">
                  <div class="resolution-identity">
                    <div class="resolution-refund-info">
                      <h5 class="resolution-refund-number">
                        <%= link_to refund.refund_number, refund_path(refund), class: "resolution-link" %>
                        <span class="resolution-order">Order: <%= refund.order.order_number %></span>
                        <span class="rescue-outcome-badge rescue-outcome-<%= refund.order_was_saved? ? 'saved' : 'lost' %>">
                          <i class="fas fa-<%= refund.order_was_saved? ? 'shield-check' : 'money-bill-wave' %>"></i>
                          <%= refund.order_was_saved? ? 'SAVED' : 'LOST' %>
                        </span>
                      </h5>
                      <div class="resolution-customer">
                        <i class="fas fa-user"></i>
                        <%= refund.customer_name %> • $<%= number_with_precision(refund.refund_amount, precision: 2) %>
                      </div>
                    </div>
                    
                    <div class="resolution-timeline-info">
                      <div class="resolution-dates">
                        <div class="resolution-date-item">
                          <span class="date-label">Resolved:</span>
                          <span class="date-value"><%= refund.updated_at.strftime("%b %d, %I:%M %p") %></span>
                        </div>
                        <div class="resolution-date-item resolution-duration">
                          <span class="date-label">Duration:</span>
                          <span class="date-value">
                            <%= distance_of_time_in_words(refund.created_at, refund.updated_at) %>
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="resolution-outcome">
                    <% 
                      outcome_config = case refund.dispatcher_decision
                      when 'authorize_return_and_refund'
                        { icon: 'undo', color: 'info', label: 'Return + Refund' }
                      when 'authorize_return_and_replacement'
                        { icon: 'sync-alt', color: 'success', label: 'Replacement Order' }
                      when 'issue_refund'
                        { icon: 'money-bill-wave', color: 'danger', label: 'Immediate Refund' }
                      when 'delay_approved'
                        { icon: 'clock', color: 'success', label: 'Delay Accepted' }
                      when 'price_increase_approved'
                        { icon: 'dollar-sign', color: 'success', label: 'Price Increase' }
                      when 'compatible_alternative_approved'
                        { icon: 'exchange-alt', color: 'success', label: 'Alternative Part' }
                      when 'auto_resolved'
                        { icon: 'magic', color: 'secondary', label: 'Auto-Resolved' }
                      else
                        { icon: 'check', color: 'primary', label: 'Resolved' }
                      end
                    %>
                    <div class="outcome-badge outcome-<%= outcome_config[:color] %>">
                      <i class="fas fa-<%= outcome_config[:icon] %>"></i>
                      <span><%= outcome_config[:label] %></span>
                    </div>
                  </div>
                </div>

                <div class="resolution-details">
                  <div class="resolution-reason">
                    <strong>Issue:</strong> <%= refund.refund_reason.humanize %>
                    <% if refund.order.dispatch&.cancelled? %>
                      <span class="reason-context">(Triggered by dispatch cancellation)</span>
                    <% end %>
                  </div>

                  <!-- Resolution Actions Taken -->
                  <div class="resolution-actions-taken">
                    <% if refund.order_was_saved? %>
                      <div class="action-summary action-rescue-success">
                        <i class="fas fa-shield-check"></i>
                        <span><strong>ORDER SAVED:</strong> 
                          <% case refund.rescue_method %>
                          <% when 'delay_accepted' %>
                            Customer accepted delay, order proceeds with extended timeline
                          <% when 'price_increase_accepted' %>
                            Customer agreed to pay additional $<%= refund.additional_cost %>
                          <% when 'alternative_part_accepted' %>
                            Customer accepted alternative: <%= refund.alternative_part_name %>
                          <% when 'replacement_order' %>
                            Customer gets replacement order instead of refund
                          <% else %>
                            Order resolved without refund
                          <% end %>
                        </span>
                      </div>
                    <% else %>
                      <div class="action-summary action-rescue-failed">
                        <i class="fas fa-money-bill-wave"></i>
                        <span><strong>ORDER LOST:</strong> 
                          <% case refund.dispatcher_decision %>
                          <% when 'issue_refund' %>
                            Immediate refund of $<%= refund.refund_amount %> processed
                          <% when 'authorize_return_and_refund' %>
                            Customer returns item for $<%= refund.refund_amount %> refund
                          <% else %>
                            Refund processed
                          <% end %>
                        </span>
                      </div>
                    <% end %>
                  </div>

                  <!-- Revenue Impact -->
                  <div class="resolution-revenue-impact">
                    <div class="revenue-impact-item">
                      <span class="revenue-label">Revenue Impact:</span>
                      <span class="revenue-value revenue-<%= refund.order_was_saved? ? 'positive' : 'negative' %>">
                        <%= refund.order_was_saved? ? '+' : '-' %>$<%= number_with_precision(refund.refund_amount, precision: 2) %>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="rescue-empty-state">
            <i class="fas fa-history"></i>
            <h4>No Resolution History</h4>
            <p>Completed resolutions will appear here with rescue outcomes and revenue impact.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
// Filter resolution history
document.getElementById('resolution-filter').addEventListener('change', function() {
  const selectedFilter = this.value;
  const entries = document.querySelectorAll('.resolution-entry');
  
  entries.forEach(entry => {
    const resolution = entry.dataset.resolution;
    const outcome = entry.dataset.outcome;
    
    let shouldShow = false;
    
    if (!selectedFilter) {
      shouldShow = true;
    } else if (selectedFilter === 'saved' && outcome === 'saved') {
      shouldShow = true;
    } else if (selectedFilter === 'lost' && outcome === 'lost') {
      shouldShow = true;
    } else if (resolution === selectedFilter) {
      shouldShow = true;
    }
    
    entry.style.display = shouldShow ? 'block' : 'none';
  });
});
</script>
<% end %>