<% content_for :title, "Refund #{@refund.refund_number}" %>

<div class="container-fluid p-4">
  <!-- Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-2">
          <li class="breadcrumb-item">
            <%= link_to "Refunds", refunds_path, class: "text-decoration-none" %>
          </li>
          <li class="breadcrumb-item active"><%= @refund.refund_number %></li>
        </ol>
      </nav>
      
      <h1 class="h3 mb-1 text-gray-900">
        <i class="fas fa-undo-alt text-warning me-2"></i>
        Refund <%= @refund.refund_number %>
      </h1>
      
      <div class="d-flex flex-wrap gap-2 mb-2">
        <span class="badge bg-<%= @refund.stage_color %> fs-6">
          <%= @refund.refund_stage.humanize %>
        </span>
        <span class="badge bg-<%= @refund.reason_color %> bg-opacity-75">
          <%= @refund.refund_reason.humanize %>
        </span>
        <span class="badge bg-<%= @refund.priority_color %> bg-opacity-50">
          <i class="fas fa-flag me-1"></i><%= @refund.priority.humanize %>
        </span>
      </div>
    </div>
    
    <div class="d-flex gap-2">
      <%= link_to edit_refund_path(@refund), class: "btn btn-outline-primary" do %>
        <i class="fas fa-edit me-2"></i>Edit
      <% end %>
      
      <% if @refund.can_be_processed? %>
        <%= link_to process_refund_refund_path(@refund), method: :patch, 
                    class: "btn btn-success",
                    confirm: "Process this refund?" do %>
          <i class="fas fa-play me-2"></i>Process
        <% end %>
      <% end %>
      
      <% if @refund.can_be_cancelled? %>
        <%= link_to cancel_refund_refund_path(@refund), method: :patch, 
                    class: "btn btn-outline-danger",
                    confirm: "Cancel this refund?" do %>
          <i class="fas fa-times me-2"></i>Cancel
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="row g-4">
    <!-- Main Refund Details -->
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-info-circle text-primary me-2"></i>
            Refund Details
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <!-- Customer Information -->
            <div class="col-md-6">
              <div class="border rounded p-3 bg-light">
                <h6 class="fw-bold mb-2">
                  <i class="fas fa-user text-primary me-2"></i>Customer
                </h6>
                <div class="mb-2">
                  <strong><%= @refund.customer_name %></strong>
                </div>
                <% if @refund.customer_email.present? %>
                  <div class="text-muted">
                    <i class="fas fa-envelope me-1"></i>
                    <%= @refund.customer_email %>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- Order Information -->
            <div class="col-md-6">
              <div class="border rounded p-3 bg-light">
                <h6 class="fw-bold mb-2">
                  <i class="fas fa-shopping-cart text-primary me-2"></i>Original Order
                </h6>
                <div class="mb-2">
                  <%= link_to @refund.order.order_number, order_path(@refund.order), 
                              class: "fw-bold text-decoration-none" %>
                </div>
                <div class="text-muted">
                  Status: <span class="badge bg-<%= @refund.order.status_color %>">
                    <%= @refund.order.order_status.humanize %>
                  </span>
                </div>
              </div>
            </div>

            <!-- Financial Details -->
            <div class="col-12">
              <div class="border rounded p-3 bg-light">
                <h6 class="fw-bold mb-3">
                  <i class="fas fa-money-bill-wave text-success me-2"></i>Financial Information
                </h6>
                <div class="row g-3">
                  <div class="col-md-3">
                    <small class="text-muted d-block">Original Charge</small>
                    <div class="h5 mb-0">$<%= number_with_precision(@refund.original_charge_amount, precision: 2) %></div>
                  </div>
                  <div class="col-md-3">
                    <small class="text-muted d-block">Refund Amount</small>
                    <div class="h5 mb-0 text-success">$<%= number_with_precision(@refund.refund_amount, precision: 2) %></div>
                  </div>
                  <div class="col-md-3">
                    <small class="text-muted d-block">Refund Percentage</small>
                    <div class="h5 mb-0"><%= @refund.refund_percentage %>%</div>
                  </div>
                  <div class="col-md-3">
                    <small class="text-muted d-block">Processing Days</small>
                    <div class="h5 mb-0 <%= @refund.is_overdue? ? 'text-danger' : 'text-primary' %>">
                      <%= @refund.days_since_request %> / <%= @refund.estimated_processing_days %>
                    </div>
                  </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="mt-3">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted">Refund Progress</small>
                    <small class="text-muted"><%= @refund.refund_percentage %>%</small>
                  </div>
                  <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: <%= @refund.refund_percentage %>%"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Payment Details -->
            <% if @refund.payment_processor.present? || @refund.transaction_id.present? %>
              <div class="col-12">
                <div class="border rounded p-3 bg-light">
                  <h6 class="fw-bold mb-3">
                    <i class="fas fa-credit-card text-info me-2"></i>Payment Information
                  </h6>
                  <div class="row g-2">
                    <% if @refund.payment_processor.present? %>
                      <div class="col-md-6">
                        <small class="text-muted d-block">Payment Processor</small>
                        <div><%= @refund.payment_processor %></div>
                      </div>
                    <% end %>
                    <% if @refund.transaction_id.present? %>
                      <div class="col-md-6">
                        <small class="text-muted d-block">Transaction ID</small>
                        <div class="font-monospace"><%= @refund.transaction_id %></div>
                      </div>
                    <% end %>
                    <% if @refund.refund_method.present? %>
                      <div class="col-md-6">
                        <small class="text-muted d-block">Refund Method</small>
                        <div><%= @refund.refund_method.humanize %></div>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>

            <!-- Return Information -->
            <% if @refund.requires_return? %>
              <div class="col-12">
                <div class="border rounded p-3 bg-warning bg-opacity-10">
                  <h6 class="fw-bold mb-3">
                    <i class="fas fa-shipping-fast text-warning me-2"></i>Return Information
                  </h6>
                  <div class="row g-2">
                    <% if @refund.return_tracking_number.present? %>
                      <div class="col-md-6">
                        <small class="text-muted d-block">Return Tracking</small>
                        <div class="font-monospace fw-bold"><%= @refund.return_tracking_number %></div>
                      </div>
                    <% end %>
                    <% if @refund.return_deadline.present? %>
                      <div class="col-md-6">
                        <small class="text-muted d-block">Return Deadline</small>
                        <div><%= @refund.return_deadline.strftime("%B %d, %Y at %I:%M %p") %></div>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>

            <!-- Replacement Order -->
            <% if @replacement_order.present? %>
              <div class="col-12">
                <div class="border rounded p-3 bg-info bg-opacity-10">
                  <h6 class="fw-bold mb-3">
                    <i class="fas fa-exchange-alt text-info me-2"></i>Replacement Order
                  </h6>
                  <div>
                    <%= link_to @replacement_order.order_number, order_path(@replacement_order), 
                                class: "fw-bold text-decoration-none h5" %>
                    <span class="badge bg-<%= @replacement_order.status_color %> ms-2">
                      <%= @replacement_order.order_status.humanize %>
                    </span>
                  </div>
                </div>
              </div>
            <% elsif @refund.refund_reason == 'return_request' %>
              <div class="col-12">
                <div class="border rounded p-3 bg-light">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="fw-bold mb-1">
                        <i class="fas fa-exchange-alt text-info me-2"></i>Replacement Order
                      </h6>
                      <p class="text-muted mb-0">No replacement order created yet</p>
                    </div>
                    <%= link_to create_replacement_refund_path(@refund), method: :post, 
                                class: "btn btn-outline-info" do %>
                      <i class="fas fa-plus me-2"></i>Create Replacement
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>

            <!-- Notes -->
            <% if @refund.notes.present? || @refund.internal_notes.present? %>
              <div class="col-12">
                <div class="border rounded p-3 bg-light">
                  <h6 class="fw-bold mb-3">
                    <i class="fas fa-sticky-note text-secondary me-2"></i>Notes
                  </h6>
                  <% if @refund.notes.present? %>
                    <div class="mb-3">
                      <small class="text-muted d-block">Customer Notes</small>
                      <div class="mt-1"><%= simple_format(@refund.notes) %></div>
                    </div>
                  <% end %>
                  <% if @refund.internal_notes.present? %>
                    <div>
                      <small class="text-muted d-block">Internal Notes</small>
                      <div class="mt-1"><%= simple_format(@refund.internal_notes) %></div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <!-- Quick Actions -->
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="fas fa-bolt text-warning me-2"></i>Quick Actions
          </h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <% if @refund.can_be_processed? %>
              <%= link_to process_refund_refund_path(@refund), method: :patch, 
                          class: "btn btn-success",
                          confirm: "Process this refund?" do %>
                <i class="fas fa-play me-2"></i>Process Refund
              <% end %>
            <% end %>
            
            <% if @refund.refund_reason == 'return_request' && @refund.replacement_order_number.blank? %>
              <%= link_to create_replacement_refund_path(@refund), method: :post, 
                          class: "btn btn-info" do %>
                <i class="fas fa-exchange-alt me-2"></i>Create Replacement
              <% end %>
            <% end %>
            
            <%= link_to edit_refund_path(@refund), class: "btn btn-outline-primary" do %>
              <i class="fas fa-edit me-2"></i>Edit Refund
            <% end %>
            
            <% if @refund.can_be_cancelled? %>
              <%= link_to cancel_refund_refund_path(@refund), method: :patch, 
                          class: "btn btn-outline-danger",
                          confirm: "Cancel this refund?" do %>
                <i class="fas fa-times me-2"></i>Cancel Refund
              <% end %>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Processing Agent -->
      <% if @refund.processing_agent.present? %>
        <div class="card shadow-sm mb-4">
          <div class="card-header">
            <h6 class="mb-0">
              <i class="fas fa-user-tie text-primary me-2"></i>Processing Agent
            </h6>
          </div>
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" 
                   style="width: 40px; height: 40px;">
                <i class="fas fa-user"></i>
              </div>
              <div>
                <div class="fw-bold"><%= @refund.processing_agent.email %></div>
                <small class="text-muted">Processing Agent</small>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Timeline -->
      <div class="card shadow-sm">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="fas fa-history text-info me-2"></i>Activity Timeline
          </h6>
        </div>
        <div class="card-body">
          <% if @activities.any? %>
            <div class="timeline">
              <% @activities.each do |activity| %>
                <div class="timeline-item mb-3">
                  <div class="d-flex">
                    <div class="rounded-circle bg-info text-white d-flex align-items-center justify-content-center me-3" 
                         style="width: 32px; height: 32px; min-width: 32px;">
                      <i class="fas fa-circle" style="font-size: 8px;"></i>
                    </div>
                    <div class="flex-grow-1">
                      <div class="fw-bold"><%= activity.action.humanize %></div>
                      <% if activity.details.present? %>
                        <div class="text-muted small"><%= activity.details %></div>
                      <% end %>
                      <div class="text-muted small">
                        <%= time_ago_in_words(activity.created_at) %> ago
                        <% if activity.user.present? %>
                          by <%= activity.user.email %>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-center text-muted py-3">
              <i class="fas fa-history mb-2" style="font-size: 2rem;"></i>
              <div>No activity yet</div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>