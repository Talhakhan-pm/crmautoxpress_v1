<div class="card border-0 shadow-sm h-100 refund-card" data-refund-id="<%= refund.id %>">
  <div class="card-header bg-white border-0 pb-0">
    <div class="d-flex justify-content-between align-items-start mb-2">
      <div>
        <h6 class="mb-1 fw-bold text-primary">
          <%= refund.refund_number %>
        </h6>
        <small class="text-muted">
          <i class="fas fa-shopping-cart me-1"></i>
          Order: <%= link_to refund.order.order_number, order_path(refund.order), class: "text-decoration-none" %>
        </small>
      </div>
      
      <div class="dropdown">
        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
          <i class="fas fa-ellipsis-v"></i>
        </button>
        <ul class="dropdown-menu">
          <li>
            <%= link_to refund_path(refund), class: "dropdown-item" do %>
              <i class="fas fa-eye me-2"></i>View Details
            <% end %>
          </li>
          <li>
            <%= link_to edit_refund_path(refund), class: "dropdown-item" do %>
              <i class="fas fa-edit me-2"></i>Edit
            <% end %>
          </li>
          <% if refund.can_be_processed? %>
            <li>
              <%= link_to process_refund_refund_path(refund), method: :patch, class: "dropdown-item" do %>
                <i class="fas fa-play me-2"></i>Process
              <% end %>
            </li>
          <% end %>
          <% if refund.can_be_cancelled? %>
            <li>
              <%= link_to cancel_refund_refund_path(refund), method: :patch, class: "dropdown-item text-danger" do %>
                <i class="fas fa-times me-2"></i>Cancel
              <% end %>
            </li>
          <% end %>
          
          <!-- Resolution Options for Pending Resolution -->
          <% if refund.refund_stage == 'pending_resolution' %>
            <li><hr class="dropdown-divider"></li>
            <li class="dropdown-header">Resolution Options</li>
            <li>
              <%= link_to retry_dispatch_dispatch_path(refund.order.dispatch), method: :patch, class: "dropdown-item text-primary" do %>
                <i class="fas fa-redo me-2"></i>Retry Dispatch
              <% end %>
            </li>
            <li>
              <%= link_to create_replacement_order_dispatch_path(refund.order.dispatch), method: :post, class: "dropdown-item text-info" do %>
                <i class="fas fa-exchange-alt me-2"></i>Create Replacement
              <% end %>
            </li>
            <li>
              <%= link_to process_full_refund_dispatch_path(refund.order.dispatch), method: :patch, class: "dropdown-item text-success" do %>
                <i class="fas fa-money-bill-wave me-2"></i>Process Refund
              <% end %>
            </li>
          <% elsif refund.refund_reason == 'return_request' && refund.replacement_order_number.blank? %>
            <li>
              <%= link_to create_replacement_refund_path(refund), method: :post, class: "dropdown-item" do %>
                <i class="fas fa-exchange-alt me-2"></i>Create Replacement
              <% end %>
            </li>
          <% end %>
        </ul>
      </div>
    </div>
    
    <!-- Status Badges -->
    <div class="d-flex flex-wrap gap-1 mb-2">
      <span class="badge bg-<%= refund.stage_color %> fs-6 <%= 'pulsing-badge' if refund.refund_stage == 'pending_resolution' %>">
        <%= refund.refund_stage.humanize %>
        <% if refund.refund_stage == 'pending_resolution' %>
          <i class="fas fa-exclamation-triangle ms-1"></i>
        <% end %>
      </span>
      <span class="badge bg-<%= refund.reason_color %> bg-opacity-75">
        <%= refund.refund_reason.humanize %>
      </span>
      <span class="badge bg-<%= refund.priority_color %> bg-opacity-50">
        <i class="fas fa-flag me-1"></i><%= refund.priority.humanize %>
      </span>
    </div>
    
    <!-- Resolution Alert -->
    <% if refund.refund_stage == 'pending_resolution' %>
      <div class="alert alert-warning alert-sm mb-2" style="padding: 8px 12px; font-size: 0.85rem;">
        <i class="fas fa-clock me-1"></i>
        <strong>Action Required:</strong> Choose resolution option
      </div>
    <% end %>
  </div>
  
  <div class="card-body">
    <!-- Customer Info -->
    <div class="mb-3">
      <h6 class="fw-bold text-dark mb-1">
        <i class="fas fa-user me-1 text-primary"></i>
        <%= refund.customer_name %>
      </h6>
      <% if refund.customer_email.present? %>
        <small class="text-muted d-block">
          <i class="fas fa-envelope me-1"></i>
          <%= refund.customer_email %>
        </small>
      <% end %>
    </div>
    
    <!-- Refund Amount -->
    <div class="row g-2 mb-3">
      <div class="col-6">
        <small class="text-muted d-block">Original Amount</small>
        <div class="fw-bold">$<%= number_with_precision(refund.original_charge_amount, precision: 2) %></div>
      </div>
      <div class="col-6">
        <small class="text-muted d-block">Refund Amount</small>
        <div class="fw-bold text-success">$<%= number_with_precision(refund.refund_amount, precision: 2) %></div>
      </div>
    </div>
    
    <!-- Refund Percentage -->
    <div class="mb-3">
      <small class="text-muted d-block">Refund Percentage</small>
      <div class="progress" style="height: 6px;">
        <div class="progress-bar bg-success" style="width: <%= refund.refund_percentage %>%"></div>
      </div>
      <small class="text-muted"><%= refund.refund_percentage %>% refund</small>
    </div>
    
    <!-- Timeline Info -->
    <div class="row g-2 mb-3 text-center">
      <div class="col-6">
        <small class="text-muted d-block">Days Since Request</small>
        <div class="fw-bold <%= refund.is_overdue? ? 'text-danger' : 'text-primary' %>">
          <%= refund.days_since_request %>
        </div>
      </div>
      <div class="col-6">
        <small class="text-muted d-block">Est. Processing</small>
        <div class="fw-bold">
          <%= refund.estimated_processing_days %> days
        </div>
      </div>
    </div>
    
    <!-- Processing Agent -->
    <% if refund.processing_agent.present? %>
      <div class="mb-3">
        <small class="text-muted d-block">Processing Agent</small>
        <div class="d-flex align-items-center">
          <i class="fas fa-user-tie me-2 text-secondary"></i>
          <span class="small"><%= refund.processing_agent.email %></span>
        </div>
      </div>
    <% end %>
    
    <!-- Notes Preview -->
    <% if refund.notes.present? %>
      <div class="mb-3">
        <small class="text-muted d-block">Notes</small>
        <div class="small text-dark">
          <%= truncate(refund.notes, length: 100) %>
        </div>
      </div>
    <% end %>
    
    <!-- Replacement Order Link -->
    <% if refund.replacement_order_number.present? %>
      <div class="mb-3">
        <div class="d-flex align-items-center gap-2 p-2 bg-light rounded">
          <i class="fas fa-exchange-alt text-info"></i>
          <div>
            <small class="text-muted d-block">Replacement Order</small>
            <%= link_to refund.replacement_order_number, order_path(refund.replacement_order), 
                        class: "small fw-bold text-decoration-none" %>
          </div>
        </div>
      </div>
    <% end %>
    
    <!-- Return Tracking -->
    <% if refund.return_tracking_number.present? %>
      <div class="mb-3">
        <small class="text-muted d-block">Return Tracking</small>
        <div class="small font-monospace fw-bold">
          <%= refund.return_tracking_number %>
        </div>
      </div>
    <% end %>
    
    <!-- Resolution Actions -->
    <%= render 'refunds/resolution_actions', refund: refund %>
  </div>
  
  <div class="card-footer bg-light border-0">
    <div class="d-flex justify-content-between align-items-center">
      <small class="text-muted">
        <i class="fas fa-clock me-1"></i>
        <%= time_ago_in_words(refund.created_at) %> ago
      </small>
      
      <div class="d-flex gap-2">
        <%= link_to refund_path(refund), class: "btn btn-sm btn-outline-primary" do %>
          <i class="fas fa-eye"></i>
        <% end %>
        
        <% if refund.can_be_processed? %>
          <%= link_to process_refund_refund_path(refund), method: :patch, 
                      class: "btn btn-sm btn-success",
                      confirm: "Process this refund?" do %>
            <i class="fas fa-play"></i>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>