<div class="refunds-modern-card" data-refund-id="<%= refund.id %>">
  <!-- Card Header -->
  <div class="refunds-card-header">
    <div class="refunds-card-header-left">
      <div class="refunds-card-id">
        <%= refund.refund_number %>
      </div>
      <div class="refunds-card-order">
        <%= link_to refund.order.order_number, order_path(refund.order), class: "refunds-order-link" %>
      </div>
    </div>
    
    <div class="refunds-card-actions">
      <div class="refunds-actions-dropdown">
        <button class="refunds-action-btn" type="button" data-bs-toggle="dropdown">
          <i class="fas fa-ellipsis-h"></i>
        </button>
        <ul class="dropdown-menu refunds-dropdown-menu">
          <li>
            <%= link_to refund_path(refund), class: "refunds-dropdown-item" do %>
              <i class="fas fa-eye"></i>
              <span>View Details</span>
            <% end %>
          </li>
          <li>
            <%= link_to edit_refund_path(refund), class: "refunds-dropdown-item" do %>
              <i class="fas fa-edit"></i>
              <span>Edit</span>
            <% end %>
          </li>
          <% if refund.can_be_processed? %>
            <li>
              <%= link_to process_refund_refund_path(refund), method: :patch, class: "refunds-dropdown-item refunds-dropdown-process" do %>
                <i class="fas fa-play"></i>
                <span>Process</span>
              <% end %>
            </li>
          <% end %>
          <% if refund.can_be_cancelled? %>
            <li>
              <%= link_to cancel_refund_refund_path(refund), method: :patch, class: "refunds-dropdown-item refunds-dropdown-danger" do %>
                <i class="fas fa-times"></i>
                <span>Cancel</span>
              <% end %>
            </li>
          <% end %>
        </ul>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="refunds-status-bar">
    <div class="refunds-status-badge refunds-status-<%= refund.refund_stage %>">
      <%= refund.refund_stage.humanize %>
    </div>
    
    <div class="refunds-sla-indicator refunds-sla-<%= refund.sla_status %>">
      <i class="fas fa-clock"></i>
      <span><%= refund.sla_status.humanize %></span>
      <% unless refund.completed_stage? %>
        <small>(<%= refund.sla_remaining_hours %>h)</small>
      <% end %>
    </div>
  </div>

  <!-- Card Body -->
  <div class="refunds-card-body">
    <!-- Customer Section -->
    <div class="refunds-customer-section">
      <div class="refunds-customer-avatar">
        <i class="fas fa-user"></i>
      </div>
      <div class="refunds-customer-info">
        <div class="refunds-customer-name"><%= refund.customer_name %></div>
        <% if refund.customer_email.present? %>
          <div class="refunds-customer-email"><%= refund.customer_email %></div>
        <% end %>
      </div>
    </div>

    <!-- Amount Section -->
    <div class="refunds-amount-section">
      <div class="refunds-amount-row">
        <div class="refunds-amount-item">
          <span class="refunds-amount-label">Original</span>
          <span class="refunds-amount-value">$<%= number_with_precision(refund.original_charge_amount, precision: 2) %></span>
        </div>
        <div class="refunds-amount-arrow">
          <i class="fas fa-arrow-right"></i>
        </div>
        <div class="refunds-amount-item">
          <span class="refunds-amount-label">Refund</span>
          <span class="refunds-amount-value refunds-amount-refund">$<%= number_with_precision(refund.refund_amount, precision: 2) %></span>
        </div>
      </div>
      
      <div class="refunds-percentage-bar">
        <div class="refunds-percentage-fill" style="width: <%= refund.refund_percentage %>%"></div>
        <span class="refunds-percentage-text"><%= refund.refund_percentage %>%</span>
      </div>
    </div>

    <!-- Details Grid -->
    <div class="refunds-details-grid">
      <div class="refunds-detail-item">
        <div class="refunds-detail-label">Days elapsed</div>
        <div class="refunds-detail-value <%= 'refunds-overdue' if refund.is_overdue? %>">
          <%= refund.days_since_request %>
        </div>
      </div>
      
      <div class="refunds-detail-item">
        <div class="refunds-detail-label">Priority</div>
        <div class="refunds-detail-value">
          <span class="refunds-priority-badge refunds-priority-<%= refund.priority %>">
            <%= refund.priority.humanize %>
          </span>
        </div>
      </div>
      
      <div class="refunds-detail-item">
        <div class="refunds-detail-label">Reason</div>
        <div class="refunds-detail-value">
          <span class="refunds-reason-badge">
            <%= refund.refund_reason.humanize %>
          </span>
        </div>
      </div>
      
      <% if refund.processing_agent.present? %>
        <div class="refunds-detail-item">
          <div class="refunds-detail-label">Agent</div>
          <div class="refunds-detail-value">
            <div class="refunds-agent-info">
              <i class="fas fa-user-tie"></i>
              <span><%= refund.processing_agent.email.split('@').first %></span>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Replacement Order (if exists) -->
    <% if refund.has_replacement_order? || refund.replacement_order_number.present? %>
      <div class="refunds-replacement-section">
        <div class="refunds-replacement-header">
          <i class="fas fa-exchange-alt"></i>
          <span>Replacement Order</span>
        </div>
        <% if refund.has_replacement_order? %>
          <div class="refunds-replacement-content">
            <%= link_to refund.replacement_order_number, order_path(refund.replacement_order), 
                        class: "refunds-replacement-link" %>
            <span class="refunds-replacement-status refunds-status-<%= refund.replacement_order.order_status %>">
              <%= refund.replacement_order_status %>
            </span>
          </div>
        <% else %>
          <div class="refunds-replacement-content refunds-replacement-error">
            <span class="refunds-replacement-number"><%= refund.replacement_order_number %></span>
            <span class="refunds-replacement-error-text">Order not found</span>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Notes Preview -->
    <% if refund.notes.present? %>
      <div class="refunds-notes-section">
        <div class="refunds-notes-content">
          <%= truncate(refund.notes, length: 80) %>
        </div>
      </div>
    <% end %>

    <!-- Resolution Actions for Pending Resolution -->
    <% if refund.refund_stage == 'pending_resolution' %>
      <div class="refunds-resolution-section">
        <div class="refunds-resolution-header">
          <i class="fas fa-exclamation-triangle"></i>
          <span>Choose Resolution Action</span>
        </div>
        
        <div class="refunds-resolution-actions">
          <%= button_to retry_dispatch_dispatch_path(refund.order.dispatch), 
                        method: :patch, 
                        class: "refunds-resolution-btn refunds-resolution-retry",
                        confirm: "Retry dispatch with a different supplier?",
                        data: { turbo_frame: "_top" } do %>
            <i class="fas fa-redo"></i>
            <span class="refunds-btn-label">Retry</span>
            <span class="refunds-btn-subtitle">Different supplier</span>
          <% end %>
          
          <%= button_to create_replacement_order_dispatch_path(refund.order.dispatch), 
                        method: :post, 
                        class: "refunds-resolution-btn refunds-resolution-replace",
                        confirm: "Create a replacement order?",
                        data: { turbo_frame: "_top" } do %>
            <i class="fas fa-exchange-alt"></i>
            <span class="refunds-btn-label">Replace</span>
            <span class="refunds-btn-subtitle">New order</span>
          <% end %>
          
          <%= button_to process_full_refund_dispatch_path(refund.order.dispatch), 
                        method: :patch, 
                        class: "refunds-resolution-btn refunds-resolution-refund",
                        confirm: "Process full refund and cancel order?",
                        data: { turbo_frame: "_top" } do %>
            <i class="fas fa-money-bill-wave"></i>
            <span class="refunds-btn-label">Refund</span>
            <span class="refunds-btn-subtitle">Cancel order</span>
          <% end %>
        </div>
        
        <div class="refunds-resolution-timer">
          <i class="fas fa-clock"></i>
          <span><%= pluralize(refund.days_since_request, 'day') %> since dispatch cancelled</span>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Card Footer -->
  <div class="refunds-card-footer">
    <div class="refunds-footer-left">
      <span class="refunds-time-ago">
        <%= time_ago_in_words(refund.created_at) %> ago
      </span>
    </div>
    
    <div class="refunds-footer-right">
      <%= link_to refund_path(refund), class: "refunds-footer-btn refunds-footer-view" do %>
        <i class="fas fa-eye"></i>
      <% end %>
      
      <% if refund.can_be_processed? %>
        <%= link_to process_refund_refund_path(refund), method: :patch, 
                    class: "refunds-footer-btn refunds-footer-process",
                    confirm: "Process this refund?" do %>
          <i class="fas fa-play"></i>
        <% end %>
      <% end %>
    </div>
  </div>
</div>