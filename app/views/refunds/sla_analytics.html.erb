<%= turbo_frame_tag "main_content", data: { turbo_action: "advance" } do %>
<% content_for :title, "SLA Analytics & Performance Metrics" %>

<div class="sla-analytics-container">
  <!-- Hero Section -->
  <div class="sla-hero-section">
    <div class="sla-hero-content">
      <div class="sla-hero-left">
        <div class="sla-hero-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="sla-hero-text">
          <h1 class="sla-hero-title">SLA Analytics</h1>
          <p class="sla-hero-subtitle">Performance insights & service level monitoring</p>
        </div>
      </div>
      
      <div class="sla-hero-actions">
        <%= link_to refunds_path, class: "sla-btn sla-btn-ghost" do %>
          <i class="fas fa-arrow-left"></i>
          <span>Back to Refunds</span>
        <% end %>
        <%= link_to dashboard_path, class: "sla-btn sla-btn-outline" do %>
          <i class="fas fa-home"></i>
          <span>Dashboard</span>
        <% end %>
      </div>
    </div>
  </div>

  <!-- SLA Status Overview Cards -->
  <div class="sla-overview-section">
    <div class="sla-overview-grid">
      <div class="sla-metric-card sla-metric-success">
        <div class="sla-metric-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="sla-metric-content">
          <div class="sla-metric-number"><%= @sla_metrics[:on_track] || 0 %></div>
          <div class="sla-metric-label">On Track</div>
          <div class="sla-metric-subtitle">Meeting SLA targets</div>
        </div>
        <div class="sla-metric-trend sla-trend-positive">
          <i class="fas fa-arrow-up"></i>
        </div>
      </div>

      <div class="sla-metric-card sla-metric-warning">
        <div class="sla-metric-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="sla-metric-content">
          <div class="sla-metric-number"><%= @sla_metrics[:at_risk] || 0 %></div>
          <div class="sla-metric-label">At Risk</div>
          <div class="sla-metric-subtitle">Approaching deadline</div>
        </div>
        <div class="sla-metric-trend sla-trend-warning">
          <i class="fas fa-exclamation"></i>
        </div>
      </div>

      <div class="sla-metric-card sla-metric-danger">
        <div class="sla-metric-icon">
          <i class="fas fa-times-circle"></i>
        </div>
        <div class="sla-metric-content">
          <div class="sla-metric-number"><%= @sla_metrics[:breached] || 0 %></div>
          <div class="sla-metric-label">Breached</div>
          <div class="sla-metric-subtitle">Exceeded target time</div>
        </div>
        <div class="sla-metric-trend sla-trend-danger">
          <i class="fas fa-arrow-down"></i>
        </div>
      </div>

      <div class="sla-metric-card sla-metric-primary">
        <div class="sla-metric-icon">
          <i class="fas fa-trophy"></i>
        </div>
        <div class="sla-metric-content">
          <div class="sla-metric-number"><%= @sla_metrics[:completed] || 0 %></div>
          <div class="sla-metric-label">Completed</div>
          <div class="sla-metric-subtitle">Successfully resolved</div>
        </div>
        <div class="sla-metric-trend sla-trend-positive">
          <i class="fas fa-check"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Dashboard -->
  <div class="sla-dashboard-section">
    <div class="sla-dashboard-grid">
      <!-- Performance Score Card -->
      <div class="sla-dashboard-card sla-performance-card">
        <div class="sla-card-header">
          <h3 class="sla-card-title">
            <i class="fas fa-speedometer-alt"></i>
            Performance Overview
          </h3>
        </div>
        <div class="sla-card-body">
          <div class="sla-performance-metrics">
            <div class="sla-performance-item">
              <div class="sla-performance-circle" data-percentage="<%= (@sla_metrics[:avg_performance_score] || 0).round %>">
                <div class="sla-circle-content">
                  <span class="sla-circle-number"><%= (@sla_metrics[:avg_performance_score] || 0).round %>%</span>
                  <span class="sla-circle-label">Avg Score</span>
                </div>
              </div>
            </div>
            
            <div class="sla-performance-stats">
              <div class="sla-stat-row">
                <div class="sla-stat-item">
                  <div class="sla-stat-icon sla-stat-compliance">
                    <i class="fas fa-shield-alt"></i>
                  </div>
                  <div class="sla-stat-content">
                    <div class="sla-stat-value"><%= number_with_precision(@sla_metrics[:sla_compliance_rate] || 0, precision: 1) %>%</div>
                    <div class="sla-stat-label">SLA Compliance</div>
                  </div>
                </div>
              </div>
              
              <div class="sla-stat-row">
                <div class="sla-stat-item">
                  <div class="sla-stat-icon sla-stat-time">
                    <i class="fas fa-clock"></i>
                  </div>
                  <div class="sla-stat-content">
                    <div class="sla-stat-value"><%= number_with_precision(@sla_metrics[:avg_resolution_time] || 0, precision: 1) %></div>
                    <div class="sla-stat-label">Avg Resolution Days</div>
                  </div>
                </div>
              </div>
              
              <div class="sla-stat-row">
                <div class="sla-stat-item">
                  <div class="sla-stat-icon sla-stat-escalation">
                    <i class="fas fa-bolt"></i>
                  </div>
                  <div class="sla-stat-content">
                    <div class="sla-stat-value"><%= @sla_metrics[:total_escalations] || 0 %></div>
                    <div class="sla-stat-label">Total Escalations</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Stage Performance Card -->
      <div class="sla-dashboard-card sla-stages-card">
        <div class="sla-card-header">
          <h3 class="sla-card-title">
            <i class="fas fa-layer-group"></i>
            Stage Performance
          </h3>
        </div>
        <div class="sla-card-body">
          <% if (@stage_performance || {}).any? %>
            <div class="sla-stages-list">
              <% (@stage_performance || {}).each do |stage, metrics| %>
                <div class="sla-stage-item">
                  <div class="sla-stage-header">
                    <div class="sla-stage-info">
                      <div class="sla-stage-name"><%= stage.humanize %></div>
                      <div class="sla-stage-count"><%= metrics[:count] || 0 %> refunds</div>
                    </div>
                    <div class="sla-stage-score">
                      <span class="sla-score-badge sla-score-<%= (metrics[:avg_score] || 0) >= 80 ? 'excellent' : (metrics[:avg_score] || 0) >= 60 ? 'good' : 'poor' %>">
                        <%= (metrics[:avg_score] || 0).round %>%
                      </span>
                    </div>
                  </div>
                  <div class="sla-stage-progress">
                    <div class="sla-progress-bar">
                      <div class="sla-progress-fill" style="width: <%= (metrics[:avg_score] || 0) %>%"></div>
                    </div>
                    <div class="sla-stage-time"><%= number_with_precision(metrics[:avg_days] || 0, precision: 1) %> days avg</div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="sla-empty-state">
              <i class="fas fa-chart-bar"></i>
              <p>No stage data available yet</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Agent Performance Table -->
  <div class="sla-agents-section">
    <div class="sla-agents-card">
      <div class="sla-card-header">
        <h3 class="sla-card-title">
          <i class="fas fa-users"></i>
          Agent Performance Leaderboard
        </h3>
      </div>
      <div class="sla-card-body">
        <% if (@agent_performance || {}).any? %>
          <div class="sla-agents-grid">
            <% (@agent_performance || {}).each_with_index do |(agent_id, metrics), index| %>
              <div class="sla-agent-card">
                <div class="sla-agent-rank">
                  <div class="sla-rank-number sla-rank-<%= index < 3 ? ['gold', 'silver', 'bronze'][index] : 'default' %>">
                    <%= index + 1 %>
                  </div>
                </div>
                
                <div class="sla-agent-info">
                  <div class="sla-agent-avatar">
                    <i class="fas fa-user"></i>
                  </div>
                  <div class="sla-agent-details">
                    <div class="sla-agent-name">Agent #<%= agent_id || 'Unassigned' %></div>
                    <div class="sla-agent-meta"><%= metrics[:total_refunds] || 0 %> refunds handled</div>
                  </div>
                </div>

                <div class="sla-agent-metrics">
                  <div class="sla-agent-score">
                    <div class="sla-score-circle" data-score="<%= (metrics[:avg_performance_score] || 0).round %>">
                      <span class="sla-score-text"><%= (metrics[:avg_performance_score] || 0).round %>%</span>
                    </div>
                  </div>
                  
                  <div class="sla-agent-stats">
                    <div class="sla-agent-stat">
                      <span class="sla-stat-icon"><i class="fas fa-shield-check"></i></span>
                      <span class="sla-stat-text"><%= number_with_precision(metrics[:sla_compliance_rate] || 0, precision: 1) %>%</span>
                    </div>
                    <div class="sla-agent-stat">
                      <span class="sla-stat-icon"><i class="fas fa-clock"></i></span>
                      <span class="sla-stat-text"><%= number_with_precision(metrics[:avg_resolution_time] || 0, precision: 1) %>d</span>
                    </div>
                    <% if (metrics[:total_escalations] || 0) > 0 %>
                      <div class="sla-agent-stat sla-stat-warning">
                        <span class="sla-stat-icon"><i class="fas fa-exclamation-triangle"></i></span>
                        <span class="sla-stat-text"><%= metrics[:total_escalations] %></span>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="sla-empty-state sla-empty-agents">
            <div class="sla-empty-icon">
              <i class="fas fa-user-friends"></i>
            </div>
            <h4>No agent data available</h4>
            <p>Agent performance metrics will appear here once refunds are processed.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
<% end %>